#!/bin/bash

set -e

# Цвета
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Проверка root
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}Этот скрипт должен запускаться от root.${NC}" 
   exit 1
fi

# Функция обновления системы и установки net-tools
update_system() {
    echo -e "${GREEN}Обновление системы...${NC}"
    apt update && apt upgrade -y
    apt install -y net-tools curl wget gnupg
}

# Функция установки Xray
install_xray() {
    echo -e "${GREEN}Установка Xray...${NC}"
    bash -c "$(curl -L https://github.com/XTLS/Xray-core/releases/latest/download/install.sh)" @ install
}

# Функция обновления Xray
update_xray() {
    echo -e "${GREEN}Обновление Xray...${NC}"
    bash -c "$(curl -L https://github.com/XTLS/Xray-core/releases/latest/download/install.sh)" @ install
}

# Функция генерации конфигурации с DoH от CZ.NIC
generate_config() {
    local domain="$1"
    local uuid="$2"
    local reality_port="$3"

    echo -e "${GREEN}Генерация конфигурации Xray с DoH от CZ.NIC...${NC}"

    cat > /usr/local/etc/xray/config.json <<EOF
{
  "log": {
    "loglevel": "warning"
  },
  "dns": {
    "servers": [
      {
        "address": "https://doh.nic.cz/dns-query",
        "domains": ["geosite:category-ads-all"]
      },
      "https://doh.nic.cz/dns-query"
    ],
    "tag": "doh-cznic"
  },
  "inbounds": [
    {
      "port": $reality_port,
      "protocol": "vless",
      "settings": {
        "clients": [
          {
            "id": "$uuid"
          }
        ],
        "decryption": "none"
      },
      "streamSettings": {
        "network": "tcp",
        "security": "reality",
        "realitySettings": {
          "show": false,
          "dest": "$domain:443",
          "xver": 0,
          "serverNames": ["$domain"],
          "privateKey": "YOUR_PRIVATE_KEY_PLACEHOLDER",
          "shortIds": ["YOUR_SHORT_ID_PLACEHOLDER"]
        }
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "freedom",
      "settings": {},
      "tag": "direct",
      "streamSettings": {
        "sockopt": {
          "tcpKeepAliveIdle": 100,
          "tcpNoDelay": true
        }
      },
      "dnsSettings": {
        "server": "https://doh.nic.cz/dns-query",
        "clientIp": "YOUR_VPS_PUBLIC_IP_PLACEHOLDER"
      }
    },
    {
      "protocol": "dns",
      "tag": "dns-out"
    }
  ],
  "routing": {
    "domainStrategy": "IPIfNonMatch",
    "rules": [
      {
        "type": "field",
        "inboundTag": ["api"],
        "outboundTag": "api"
      },
      {
        "type": "field",
        "port": "53",
        "outboundTag": "dns-out"
      }
    ]
  }
}
EOF

    echo -e "${YELLOW}Не забудьте заменить YOUR_PRIVATE_KEY_PLACEHOLDER и YOUR_SHORT_ID_PLACEHOLDER на реальные значения!${NC}"
    echo -e "${YELLOW}Также замените YOUR_VPS_PUBLIC_IP_PLACEHOLDER на ваш публичный IP (для EDNS в DoH).${NC}"
}

# Основной интерфейс
case "$1" in
    install)
        update_system
        install_xray
        echo -e "${GREEN}Xray установлен. Теперь настройте конфигурацию вручную или через generate_config.${NC}"
        ;;
    update)
        update_xray
        systemctl restart xray
        echo -e "${GREEN}Xray обновлён и перезапущен.${NC}"
        ;;
    config)
        if [ $# -ne 4 ]; then
            echo -e "${RED}Использование: $0 config <domain> <uuid> <port>${NC}"
            exit 1
        fi
        generate_config "$2" "$3" "$4"
        systemctl restart xray
        echo -e "${GREEN}Конфигурация обновлена и Xray перезапущен.${NC}"
        ;;
    *)
        echo -e "${YELLOW}Использование:${NC}"
        echo "  $0 install      — установить Xray и зависимости"
        echo "  $0 update       — обновить Xray до последней версии"
        echo "  $0 config <domain> <uuid> <port> — сгенерировать конфиг с DoH от CZ.NIC"
        exit 1
        ;;
esac
