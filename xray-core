#!/bin/bash
set -e
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}–ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ—Ç root.${NC}"
   exit 1
fi

# === 1. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —è–¥—Ä–∞ –∏ —Å–µ—Ç–µ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–¥–æ–±–∞–≤–ª–µ–Ω–æ) ===
echo -e "${GREEN}–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π —è–¥—Ä–∞ –∏ —Å–µ—Ç–∏...${NC}"
cat > /etc/sysctl.d/99-xray-tuning.conf <<EOF
# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è TCP –¥–ª—è –≤—ã—Å–æ–∫–æ–π –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
net.core.rmem_max=26214400
net.core.wmem_max=26214400
net.core.netdev_max_backlog=300000
net.ipv4.tcp_rmem=4096 87380 26214400
net.ipv4.tcp_wmem=4096 65536 26214400
net.ipv4.tcp_congestion_control=bbr
net.ipv4.tcp_fastopen=3
net.ipv4.tcp_tw_reuse=1
net.ipv4.tcp_fin_timeout=30
net.core.somaxconn=1024
net.ipv4.ip_local_port_range=1024 65535
net.ipv4.tcp_max_syn_backlog=2048
net.ipv4.tcp_slow_start_after_idle=0
net.ipv4.tcp_keepalive_time=60
net.ipv4.tcp_keepalive_intvl=10
net.ipv4.tcp_keepalive_probes=6
# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
fs.file-max=2097152
vm.swappiness=10
vm.vfs_cache_pressure=50
EOF
sysctl -p /etc/sysctl.d/99-xray-tuning.conf >/dev/null 2>&1
echo -e "${GREEN}‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —è–¥—Ä–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã.${NC}"

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
echo -e "${GREEN}–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã...${NC}"
apt update && apt upgrade -y
apt install -y curl wget gnupg qrencode jq

# –°–æ–∑–¥–∞–Ω–∏–µ swap
create_swap_if_needed() {
    TOTAL_MEM_KB=$(grep MemTotal /proc/meminfo | awk '{print $2}')
    TOTAL_MEM_GB=$((TOTAL_MEM_KB / 1024 / 1024))
    if [ "$TOTAL_MEM_GB" -le 1 ]; then
        if ! swapon --show | grep -q '/swapfile'; then
            echo -e "${GREEN}–°–æ–∑–¥–∞–Ω–∏–µ swap-—Ñ–∞–π–ª–∞ 2 –ì–ë...${NC}"
            fallocate -l 2G /swapfile || dd if=/dev/zero of=/swapfile bs=1M count=2048
            chmod 600 /swapfile
            mkswap /swapfile
            swapon /swapfile
            echo '/swapfile none swap sw 0 0' >> /etc/fstab
            echo 'vm.swappiness=10' >> /etc/sysctl.conf
            echo 'vm.vfs_cache_pressure=50' >> /etc/sysctl.conf
            sysctl -p >/dev/null 2>&1
            echo -e "${GREEN}Swap —Å–æ–∑–¥–∞–Ω.${NC}"
        fi
    fi
}
create_swap_if_needed

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ufw (—Ç–æ–ª—å–∫–æ 443)
echo -e "${GREEN}–ù–∞—Å—Ç—Ä–æ–π–∫–∞ ufw...${NC}"
apt install -y ufw
ufw allow 443/tcp
ufw --force enable

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ –ø–æ—Ä—Ç–∞ 443
if ss -tuln | grep -q ':443 '; then
    echo -e "${RED}–ü–æ—Ä—Ç 443 –∑–∞–Ω—è—Ç! –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –¥—Ä—É–≥–∏–µ —Å–µ—Ä–≤–∏—Å—ã (nginx, apache, sing-box).${NC}"
    exit 1
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Xray-core...
echo -e "${GREEN}–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Xray-core...${NC}"
bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install --no-update-service
if ! command -v xray &> /dev/null; then
    echo -e "${RED}–û—à–∏–±–∫–∞: xray –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.${NC}"
    exit 1
fi

# –û—Å—Ç–∞–Ω–æ–≤–∏–º —Å–ª—É–∂–±—É, –µ—Å–ª–∏ –æ–Ω–∞ –∑–∞–ø—É—â–µ–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–æ–º
systemctl stop xray 2>/dev/null || true
systemctl disable xray 2>/dev/null || true

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
IP=$(curl -4 -s --max-time 3 icanhazip.com)
if [[ -z "$IP" ]]; then
    echo -e "${RED}–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å IPv4.${NC}"
    exit 1
fi
UUID=$(xray uuid)
KEYPAIR=$(xray x25519)
REALITY_PRIV_KEY=$(echo "$KEYPAIR" | awk '/^PrivateKey:/ {print $2}')
REALITY_PUB_KEY=$(echo "$KEYPAIR" | awk '/^Password:/ {print $2}')
SHORT_ID=$(openssl rand -hex 4)
mkdir -p /usr/local/etc/xray

# === –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –î–û –∑–∞–ø—É—Å–∫–∞ —Å–ª—É–∂–±—ã ===
cat > /usr/local/etc/xray/.keys <<EOF
uuid: $UUID
Private key: $REALITY_PRIV_KEY
Password: $REALITY_PUB_KEY
shortsid: $SHORT_ID
EOF

cat > /usr/local/etc/xray/config.json <<EOF
{
  "log": {"loglevel": "warning"},
  "dns": {
    "servers": ["https://1.1.1.1/dns-query"],
    "tag": "doh-cloudflare"
  },
  "inbounds": [{
    "port": 443,
    "listen": "0.0.0.0",
    "protocol": "vless",
    "settings": {
      "clients": [{"id": "$UUID", "email": "main", "flow": "xtls-rprx-vision"}],
      "decryption": "none"
    },
    "streamSettings": {
      "network": "tcp",
      "security": "reality",
      "realitySettings": {
        "dest": "www.cloudflare.com:443",
        "xver": 0,
        "serverNames": ["www.cloudflare.com"],
        "privateKey": "$REALITY_PRIV_KEY",
        "shortIds": ["$SHORT_ID"]
      }
    }
  }],
  "outbounds": [
    {
      "protocol": "freedom",
      "settings": {},
      "tag": "direct",
      "streamSettings": {
        "sockopt": {"tcpKeepAliveIdle": 100, "tcpNoDelay": true}
      },
      "dnsSettings": {"server": "https://1.1.1.1/dns-query"}
    },
    {"protocol": "dns", "tag": "dns-out"}
  ],
  "routing": {
    "domainStrategy": "IPIfNonMatch",
    "rules": [{"type": "field", "port": "53", "outboundTag": "dns-out"}]
  }
}
EOF

echo "main:$UUID:$SHORT_ID" > /usr/local/etc/xray/.users

# === –ó–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã (–∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π unit) ===
systemctl daemon-reload
systemctl enable --now xray
sleep 3
if ! ss -tuln | grep -q ':443 '; then
    echo -e "${RED}‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: Xray –Ω–µ —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç 443.${NC}"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∂—É—Ä–Ω–∞–ª —Å–ª—É–∂–±—ã:"
    journalctl -u xray -n 20 --no-pager
    exit 1
else
    echo -e "${GREEN}‚úÖ Xray —É—Å–ø–µ—à–Ω–æ —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç 443.${NC}"
fi

# === 2. –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô adduser (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ jq) ===
cat > /usr/local/bin/adduser <<'EOF'
#!/bin/bash
set -e
CONF_DIR="/usr/local/etc/xray"
USERS="$CONF_DIR/.users"
CONFIG="$CONF_DIR/config.json"

# –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
read -p "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, _ –∏ -): " name
if [[ ! "$name" =~ ^[a-zA-Z0-9_\-]+$ ]]; then
    echo -e "\033[0;31m‚ùå –ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, _ –∏ -\033[0m"
    exit 1
fi

if [[ -z "$name" ]]; then
    echo -e "\033[0;31m‚ùå –ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.\033[0m"
    exit 1
fi

if grep -q "^$name:" "$USERS" 2>/dev/null; then
    echo -e "\033[0;31m‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '$name' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.\033[0m"
    exit 1
fi

# –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
cp "$CONFIG" "$CONFIG.bak_$(date +%Y%m%d_%H%M%S)"

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
uuid=$(xray uuid)
shortid=$(openssl rand -hex 4)
echo "$name:$uuid:$shortid" >> "$USERS"

# –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
temp_file=$(mktemp)
jq -r '.inbounds[0].settings.clients[] | "\(.email):\(.id):\(.flow)"' "$CONFIG" > "$temp_file"
echo "$name:$uuid:xtls-rprx-vision" >> "$temp_file"

# –°–æ–∑–¥–∞–Ω–∏–µ JSON –º–∞—Å—Å–∏–≤–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤
clients_json=$(awk -F: 'BEGIN {print "["} 
    NR==1 {printf "  {\"id\": \"%s\", \"email\": \"%s\", \"flow\": \"%s\"}", $2, $1, $3} 
    NR>1 {printf ",\n  {\"id\": \"%s\", \"email\": \"%s\", \"flow\": \"%s\"}", $2, $1, $3} 
    END {print "\n]"}' "$temp_file")

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
jq --argjson clients "$clients_json" '.inbounds[0].settings.clients = $clients' "$CONFIG" > /tmp/config.tmp && mv /tmp/config.tmp "$CONFIG"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º
if ! xray check; then
    echo -e "\033[0;31m‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏.\033[0m"
    cp "$CONFIG.bak_$(date +%Y%m%d_%H%M%S)" "$CONFIG"
    rm -f "$temp_file"
    exit 1
fi

systemctl restart xray
rm -f "$temp_file"

# –û–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–ª—É–∂–±—ã
sleep 2
if ! ss -tuln | grep -q ':443 '; then
    echo -e "\033[0;31m‚ùå Xray –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é.\033[0m"
    cp "$CONFIG.bak_$(date +%Y%m%d_%H%M%S)" "$CONFIG"
    systemctl restart xray
    exit 1
fi

echo -e "\033[0;32m‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '$name' —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω.\033[0m"
/usr/local/bin/sharelink_by_name "$name"
EOF
chmod +x /usr/local/bin/adduser

# === 3. –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô rmuser (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ jq) ===
cat > /usr/local/bin/rmuser <<'EOF'
#!/bin/bash
set -e
CONF_DIR="/usr/local/etc/xray"
USERS="$CONF_DIR/.users"
CONFIG="$CONF_DIR/config.json"

if [[ ! -s "$USERS" ]]; then
    echo "–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è."
    exit 1
fi

echo "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:"
awk -F: '{print NR ". " $1}' "$USERS"
read -p "–ù–æ–º–µ—Ä: " num
total=$(wc -l < "$USERS")
if ! [[ "$num" =~ ^[0-9]+$ ]] || (( num < 1 || num > total )); then
    echo -e "\033[0;31m‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä.\033[0m"
    exit 1
fi

name=$(sed -n "${num}p" "$USERS" | cut -d: -f1)
echo -e "\033[1;33m‚ö†Ô∏è  –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è '$name'? (y/n)\033[0m"
read -p "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ: " confirm
if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
    echo "‚ùå –û—Ç–º–µ–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏."
    exit 1
fi

# –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
cp "$CONFIG" "$CONFIG.bak_$(date +%Y%m%d_%H%M%S)"

# –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ñ–∞–π–ª–∞
sed -i "${num}d" "$USERS"

temp_file=$(mktemp)
if [[ -s "$USERS" ]]; then
    # –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    jq -r '.inbounds[0].settings.clients[] | "\(.email):\(.id):\(.flow)"' "$CONFIG" > "$temp_file"
    grep -v "^$name:" "$USERS" | awk -F: '{print $1 ":" $2 ":" "xtls-rprx-vision"}' > "$temp_file.tmp"
    mv "$temp_file.tmp" "$temp_file"
    
    # –°–æ–∑–¥–∞–Ω–∏–µ JSON –º–∞—Å—Å–∏–≤–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤
    clients_json=$(awk -F: 'BEGIN {print "["} 
        NR==1 {printf "  {\"id\": \"%s\", \"email\": \"%s\", \"flow\": \"%s\"}", $2, $1, $3} 
        NR>1 {printf ",\n  {\"id\": \"%s\", \"email\": \"%s\", \"flow\": \"%s\"}", $2, $1, $3} 
        END {print "\n]"}' "$temp_file")
    
    jq --argjson clients "$clients_json" '.inbounds[0].settings.clients = $clients' "$CONFIG" > /tmp/config.tmp && mv /tmp/config.tmp "$CONFIG"
else
    # –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    jq '.inbounds[0].settings.clients = []' "$CONFIG" > /tmp/config.tmp && mv /tmp/config.tmp "$CONFIG"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
if ! xray check; then
    echo -e "\033[0;31m‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏.\033[0m"
    cp "$CONFIG.bak_$(date +%Y%m%d_%H%M%S)" "$CONFIG"
    if ! grep -q "^$name:" "$USERS"; then
        echo "$name" >> "$USERS"  # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ñ–∞–π–ª
    fi
    rm -f "$temp_file"
    exit 1
fi

systemctl restart xray
rm -f "$temp_file"

# –û–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–ª—É–∂–±—ã
sleep 2
if ! ss -tuln | grep -q ':443 '; then
    echo -e "\033[0;31m‚ùå Xray –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é.\033[0m"
    cp "$CONFIG.bak_$(date +%Y%m%d_%H%M%S)" "$CONFIG"
    systemctl restart xray
    exit 1
fi

echo -e "\033[0;32m‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '$name' —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.\033[0m"
EOF
chmod +x /usr/local/bin/rmuser

# === 4. –£–ª—É—á—à–µ–Ω–Ω—ã–π sharelink_by_name —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º IP ===
cat > /usr/local/bin/sharelink_by_name <<'EOF'
#!/bin/bash
CONF_DIR="/usr/local/etc/xray"
USERS="$CONF_DIR/.users"

# –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ IP –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
if [ -z "$SERVER_IP" ]; then
    export SERVER_IP=$(curl -4 -s --max-time 3 icanhazip.com)
    if [ -z "$SERVER_IP" ]; then
        echo -e "\033[0;31m‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å IP —Å–µ—Ä–≤–µ—Ä–∞\033[0m"
        exit 1
    fi
fi

name="$1"
if [[ -z "$name" ]]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <–∏–º—è_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è>"
    exit 1
fi

line=$(grep "^$name:" "$USERS")
if [[ -z "$line" ]]; then
    echo -e "\033[0;31m‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '$name' –Ω–µ –Ω–∞–π–¥–µ–Ω.\033[0m"
    exit 1
fi

uuid=$(echo "$line" | cut -d: -f2)
sid=$(echo "$line" | cut -d: -f3)
pbk=$(awk -F': ' '/Password:/ {print $2}' "$CONF_DIR/.keys")
sni="www.cloudflare.com"

link="vless://$uuid@$SERVER_IP:443?security=reality&sni=$sni&fp=firefox&pbk=$pbk&sid=$sid&type=tcp&flow=xtls-rprx-vision&encryption=none#$name"

echo
echo -e "\033[0;32müîó –°—Å—ã–ª–∫–∞ –¥–ª—è '$name':\033[0m"
echo "$link"
echo
echo -e "\033[0;33mQR-–∫–æ–¥:\033[0m"
echo "$link" | qrencode -t ansiutf8 -s 1
EOF
chmod +x /usr/local/bin/sharelink_by_name

# === 5. –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–¥–æ–±–∞–≤–ª–µ–Ω–æ) ===
cat > /usr/local/bin/stats <<'EOF'
#!/bin/bash
set -e
CONF_DIR="/usr/local/etc/xray"

echo -e "\033[1;33müìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Xray —Å–µ—Ä–≤–µ—Ä–∞\033[0m"
echo "========================================"

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
echo -e "\n\033[0;32müë• –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ –ø–æ—Ä—Ç—É 443:\033[0m"
active_connections=$(ss -tuln | grep ':443' | wc -l)
echo "–í—Å–µ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π: $active_connections"

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
echo -e "\n\033[0;32müë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:\033[0m"
total_users=$(wc -l < "$CONF_DIR/.users" 2>/dev/null || echo 0)
echo "–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: $total_users"
echo "–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:"
awk -F: '{printf "  ‚Ä¢ %s\n", $1}' "$CONF_DIR/.users" 2>/dev/null || echo "  –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏ –∏ CPU
echo -e "\n\033[0;32müíª –†–µ—Å—É—Ä—Å—ã —Å–∏—Å—Ç–µ–º—ã:\033[0m"
xray_pid=$(pgrep xray)
if [ -n "$xray_pid" ]; then
    cpu_usage=$(ps -p $xray_pid -o %cpu | tail -1 | awk '{printf "%.1f%%", $1}')
    mem_usage=$(ps -p $xray_pid -o %mem | tail -1 | awk '{printf "%.1f%%", $1}')
    echo "Xray CPU usage: $cpu_usage"
    echo "Xray Memory usage: $mem_usage"
else
    echo "Xray –Ω–µ –∑–∞–ø—É—â–µ–Ω"
fi

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–∏—Å–∫–∞
echo -e "\n\033[0;32müíæ –î–∏—Å–∫–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ:\033[0m"
df -h / | awk 'NR==2 {printf "–°–≤–æ–±–æ–¥–Ω–æ: %s –∏–∑ %s\n", $4, $2}'

# –°–µ—Ç–µ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
echo -e "\n\033[0;32müåê –°–µ—Ç–µ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç):\033[0m"
if command -v ifstat &> /dev/null; then
    timeout 5 ifstat -i eth0 1 5 2>/dev/null | tail -1
else
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ ifstat –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å–µ—Ç–µ–≤–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: apt install ifstat -y"
fi

# –õ–æ–≥–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–±—ã—Ç–∏–π)
echo -e "\n\033[0;32müìà –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:\033[0m"
journalctl -u xray -n 10 --no-pager --since "5 minutes ago" | grep -E "(client|accept)" | tail -5 || echo "–ù–µ—Ç recent –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π"

echo -e "\n\033[1;33müí° –°–æ–≤–µ—Ç—ã –ø–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É:\033[0m"
echo "  ‚Ä¢ –î–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: journalctl -u xray -f"
echo "  ‚Ä¢ –î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ä–µ—Å—É—Ä—Å–æ–≤: htop –∏–ª–∏ glances"
echo "  ‚Ä¢ –î–ª—è —Å–µ—Ç–µ–≤–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: nload –∏–ª–∏ iftop"
EOF
chmod +x /usr/local/bin/stats

# === 6. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–¥–æ–±–∞–≤–ª–µ–Ω–æ) ===
cat > /usr/local/bin/auto-update <<'EOF'
#!/bin/bash
set -e

echo -e "\033[1;33müîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π Xray...\033[0m"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
LAST_CHECK_FILE="/tmp/xray-last-auto-check"
if [ -f "$LAST_CHECK_FILE" ]; then
    LAST_CHECK=$(cat "$LAST_CHECK_FILE")
    CURRENT_TIME=$(date +%s)
    TIME_DIFF=$((CURRENT_TIME - LAST_CHECK))
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑ –≤ 24 —á–∞—Å–∞
    if [ "$TIME_DIFF" -lt 86400 ]; then
        echo -e "\033[0;33m‚ÑπÔ∏è  –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞–∑ –≤ 24 —á–∞—Å–∞.\033[0m"
        echo "–ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞: $(date -d @$LAST_CHECK)"
        exit 0
    fi
fi

echo "$(date +%s)" > "$LAST_CHECK_FILE"

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
CURRENT_VER=$(xray version | head -1 | awk '{print $2}' | sed 's/v//')
echo -e "\033[0;32m–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: v$CURRENT_VER\033[0m"

# –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é —Å GitHub API
LATEST_VER=$(curl -sL --max-time 5 "https://api.github.com/repos/XTLS/Xray-core/releases/latest" | jq -r '.tag_name' 2>/dev/null | sed 's/v//')
if [ -z "$LATEST_VER" ] || [ "$LATEST_VER" = "null" ]; then
    echo -e "\033[0;33m‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ —Å GitHub.\033[0m"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
    exit 1
fi

echo -e "\033[0;32m–ü–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è: v$LATEST_VER\033[0m"

# –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π
if [ "$CURRENT_VER" = "$LATEST_VER" ]; then
    echo -e "\033[0;32m‚úÖ Xray –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏.\033[0m"
    exit 0
fi

echo -e "\n\033[1;33m‚ö†Ô∏è  –î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è Xray!\033[0m"
echo "–¢–µ–∫—É—â–∞—è: v$CURRENT_VER"
echo "–ü–æ—Å–ª–µ–¥–Ω—è—è: v$LATEST_VER"

read -p "–•–æ—Ç–∏—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å Xray? (y/n): " choice
if [ "$choice" != "y" ] && [ "$choice" != "Y" ]; then
    echo -e "\033[0;33m‚ÑπÔ∏è  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.\033[0m"
    exit 0
fi

# –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
echo -e "\n\033[0;33müîß –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...\033[0m"
BACKUP_DIR="/usr/local/etc/xray/backup"
mkdir -p "$BACKUP_DIR"
BACKUP_FILE="$BACKUP_DIR/config_$(date +%Y%m%d_%H%M%S).json"
cp "/usr/local/etc/xray/config.json" "$BACKUP_FILE"
echo -e "\033[0;32m‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: $BACKUP_FILE\033[0m"

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª—É–∂–±—ã
echo -e "\n\033[0;33m‚èπÔ∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª—É–∂–±—ã Xray...\033[0m"
systemctl stop xray

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
echo -e "\n\033[0;33m‚¨áÔ∏è  –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏...\033[0m"
bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install --no-update-service

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
if ! command -v xray &> /dev/null; then
    echo -e "\033[0;31m‚ùå –û—à–∏–±–∫–∞: xray –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.\033[0m"
    echo "–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏..."
    cp "$BACKUP_FILE" "/usr/local/etc/xray/config.json"
    systemctl start xray
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
echo -e "\n\033[0;33müîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...\033[0m"
if ! xray check; then
    echo -e "\033[0;31m‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.\033[0m"
    echo "–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏..."
    cp "$BACKUP_FILE" "/usr/local/etc/xray/config.json"
    systemctl start xray
    exit 1
fi

# –ó–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã
echo -e "\n\033[0;33m‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã Xray...\033[0m"
systemctl daemon-reload
systemctl start xray

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
sleep 3
if ! ss -tuln | grep -q ':443 '; then
    echo -e "\033[0;31m‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: Xray –Ω–µ —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç 443 –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.\033[0m"
    echo "–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º..."
    cp "$BACKUP_FILE" "/usr/local/etc/xray/config.json"
    systemctl restart xray
    exit 1
fi

echo -e "\n\033[0;32m‚úÖ Xray —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ –≤–µ—Ä—Å–∏–∏ v$LATEST_VER!\033[0m"
echo -e "\033[0;33m–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: $BACKUP_FILE\033[0m"
EOF
chmod +x /usr/local/bin/auto-update

# === 7. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ cron ===
(crontab -l 2>/dev/null; echo "0 3 * * * /usr/local/bin/auto-update >/dev/null 2>&1") | crontab -

# === –û—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (–æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–æ –¥–æ–±–∞–≤–ª—è—é stats –≤ —Å–ø–∏—Å–æ–∫) ===
cat > /usr/local/bin/listuser <<'EOF'
#!/bin/bash
FILE="/usr/local/etc/xray/.users"
if [[ ! -f "$FILE" ]] || [[ ! -s "$FILE" ]]; then
    echo "–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."
else
    echo "–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:"
    awk -F: '{print NR ". " $1}' "$FILE"
fi
EOF
chmod +x /usr/local/bin/listuser

cat > /usr/local/bin/sharelink <<'EOF'
#!/bin/bash
CONF_DIR="/usr/local/etc/xray"
USERS="$CONF_DIR/.users"
if [[ ! -s "$USERS" ]]; then
    echo "–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."
    exit 1
fi
echo "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:"
awk -F: '{print NR ". " $1}' "$USERS"
read -p "–ù–æ–º–µ—Ä: " num
total=$(wc -l < "$USERS")
if ! [[ "$num" =~ ^[0-9]+$ ]] || (( num < 1 || num > total )); then
    echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä."
    exit 1
fi
name=$(sed -n "${num}p" "$USERS" | cut -d: -f1)
/usr/local/bin/sharelink_by_name "$name"
EOF
chmod +x /usr/local/bin/sharelink

cat > /usr/local/bin/mainuser <<'EOF'
#!/bin/bash
/usr/local/bin/sharelink_by_name "main"
EOF
chmod +x /usr/local/bin/mainuser

cat > /usr/local/bin/update <<'EOF'
#!/bin/bash
echo "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Xray..."
systemctl stop xray
bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install --no-update-service
systemctl daemon-reload
systemctl restart xray
echo "‚úÖ Xray –æ–±–Ω–æ–≤–ª—ë–Ω."
EOF
chmod +x /usr/local/bin/update

cat > /usr/local/bin/openssh <<'EOF'
#!/bin/bash
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'
echo -e "${YELLOW}üîí –ü–æ—Ä—Ç 22 –∑–∞–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.${NC}"
echo
echo -e "${YELLOW}‚ö†Ô∏è  –í–ê–ñ–ù–û: –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∏–º–µ–Ω–Ω–æ –≤–∞—à –í–ù–ï–®–ù–ò–ô (–ø—É–±–ª–∏—á–Ω—ã–π) IPv4-–∞–¥—Ä–µ—Å!${NC}"
echo -e "   –≠—Ç–æ –ù–ï –∞–¥—Ä–µ—Å –≤–∏–¥–∞ 192.168.x.x, 10.x.x.x –∏–ª–∏ IP –≤–∞—à–µ–≥–æ VPS."
echo
echo -e "   –£–∑–Ω–∞–π—Ç–µ —Å–≤–æ–π –≤–Ω–µ—à–Ω–∏–π IP –Ω–∞ –æ–¥–Ω–æ–º –∏–∑ —Å–∞–π—Ç–æ–≤:"
echo -e "     ‚Ä¢ https://myip.ru/"
echo -e "     ‚Ä¢ https://2ip.ru/"
echo -e "     ‚Ä¢ https://www.dnsleaktest.com/"
echo
read -p "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–Ω–µ—à–Ω–∏–π IP-–∞–¥—Ä–µ—Å: " USER_IP
if [[ ! "$USER_IP" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
    echo -e "${RED}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç IP-–∞–¥—Ä–µ—Å–∞.${NC}"
    exit 1
fi
IFS='.' read -r a b c d <<< "$USER_IP"
if (( a > 255 || b > 255 || c > 255 || d > 255 )); then
    echo -e "${RED}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π IP-–∞–¥—Ä–µ—Å (—á–∏—Å–ª–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å ‚â§ 255).${NC}"
    exit 1
fi
if [[ "$USER_IP" =~ ^(192\.168|10\.|172\.(1[6-9]|2[0-9]|3[01])) ]]; then
    echo -e "${RED}‚ö†Ô∏è  –í–Ω–∏–º–∞–Ω–∏–µ: –≤—ã –≤–≤–µ–ª–∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π IP!${NC}"
    echo -e "${RED}   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–Ω–µ—à–Ω–∏–π IP —Å myip.ru.${NC}"
    exit 1
fi
if ! command -v fail2ban-client &> /dev/null; then
    echo -e "${GREEN}–£—Å—Ç–∞–Ω–æ–≤–∫–∞ fail2ban –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞...${NC}"
    apt install -y fail2ban
    systemctl enable --now fail2ban
fi
if ufw status | grep -q "ALLOW IN.*$USER_IP.*22"; then
    echo -e "${GREEN}‚úÖ –ü—Ä–∞–≤–∏–ª–æ –¥–ª—è $USER_IP —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.${NC}"
else
    ufw allow from "$USER_IP" to any port 22
    echo -e "${GREEN}‚úÖ –î–æ—Å—Ç—É–ø –ø–æ SSH —Ä–∞–∑—Ä–µ—à—ë–Ω —Å $USER_IP.${NC}"
fi
echo -e "${YELLOW}üí° fail2ban –∞–∫—Ç–∏–≤–µ–Ω: –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞ –ø–æ SSH.${NC}"
EOF
chmod +x /usr/local/bin/openssh

# === help —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥ ===
cat > $HOME/help <<'EOF'
–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
  mainuser    ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Å—Å—ã–ª–∫—É –∏ QR –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  listuser    ‚Äî —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
  adduser     ‚Äî —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏)
  rmuser      ‚Äî —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–µ–π)
  sharelink   ‚Äî –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  stats       ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–µ—Ä–≤–µ—Ä–∞ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
  update      ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å —è–¥—Ä–æ –≤—Ä—É—á–Ω—É—é
  auto-update ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
  openssh     ‚Äî –æ—Ç–∫—Ä—ã—Ç—å SSH –¥–ª—è –≤–∞—à–µ–≥–æ IP –∏ –≤–∫–ª—é—á–∏—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞ (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç fail2ban)
EOF

# === –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤ (—Ç–æ–ª—å–∫–æ RAM) ===
mkdir -p /etc/systemd/journald.conf.d
cat > /etc/systemd/journald.conf.d/00-volatile.conf <<EOF
[Journal]
Storage=volatile
RuntimeMaxUse=32M
EOF
systemctl restart systemd-journald 2>/dev/null || true
journalctl --vacuum-time=1s

# === –§–∏–Ω–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ ===
clear
echo -e "${GREEN}‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Xray (REALITY + Vision) –∑–∞–≤–µ—Ä—à–µ–Ω–∞!${NC}"
LINK="vless://$UUID@$IP:443?security=reality&sni=www.cloudflare.com&fp=firefox&pbk=$REALITY_PUB_KEY&sid=$SHORT_ID&type=tcp&flow=xtls-rprx-vision&encryption=none#main"
echo
echo "–°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:"
echo
echo "$LINK"
echo
echo "QR-–∫–æ–¥:"
echo "$LINK" | qrencode -t ansiutf8 -s 1
echo
echo -e "${YELLOW}‚ú® –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:${NC}"
echo -e "${GREEN}‚úì –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —è–¥—Ä–∞ –∏ —Å–µ—Ç–∏ –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏${NC}"
echo -e "${GREEN}‚úì –ù–∞–¥–µ–∂–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —Å —Ä–µ–∑–µ—Ä–≤–Ω—ã–º–∏ –∫–æ–ø–∏—è–º–∏${NC}"
echo -e "${GREEN}‚úì –ö–æ–º–∞–Ω–¥–∞ 'stats' –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–µ—Ä–≤–µ—Ä–∞${NC}"
echo -e "${GREEN}‚úì –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (—Ä–∞–∑ –≤ 24 —á–∞—Å–∞)${NC}"
echo
echo -e "${YELLOW}–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:${NC}"
echo -e "${GREEN}       cat help${NC}"
echo -e "${YELLOW}üîí –ü–æ—Ä—Ç 22 (SSH) –∑–∞–∫—Ä—ã—Ç —Ñ–∞–µ—Ä–≤–æ–ª–æ–º. –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:${NC}"
echo -e "${GREEN}       openssh${NC}"
echo -e "${YELLOW}   –∏ —É–∫–∞–∂–∏—Ç–µ –≤–∞—à –≤–Ω–µ—à–Ω–∏–π IP (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å myip.ru).${NC}"
echo -e "${YELLOW}üí° –í–∫–ª—é—á–∏—Ç–µ ¬´Use Remote DNS¬ª –≤ –∫–ª–∏–µ–Ω—Ç–µ (Hiddify) –∏ —Ä–µ–∂–∏–º VPN!${NC}"
echo -e "${YELLOW}üìà –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: stats${NC}"
