#!/bin/bash
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}–ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ—Ç root.${NC}"
   exit 1
fi

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
echo -e "${GREEN}–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã...${NC}"
apt update && apt upgrade -y
apt install -y curl wget gnupg qrencode jq

# –°–æ–∑–¥–∞–Ω–∏–µ swap
create_swap_if_needed() {
    TOTAL_MEM_KB=$(grep MemTotal /proc/meminfo | awk '{print $2}')
    TOTAL_MEM_GB=$((TOTAL_MEM_KB / 1024 / 1024))
    if [ "$TOTAL_MEM_GB" -le 1 ]; then
        if ! swapon --show | grep -q '/swapfile'; then
            echo -e "${GREEN}–°–æ–∑–¥–∞–Ω–∏–µ swap-—Ñ–∞–π–ª–∞ 2 –ì–ë...${NC}"
            fallocate -l 2G /swapfile || dd if=/dev/zero of=/swapfile bs=1M count=2048
            chmod 600 /swapfile
            mkswap /swapfile
            swapon /swapfile
            echo '/swapfile none swap sw 0 0' >> /etc/fstab
            echo 'vm.swappiness=10' >> /etc/sysctl.conf
            echo 'vm.vfs_cache_pressure=50' >> /etc/sysctl.conf
            sysctl -p >/dev/null 2>&1
            echo -e "${GREEN}Swap —Å–æ–∑–¥–∞–Ω.${NC}"
        fi
    fi
}
create_swap_if_needed

# –í–∫–ª—é—á–∞–µ–º bbr
bbr=$(sysctl -a | grep net.ipv4.tcp_congestion_control)
if [ "$bbr" = "net.ipv4.tcp_congestion_control = bbr" ]; then
    echo "bbr —É–∂–µ –≤–∫–ª—é—á–µ–Ω"
else
    echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
    echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
    sysctl -p
    echo "bbr –≤–∫–ª—é—á–µ–Ω"
fi

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ufw (—Ç–æ–ª—å–∫–æ 443)
echo -e "${GREEN}–ù–∞—Å—Ç—Ä–æ–π–∫–∞ ufw...${NC}"
apt install -y ufw
ufw allow 443/tcp
ufw --force enable

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ –ø–æ—Ä—Ç–∞ 443
if ss -tuln | grep -q ':443 '; then
    echo -e "${RED}–ü–æ—Ä—Ç 443 –∑–∞–Ω—è—Ç! –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –¥—Ä—É–≥–∏–µ —Å–µ—Ä–≤–∏—Å—ã (nginx, apache, sing-box).${NC}"
    exit 1
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —è–¥—Ä–æ Xray
echo -e "${GREEN}–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Xray-core...${NC}"
bash -c "$(curl -4 -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π
[ -f /usr/local/etc/xray/.keys ] && rm /usr/local/etc/xray/.keys
touch /usr/local/etc/xray/.keys
echo "shortsid: $(openssl rand -hex 8)" >> /usr/local/etc/xray/.keys
echo "uuid: $(xray uuid)" >> /usr/local/etc/xray/.keys
xray x25519 >> /usr/local/etc/xray/.keys

export uuid=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/uuid/ {print $2}')
export privatkey=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/PrivateKey/ {print $2}')
export shortsid=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/shortsid/ {print $2}')

# –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Xray
cat << EOF > /usr/local/etc/xray/config.json
{
    "log": {
        "loglevel": "warning"
    },
    "routing": {
        "domainStrategy": "IPIfNonMatch",
        "rules": [
            {
                "type": "field",
                "domain": [
                    "geosite:category-ads-all"
                ],
                "outboundTag": "block"
            }
        ]
    },
    "inbounds": [
        {
            "listen": "0.0.0.0",
            "port": 443,
            "protocol": "vless",
            "settings": {
                "clients": [
                    {
                        "email": "main",
                        "id": "$uuid",
                        "flow": "xtls-rprx-vision"
                    }
                ],
                "decryption": "none"
            },
            "streamSettings": {
                "network": "tcp",
                "security": "reality",
                "realitySettings": {
                    "show": false,
                    "dest": "www.cloudflare.com:443",
                    "xver": 0,
                    "serverNames": [
                        "www.cloudflare.com"
                    ],
                    "privateKey": "$privatkey",
                    "minClientVer": "",
                    "maxClientVer": "",
                    "maxTimeDiff": 0,
                    "shortIds": [
                        "$shortsid"
                    ]
                }
            },
            "sniffing": {
                "enabled": true,
                "destOverride": [
                    "http",
                    "tls"
                ]
            }
        }
    ],
    "outbounds": [
        {
            "protocol": "freedom",
            "tag": "direct"
        },
        {
            "protocol": "blackhole",
            "tag": "block"
        }
    ],
    "policy": {
        "levels": {
            "0": {
                "handshake": 3,
                "connIdle": 180
            }
        }
    }
}
EOF

# –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤
cat << 'EOF' > /usr/local/bin/listuser
#!/bin/bash
emails=($(jq -r '.inbounds[0].settings.clients[].email' "/usr/local/etc/xray/config.json"))

if [[ ${#emails[@]} -eq 0 ]]; then
    echo "–°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—É—Å—Ç"
    exit 1
fi

echo "–°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤:"
for i in "${!emails[@]}"; do
    echo "$((i+1)). ${emails[$i]}"
done
EOF
chmod +x /usr/local/bin/listuser

# –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
cat << 'EOF' > /usr/local/bin/adduser
#!/bin/bash
read -p "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (email): " email

if [[ -z "$email" || "$email" == *" "* ]]; then
    echo "–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    exit 1
fi

user_json=$(jq --arg email "$email" '.inbounds[0].settings.clients[] | select(.email == $email)' /usr/local/etc/xray/config.json)

if [[ -z "$user_json" ]]; then
    uuid=$(xray uuid)
    jq --arg email "$email" --arg uuid "$uuid" '.inbounds[0].settings.clients += [{"email": $email, "id": $uuid, "flow": "xtls-rprx-vision"}]' /usr/local/etc/xray/config.json > tmp.json && mv tmp.json /usr/local/etc/xray/config.json
    systemctl restart xray
    
    index=$(jq --arg email "$email" '.inbounds[0].settings.clients | to_entries[] | select(.value.email == $email) | .key' /usr/local/etc/xray/config.json)
    protocol=$(jq -r '.inbounds[0].protocol' /usr/local/etc/xray/config.json)
    port=$(jq -r '.inbounds[0].port' /usr/local/etc/xray/config.json)
    uuid=$(jq --argjson index "$index" -r '.inbounds[0].settings.clients[$index].id' /usr/local/etc/xray/config.json)
    pbk=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/PublicKey:/ {print $2}')
    sid=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/shortsid/ {print $2}')
    username=$(jq --argjson index "$index" -r '.inbounds[0].settings.clients[$index].email' /usr/local/etc/xray/config.json)
    sni=$(jq -r '.inbounds[0].streamSettings.realitySettings.serverNames[0]' /usr/local/etc/xray/config.json)
    ip=$(curl -4 -s icanhazip.com)
    link="$protocol://$uuid@$ip:$port?security=reality&sni=$sni&fp=firefox&pbk=$pbk&sid=$sid&type=tcp&flow=xtls-rprx-vision&encryption=none#$username"
    
    echo ""
    echo "–°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:"
    echo "$link"
    echo ""
    echo "QR-–∫–æ–¥:"
    echo "$link" | qrencode -t ansiutf8
else
    echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞." 
fi
EOF
chmod +x /usr/local/bin/adduser

# –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
cat << 'EOF' > /usr/local/bin/rmuser
#!/bin/bash
emails=($(jq -r '.inbounds[0].settings.clients[].email' "/usr/local/etc/xray/config.json"))

if [[ ${#emails[@]} -eq 0 ]]; then
    echo "–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è."
    exit 1
fi

echo "–°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤:"
for i in "${!emails[@]}"; do
    echo "$((i+1)). ${emails[$i]}"
done

read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è: " choice

if ! [[ "$choice" =~ ^[0-9]+$ ]] || (( choice < 1 || choice > ${#emails[@]} )); then
    echo "–û—à–∏–±–∫–∞: –Ω–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ ${#emails[@]}"
    exit 1
fi

selected_email="${emails[$((choice - 1))]}"

jq --arg email "$selected_email" \
   '(.inbounds[0].settings.clients) |= map(select(.email != $email))' \
   "/usr/local/etc/xray/config.json" > tmp && mv tmp "/usr/local/etc/xray/config.json"

systemctl restart xray

echo "–ö–ª–∏–µ–Ω—Ç $selected_email —É–¥–∞–ª—ë–Ω."
EOF
chmod +x /usr/local/bin/rmuser

# –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Å—ã–ª–æ–∫
cat << 'EOF' > /usr/local/bin/sharelink
#!/bin/bash
emails=($(jq -r '.inbounds[0].settings.clients[].email' /usr/local/etc/xray/config.json))

for i in "${!emails[@]}"; do
   echo "$((i + 1)). ${emails[$i]}"
done

read -p "–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞: " client

if ! [[ "$client" =~ ^[0-9]+$ ]] || (( client < 1 || client > ${#emails[@]} )); then
    echo "–û—à–∏–±–∫–∞: –Ω–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ ${#emails[@]}"
    exit 1
fi

selected_email="${emails[$((client - 1))]}"

index=$(jq --arg email "$selected_email" '.inbounds[0].settings.clients | to_entries[] | select(.value.email == $email) | .key' /usr/local/etc/xray/config.json)
protocol=$(jq -r '.inbounds[0].protocol' /usr/local/etc/xray/config.json)
port=$(jq -r '.inbounds[0].port' /usr/local/etc/xray/config.json) 
uuid=$(jq --argjson index "$index" -r '.inbounds[0].settings.clients[$index].id' /usr/local/etc/xray/config.json)
pbk=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/PublicKey:/ {print $2}')
sid=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/shortsid/ {print $2}')
username=$(jq --argjson index "$index" -r '.inbounds[0].settings.clients[$index].email' /usr/local/etc/xray/config.json)
sni=$(jq -r '.inbounds[0].streamSettings.realitySettings.serverNames[0]' /usr/local/etc/xray/config.json)
ip=$(curl -4 -s icanhazip.com)
link="$protocol://$uuid@$ip:$port?security=reality&sni=$sni&fp=firefox&pbk=$pbk&sid=$sid&type=tcp&flow=xtls-rprx-vision&encryption=none#$username"
echo ""
echo "–°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:"
echo "$link"
echo ""
echo "QR-–∫–æ–¥:"
echo "$link" | qrencode -t ansiutf8
EOF
chmod +x /usr/local/bin/sharelink

# –ö–æ–º–∞–Ω–¥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Xray
cat << 'EOF' > /usr/local/bin/update
#!/bin/bash
echo "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Xray..."
systemctl stop xray
bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install
systemctl restart xray
echo "‚úÖ Xray –æ–±–Ω–æ–≤–ª—ë–Ω."
EOF
chmod +x /usr/local/bin/update

# –ö–æ–º–∞–Ω–¥–∞ openssh —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π fail2ban
cat << 'EOF' > /usr/local/bin/openssh
#!/bin/bash
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}üîí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–∞ SSH...${NC}"
echo
echo -e "${YELLOW}‚ö†Ô∏è –í–ê–ñ–ù–û: —É–∫–∞–∂–∏—Ç–µ –≤–∞—à –í–ù–ï–®–ù–ò–ô IPv4-–∞–¥—Ä–µ—Å${NC}"
echo -e "   –≠—Ç–æ –ù–ï 192.168.x.x –∏–ª–∏ 10.x.x.x"
echo
echo -e "   –£–∑–Ω–∞–π—Ç–µ IP –Ω–∞: https://myip.ru/ –∏–ª–∏ https://2ip.ru/"
echo

read -p "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–Ω–µ—à–Ω–∏–π IP: " USER_IP

# –í–∞–ª–∏–¥–∞—Ü–∏—è IP
if [[ ! "$USER_IP" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
    echo -e "${RED}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç IP${NC}"
    exit 1
fi

IFS='.' read -r a b c d <<< "$USER_IP"
if (( a > 255 || b > 255 || c > 255 || d > 255 )); then
    echo -e "${RED}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π IP-–∞–¥—Ä–µ—Å${NC}"
    exit 1
fi

if [[ "$USER_IP" =~ ^(192\.168|10\.|172\.(1[6-9]|2[0-9]|3[01])) ]]; then
    echo -e "${RED}‚ùå –≠—Ç–æ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π IP! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–Ω–µ—à–Ω–∏–π IP.${NC}"
    exit 1
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ fail2ban
if ! command -v fail2ban-client &> /dev/null; then
    echo -e "${GREEN}–£—Å—Ç–∞–Ω–æ–≤–∫–∞ fail2ban...${NC}"
    apt update
    apt install -y fail2ban
    
    # –ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è fail2ban
    cat > /etc/fail2ban/jail.local <<'FAIL2BAN'
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 3

[sshd]
enabled = true
port = ssh
logpath = /var/log/auth.log
maxretry = 3
FAIL2BAN
    
    systemctl enable --now fail2ban
fi

# –û—Ç–∫—Ä—ã—Ç–∏–µ –¥–æ—Å—Ç—É–ø–∞
ufw allow from "$USER_IP" to any port 22
echo -e "${GREEN}‚úÖ –î–æ—Å—Ç—É–ø –ø–æ SSH –æ—Ç–∫—Ä—ã—Ç –¥–ª—è $USER_IP${NC}"
echo -e "${YELLOW}üõ°Ô∏è fail2ban –∞–∫—Ç–∏–≤–µ–Ω - –∑–∞—â–∏—Ç–∞ –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞ –≤–∫–ª—é—á–µ–Ω–∞${NC}"
EOF
chmod +x /usr/local/bin/openssh

# –ö–æ–º–∞–Ω–¥–∞ closessh
cat << 'EOF' > /usr/local/bin/closessh
#!/bin/bash
echo "–ó–∞–∫—Ä—ã—Ç–∏–µ –¥–æ—Å—Ç—É–ø–∞ SSH –∏ —É–¥–∞–ª–µ–Ω–∏–µ fail2ban..."

# –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞ SSH –∏–∑ ufw
ufw status numbered | grep "22" | awk -F"[][]" '{print $2}' | sort -rn | while read -r num; do
    ufw --force delete $num
done

# –£–¥–∞–ª—è–µ–º fail2ban
if command -v fail2ban-client &> /dev/null; then
    systemctl stop fail2ban
    systemctl disable fail2ban
    apt remove --purge -y fail2ban
    rm -rf /etc/fail2ban
    echo "‚úÖ fail2ban —É–¥–∞–ª—ë–Ω"
fi

echo "‚úÖ –î–æ—Å—Ç—É–ø –ø–æ SSH –∑–∞–∫—Ä—ã—Ç"
EOF
chmod +x /usr/local/bin/closessh

systemctl restart xray

# –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏
cat << 'EOF' > /root/help
–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
  listuser    ‚Äî —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
  adduser     ‚Äî —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  rmuser      ‚Äî —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  sharelink   ‚Äî –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  update      ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å —è–¥—Ä–æ
  openssh     ‚Äî –æ—Ç–∫—Ä—ã—Ç—å SSH –¥–ª—è –≤–∞—à–µ–≥–æ IP –∏ –≤–∫–ª—é—á–∏—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞ (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç fail2ban)
  closessh    ‚Äî –∑–∞–∫—Ä—ã—Ç—å SSH –∏ —É–¥–∞–ª–∏—Ç—å fail2ban
EOF

# –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤ (—Ç–æ–ª—å–∫–æ RAM)
mkdir -p /etc/systemd/journald.conf.d
cat > /etc/systemd/journald.conf.d/00-volatile.conf <<EOF
[Journal]
Storage=volatile
RuntimeMaxUse=32M
EOF
systemctl restart systemd-journald 2>/dev/null || true
journalctl --vacuum-time=1s

# –§–∏–Ω–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥
clear
echo -e "${GREEN}‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Xray (REALITY + Vision) –∑–∞–≤–µ—Ä—à–µ–Ω–∞!${NC}"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
protocol=$(jq -r '.inbounds[0].protocol' /usr/local/etc/xray/config.json)
port=$(jq -r '.inbounds[0].port' /usr/local/etc/xray/config.json)
uuid=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/uuid/ {print $2}')
pbk=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/PublicKey:/ {print $2}')
sid=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/shortsid/ {print $2}')
sni=$(jq -r '.inbounds[0].streamSettings.realitySettings.serverNames[0]' /usr/local/etc/xray/config.json)
ip=$(curl -4 -s icanhazip.com)
link="$protocol://$uuid@$ip:$port?security=reality&sni=$sni&fp=firefox&pbk=$pbk&sid=$sid&type=tcp&flow=xtls-rprx-vision&encryption=none#main"

echo
echo "üîó –°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:"
echo
echo "$link"
echo
echo "üì± QR-–∫–æ–¥:"
echo "$link" | qrencode -t ansiutf8 -s 1
echo
echo -e "${YELLOW}–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:${NC}"
echo -e "${GREEN}       cat help${NC}"
echo -e "${YELLOW}üîí –ü–æ—Ä—Ç 22 (SSH) –∑–∞–∫—Ä—ã—Ç —Ñ–∞–µ—Ä–≤–æ–ª–æ–º. –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:${NC}"
echo -e "${GREEN}       openssh${NC}"
echo -e "${YELLOW}   –∏ —É–∫–∞–∂–∏—Ç–µ –≤–∞—à –≤–Ω–µ—à–Ω–∏–π IP (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å myip.ru).${NC}"
echo -e "${YELLOW}üí° –í–∫–ª—é—á–∏—Ç–µ ¬´Use Remote DNS¬ª –≤ –∫–ª–∏–µ–Ω—Ç–µ (Hiddify) –∏ —Ä–µ–∂–∏–º VPN!${NC}"
