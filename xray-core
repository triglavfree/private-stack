#!/bin/bash

set -euo pipefail

# === 1. Обновление системы ===
apt update
apt install -y qrencode curl jq openssl unzip

# === 2. Включение BBR ===
if sysctl net.ipv4.tcp_congestion_control | grep -q "bbr"; then
    echo "BBR уже включен"
else
    echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
    echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
    sysctl -p
    echo "BBR включен"
fi

# === 3. Установка Xray ===
bash -c "$(curl -4 -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install --without-logfiles

# Удаляем старый .keys (если есть) и создаём новый
[ -f /usr/local/etc/xray/.keys ] && rm /usr/local/etc/xray/.keys
touch /usr/local/etc/xray/.keys
echo "shortsid: $(openssl rand -hex 8)" >> /usr/local/etc/xray/.keys
echo "uuid: $(xray uuid)" >> /usr/local/etc/xray/.keys
xray x25519 >> /usr/local/etc/xray/.keys

# === 4. Извлечение ключей ===
uuid=$(awk -F': ' '/uuid/ {print $2}' /usr/local/etc/xray/.keys)
privatkey=$(awk -F': ' '/Private key/ {print $2}' /usr/local/etc/xray/.keys)
shortsid=$(awk -F': ' '/shortsid/ {print $2}' /usr/local/etc/xray/.keys)

# === 5. Создание конфигурации Xray (соответствует требованиям 2025) ===
cat << EOF > /usr/local/etc/xray/config.json
{
    "log": {
        "loglevel": "warning",
        "disableTimestamp": true
    },
    "dns": {
        "hosts": {
            "cloudflare-dns.com": "1.1.1.1"
        },
        "servers": [
            {
                "address": "https://cloudflare-dns.com/dns-query",
                "domains": ["geosite:category-ads-all", "geosite:cn"]
            }
        ],
        "tag": "doh-cloudflare",
        "disableCache": true,
        "disableFallback": true
    },
    "routing": {
        "domainStrategy": "IPIfNonMatch",
        "rules": [
            {
                "type": "field",
                "domain": ["geosite:category-ads-all"],
                "outboundTag": "block"
            },
            {
                "type": "field",
                "ip": ["geoip:private"],
                "outboundTag": "block"
            }
        ]
    },
    "inbounds": [
        {
            "listen": "0.0.0.0",
            "port": 443,
            "protocol": "vless",
            "settings": {
                "clients": [
                    {
                        "email": "main",
                        "id": "$uuid",
                        "flow": "xtls-rprx-vision"
                    }
                ],
                "decryption": "none"
            },
            "streamSettings": {
                "network": "tcp",
                "security": "reality",
                "realitySettings": {
                    "show": false,
                    "dest": "www.cloudflare.com:443",
                    "xver": 0,
                    "serverNames": ["www.cloudflare.com", "cloudflare.com"],
                    "privateKey": "$privatkey",
                    "maxTimeDiff": 90000,
                    "shortIds": ["$shortsid"]
                }
            },
            "sniffing": {
                "enabled": true,
                "destOverride": ["http", "tls", "quic"]
            }
        }
    ],
    "outbounds": [
        {
            "protocol": "freedom",
            "tag": "direct",
            "domainStrategy": "UseIP"
        },
        {
            "protocol": "blackhole",
            "tag": "block"
        }
    ],
    "policy": {
        "levels": {
            "0": {
                "handshake": 4,
                "connIdle": 300,
                "uplinkOnly": 2,
                "downlinkOnly": 4
            }
        },
        "system": {
            "statsInboundDownlink": false,
            "statsInboundUplink": false
        }
    }
}
EOF

# === 6. Создание утилит управления пользователями ===

# userlist
cat << 'EOF' > /usr/local/bin/userlist
#!/bin/bash
emails=($(jq -r '.inbounds[0].settings.clients[].email' "/usr/local/etc/xray/config.json"))
if [[ ${#emails[@]} -eq 0 ]]; then
    echo "Список клиентов пуст"
    exit 1
fi
echo "Список клиентов:"
for i in "${!emails[@]}"; do
    echo "$((i+1)). ${emails[$i]}"
done
EOF
chmod +x /usr/local/bin/userlist

# mainuser
cat << 'EOF' > /usr/local/bin/mainuser
#!/bin/bash
uuid=$(awk -F': ' '/uuid/ {print $2}' /usr/local/etc/xray/.keys)
pbk=$(awk -F': ' '/Public key/ {print $2}' /usr/local/etc/xray/.keys)
sid=$(awk -F': ' '/shortsid/ {print $2}' /usr/local/etc/xray/.keys)
sni=$(jq -r '.inbounds[0].streamSettings.realitySettings.serverNames[0]' /usr/local/etc/xray/config.json)
ip=$(timeout 3 curl -4 -s icanhazip.com || echo "YOUR_IP")
link="vless://$uuid@$ip:443?security=reality&sni=$sni&fp=firefox&pbk=$pbk&sid=$sid&spx=/&type=tcp&flow=xtls-rprx-vision&encryption=none#vless-$ip"
echo
echo "Ссылка для подключения:"
echo "$link"
echo
echo "QR-код:"
echo "$link" | qrencode -t ansiutf8
EOF
chmod +x /usr/local/bin/mainuser

# newuser
cat << 'EOF' > /usr/local/bin/newuser
#!/bin/bash
read -p "Введите имя пользователя (email): " email
if [[ -z "$email" || "$email" == *" "* ]]; then
    echo "Имя пользователя не может быть пустым или содержать пробелы."
    exit 1
fi
if jq -e --arg e "$email" '.inbounds[0].settings.clients[] | select(.email == $e)' /usr/local/etc/xray/config.json >/dev/null; then
    echo "Пользователь с таким именем уже существует."
    exit 1
fi
uuid=$(xray uuid)
jq --arg e "$email" --arg u "$uuid" '.inbounds[0].settings.clients += [{"email": $e, "id": $u, "flow": "xtls-rprx-vision"}]' /usr/local/etc/xray/config.json > tmp.json && mv tmp.json /usr/local/etc/xray/config.json
systemctl restart xray
index=$(jq -r --arg e "$email" '.inbounds[0].settings.clients | to_entries[] | select(.value.email == $e) | .key' /usr/local/etc/xray/config.json)
pbk=$(awk -F': ' '/Public key/ {print $2}' /usr/local/etc/xray/.keys)
sid=$(awk -F': ' '/shortsid/ {print $2}' /usr/local/etc/xray/.keys)
sni=$(jq -r '.inbounds[0].streamSettings.realitySettings.serverNames[0]' /usr/local/etc/xray/config.json)
ip=$(curl -4 -s icanhazip.com || echo "YOUR_IP")
link="vless://$uuid@$ip:443?security=reality&sni=$sni&fp=firefox&pbk=$pbk&sid=$sid&spx=/&type=tcp&flow=xtls-rprx-vision&encryption=none#$email"
echo
echo "Ссылка для подключения:"
echo "$link"
echo
echo "QR-код:"
echo "$link" | qrencode -t ansiutf8
EOF
chmod +x /usr/local/bin/newuser

# rmuser
cat << 'EOF' > /usr/local/bin/rmuser
#!/bin/bash
emails=($(jq -r '.inbounds[0].settings.clients[].email' "/usr/local/etc/xray/config.json"))
if [[ ${#emails[@]} -eq 0 ]]; then
    echo "Нет клиентов для удаления."
    exit 1
fi
echo "Список клиентов:"
for i in "${!emails[@]}"; do
    echo "$((i+1)). ${emails[$i]}"
done
read -p "Введите номер клиента для удаления: " choice
if ! [[ "$choice" =~ ^[0-9]+$ ]] || (( choice < 1 || choice > ${#emails[@]} )); then
    echo "Ошибка: номер должен быть от 1 до ${#emails[@]}"
    exit 1
fi
email="${emails[$((choice - 1))]}"
jq --arg e "$email" '(.inbounds[0].settings.clients) |= map(select(.email != $e))' /usr/local/etc/xray/config.json > tmp && mv tmp /usr/local/etc/xray/config.json
systemctl restart xray
echo "Клиент $email удалён."
EOF
chmod +x /usr/local/bin/rmuser

# sharelink
cat << 'EOF' > /usr/local/bin/sharelink
#!/bin/bash
emails=($(jq -r '.inbounds[0].settings.clients[].email' "/usr/local/etc/xray/config.json"))
for i in "${!emails[@]}"; do
   echo "$((i + 1)). ${emails[$i]}"
done
read -p "Выберите клиента: " client
if ! [[ "$client" =~ ^[0-9]+$ ]] || (( client < 1 || client > ${#emails[@]} )); then
    echo "Ошибка: номер должен быть от 1 до ${#emails[@]}"
    exit 1
fi
email="${emails[$((client - 1))]}"
index=$(jq -r --arg e "$email" '.inbounds[0].settings.clients | to_entries[] | select(.value.email == $e) | .key' /usr/local/etc/xray/config.json)
uuid=$(jq -r --argjson i "$index" '.inbounds[0].settings.clients[$i].id' /usr/local/etc/xray/config.json)
pbk=$(awk -F': ' '/Public key/ {print $2}' /usr/local/etc/xray/.keys)
sid=$(awk -F': ' '/shortsid/ {print $2}' /usr/local/etc/xray/.keys)
sni=$(jq -r '.inbounds[0].streamSettings.realitySettings.serverNames[0]' /usr/local/etc/xray/config.json)
ip=$(curl -4 -s icanhazip.com || echo "YOUR_IP")
link="vless://$uuid@$ip:443?security=reality&sni=$sni&fp=firefox&pbk=$pbk&sid=$sid&spx=/&type=tcp&flow=xtls-rprx-vision&encryption=none#$email"
echo
echo "Ссылка для подключения:"
echo "$link"
echo
echo "QR-код:"
echo "$link" | qrencode -t ansiutf8
EOF
chmod +x /usr/local/bin/sharelink

# === 7. Перезапуск Xray ===
systemctl restart xray

# === 8. Очистка и перенаправление логов в RAM ===
find /var/log -type f -exec truncate -s0 {} \; 2>/dev/null || true
rm -rf /var/log/journal/* 2>/dev/null || true
systemctl restart systemd-journald
if ! grep -q "tmpfs /var/log" /etc/fstab; then
    echo "tmpfs /var/log tmpfs defaults,noatime,nosuid,nodev,noexec,size=100M 0 0" >> /etc/fstab
    mount -o defaults,noatime,nosuid,nodev,noexec,size=100M tmpfs /var/log
fi

# === 9. Создание swap при RAM ≤ 1 ГБ ===
RAM_KB=$(grep MemTotal /proc/meminfo | awk '{print $2}')
RAM_MB=$((RAM_KB / 1024))
if [ "$RAM_MB" -le 1024 ]; then
    if [ ! -f /swapfile ]; then
        fallocate -l 2G /swapfile
        chmod 600 /swapfile
        mkswap /swapfile
        swapon /swapfile
        echo '/swapfile none swap sw 0 0' >> /etc/fstab
    fi
fi

# === 10. Создание файла справки ===
cat << 'EOF' > "$HOME/help"

Команды для управления пользователями Xray:

    mainuser - выводит ссылку для подключения основного пользователя
    newuser - создаёт нового пользователя
    rmuser - удаляет пользователя по номеру
    sharelink - выводит список и генерирует ссылку
    userlist - просто список

Файл конфигурации:
    /usr/local/etc/xray/config.json

Перезапуск Xray:
    systemctl restart xray

EOF

# === 11. Вывод основной ссылки ===
echo "Xray успешно установлен."
mainuser

echo
echo "Файл подсказок сохранён в: $HOME/help"
