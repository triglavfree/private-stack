#!/bin/bash
set -e

# –¶–≤–µ—Ç–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# –ü—Ä–æ–≤–µ—Ä–∫–∞ root
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}–ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ—Ç root.${NC}"
   exit 1
fi

# –°–æ–∑–¥–∞–Ω–∏–µ swap –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
create_swap_if_needed() {
    TOTAL_MEM_KB=$(grep MemTotal /proc/meminfo | awk '{print $2}')
    TOTAL_MEM_GB=$((TOTAL_MEM_KB / 1024 / 1024))
    if [ "$TOTAL_MEM_GB" -le 1 ]; then
        if ! swapon --show | grep -q '/swapfile'; then
            echo -e "${GREEN}–°–æ–∑–¥–∞–Ω–∏–µ swap-—Ñ–∞–π–ª–∞ 2 –ì–ë (RAM ‚â§ 1 –ì–ë)...${NC}"
            fallocate -l 2G /swapfile || dd if=/dev/zero of=/swapfile bs=1M count=2048
            chmod 600 /swapfile
            mkswap /swapfile
            swapon /swapfile
            echo '/swapfile none swap sw 0 0' >> /etc/fstab
            echo 'vm.swappiness=10' >> /etc/sysctl.conf
            echo 'vm.vfs_cache_pressure=50' >> /etc/sysctl.conf
            sysctl -p >/dev/null 2>&1
            echo -e "${GREEN}Swap —Å–æ–∑–¥–∞–Ω.${NC}"
        fi
    fi
}
create_swap_if_needed

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo -e "${GREEN}–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã...${NC}"
apt update && apt upgrade -y
apt install -y curl wget gnupg net-tools qrencode jq

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–µ—Ä–≤–æ–ª–∞ (ufw + fail2ban) ‚Äî –∫–∞–∫ –æ–±–µ—â–∞–Ω–æ –≤ README
echo -e "${GREEN}–ù–∞—Å—Ç—Ä–æ–π–∫–∞ ufw –∏ fail2ban...${NC}"
apt install -y ufw fail2ban
ufw allow 443/tcp
ufw --force enable
systemctl enable --now fail2ban

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Xray
echo -e "${GREEN}–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Xray-core...${NC}"
bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ xray —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
if ! command -v xray &> /dev/null; then
    echo -e "${RED}–û—à–∏–±–∫–∞: xray –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ –Ω–µ –≤ PATH.${NC}"
    exit 1
fi
if ! xray version &> /dev/null; then
    echo -e "${RED}–û—à–∏–±–∫–∞: xray —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–æ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è.${NC}"
    exit 1
fi

# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ IP (—Å fallback –Ω–∞ IPv6)
IP=$(curl -4 -s icanhazip.com || curl -6 -s icanhazip.com)
if [[ -z "$IP" ]]; then
    echo -e "${RED}–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π IP. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.${NC}"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ –ø–æ—Ä—Ç–∞ 443 (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
if ss -tuln | grep -q ':443 '; then
    echo -e "${RED}–ü–æ—Ä—Ç 443 —É–∂–µ –∑–∞–Ω—è—Ç! –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ nginx, apache –∏–ª–∏ –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–∏—Å.${NC}"
    exit 1
fi

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è UUID –∏ –∫–ª—é—á–µ–π (–û–î–ò–ù —Ä–∞–∑!)
UUID=$(xray uuid)
KEYPAIR=$(xray x25519)
REALITY_PRIV_KEY=$(echo "$KEYPAIR" | awk '/^PrivateKey:/ {print $2}')
REALITY_PUB_KEY=$(echo "$KEYPAIR" | awk '/^Password:/ {print $2}')
SHORT_ID=$(openssl rand -hex 4)

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª—é—á–µ–π
mkdir -p /usr/local/etc/xray
cat > /usr/local/etc/xray/.keys <<EOF
uuid: $UUID
Private key: $REALITY_PRIV_KEY
Password: $REALITY_PUB_KEY
shortsid: $SHORT_ID
EOF

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å DoH Cloudflare –∏ –º–∞—Å–∫–∏—Ä–æ–≤–∫–æ–π –ø–æ–¥ www.cloudflare.com
cat > /usr/local/etc/xray/config.json <<EOF
{
  "log": {
    "loglevel": "warning"
  },
  "dns": {
    "servers": [
      "https://1.1.1.1/dns-query"
    ],
    "tag": "doh-cloudflare"
  },
  "inbounds": [
    {
      "port": 443,
      "protocol": "vless",
      "settings": {
        "clients": [
          {
            "id": "$UUID",
            "email": "main",
            "flow": "xtls-rprx-vision"
          }
        ],
        "decryption": "none"
      },
      "streamSettings": {
        "network": "tcp",
        "security": "reality",
        "realitySettings": {
          "show": false,
          "dest": "www.cloudflare.com:443",
          "xver": 0,
          "serverNames": ["www.cloudflare.com"],
          "privateKey": "$REALITY_PRIV_KEY",
          "shortIds": ["$SHORT_ID"]
        }
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "freedom",
      "settings": {},
      "tag": "direct",
      "streamSettings": {
        "sockopt": {
          "tcpKeepAliveIdle": 100,
          "tcpNoDelay": true
        }
      },
      "dnsSettings": {
        "server": "https://1.1.1.1/dns-query"
      }
    },
    {
      "protocol": "dns",
      "tag": "dns-out"
    }
  ],
  "routing": {
    "domainStrategy": "IPIfNonMatch",
    "rules": [
      {
        "type": "field",
        "port": "53",
        "outboundTag": "dns-out"
      }
    ]
  }
}
EOF

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã
systemctl daemon-reload
systemctl enable --now xray

# –£—Ç–∏–ª–∏—Ç—ã
cat > /usr/local/bin/listuser <<'EOF'
#!/bin/bash
emails=($(jq -r '.inbounds[0].settings.clients[].email' "/usr/local/etc/xray/config.json"))
if [[ ${#emails[@]} -eq 0 ]]; then
    echo "–°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—É—Å—Ç"
    exit 1
fi
echo "–°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤:"
for i in "${!emails[@]}"; do
    echo "$((i+1)). ${emails[$i]}"
done
EOF
chmod +x /usr/local/bin/listuser

cat > /usr/local/bin/mainuser <<'EOF'
#!/bin/bash
protocol=$(jq -r '.inbounds[0].protocol' /usr/local/etc/xray/config.json)
port=$(jq -r '.inbounds[0].port' /usr/local/etc/xray/config.json)
uuid=$(awk -F': ' '/uuid/ {print $2}' /usr/local/etc/xray/.keys)
pbk=$(awk -F': ' '/Password/ {print $2}' /usr/local/etc/xray/.keys)
sid=$(awk -F': ' '/shortsid/ {print $2}' /usr/local/etc/xray/.keys)
sni=$(jq -r '.inbounds[0].streamSettings.realitySettings.serverNames[0]' /usr/local/etc/xray/config.json)
ip=$(timeout 3 curl -4 -s icanhazip.com || echo "IP_UNAVAILABLE")
link="$protocol://$uuid@$ip:$port?security=reality&sni=$sni&fp=firefox&pbk=$pbk&sid=$sid&type=tcp&flow=xtls-rprx-vision&encryption=none#vless-$ip"
echo "$link"
EOF
chmod +x /usr/local/bin/mainuser

cat > /usr/local/bin/adduser <<'EOF'
#!/bin/bash
read -p "–ò–º—è: " email
if [[ -z "$email" || "$email" == *" "* ]]; then echo "–ù–µ–≤–µ—Ä–Ω—ã–π email"; exit 1; fi
if jq -e --arg e "$email" '.inbounds[0].settings.clients[] | select(.email == $e)' /usr/local/etc/xray/config.json >/dev/null; then
    echo "–£–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"; exit 1
fi
uuid=$(xray uuid)
jq --arg e "$email" --arg u "$uuid" '.inbounds[0].settings.clients += [{"email": $e, "id": $u, "flow": "xtls-rprx-vision"}]' /usr/local/etc/xray/config.json > /tmp/x.json && mv /tmp/x.json /usr/local/etc/xray/config.json
systemctl restart xray
protocol=$(jq -r '.inbounds[0].protocol' /usr/local/etc/xray/config.json)
port=$(jq -r '.inbounds[0].port' /usr/local/etc/xray/config.json)
pbk=$(awk -F': ' '/Password/ {print $2}' /usr/local/etc/xray/.keys)
sid=$(awk -F': ' '/shortsid/ {print $2}' /usr/local/etc/xray/.keys)
sni=$(jq -r '.inbounds[0].streamSettings.realitySettings.serverNames[0]' /usr/local/etc/xray/config.json)
ip=$(curl -4 -s icanhazip.com)
link="$protocol://$uuid@$ip:$port?security=reality&sni=$sni&fp=firefox&pbk=$pbk&sid=$sid&type=tcp&flow=xtls-rprx-vision&encryption=none#$email"
echo
echo "–°—Å—ã–ª–∫–∞:"
echo "$link"
echo
echo "QR:"
echo "$link" | qrencode -t ansiutf8 -s 2
EOF
chmod +x /usr/local/bin/adduser

cat > /usr/local/bin/rmuser <<'EOF'
#!/bin/bash
emails=($(jq -r '.inbounds[0].settings.clients[].email' "/usr/local/etc/xray/config.json"))
if [[ ${#emails[@]} -eq 0 ]]; then echo "–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤"; exit 1; fi
for i in "${!emails[@]}"; do echo "$((i+1)). ${emails[$i]}"; done
read -p "–ù–æ–º–µ—Ä: " n
if ! [[ "$n" =~ ^[0-9]+$ ]] || (( n < 1 || n > ${#emails[@]} )); then echo "–û—à–∏–±–∫–∞"; exit 1; fi
e="${emails[$((n-1))]}"
jq --arg e "$e" '(.inbounds[0].settings.clients) |= map(select(.email != $e))' /usr/local/etc/xray/config.json > /tmp/x.json && mv /tmp/x.json /usr/local/etc/xray/config.json
systemctl restart xray
echo "–£–¥–∞–ª—ë–Ω: $e"
EOF
chmod +x /usr/local/bin/rmuser

cat > /usr/local/bin/sharelink <<'EOF'
#!/bin/bash
emails=($(jq -r '.inbounds[0].settings.clients[].email' "/usr/local/etc/xray/config.json"))
if [[ ${#emails[@]} -eq 0 ]]; then echo "–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤"; exit 1; fi
for i in "${!emails[@]}"; do echo "$((i+1)). ${emails[$i]}"; done
read -p "–í—ã–±–æ—Ä: " n
if ! [[ "$n" =~ ^[0-9]+$ ]] || (( n < 1 || n > ${#emails[@]} )); then echo "–û—à–∏–±–∫–∞"; exit 1; fi
email="${emails[$((n-1))]}"
uuid=$(jq --arg e "$email" 'first(.inbounds[0].settings.clients[] | select(.email == $e) | .id)' /usr/local/etc/xray/config.json)
protocol=$(jq -r '.inbounds[0].protocol' /usr/local/etc/xray/config.json)
port=$(jq -r '.inbounds[0].port' /usr/local/etc/xray/config.json)
pbk=$(awk -F': ' '/Password/ {print $2}' /usr/local/etc/xray/.keys)
sid=$(awk -F': ' '/shortsid/ {print $2}' /usr/local/etc/xray/.keys)
sni=$(jq -r '.inbounds[0].streamSettings.realitySettings.serverNames[0]' /usr/local/etc/xray/config.json)
ip=$(curl -4 -s icanhazip.com)
link="$protocol://$uuid@$ip:$port?security=reality&sni=$sni&fp=firefox&pbk=$pbk&sid=$sid&type=tcp&flow=xtls-rprx-vision&encryption=none#$email"
echo
echo "–°—Å—ã–ª–∫–∞:"
echo "$link"
echo
echo "QR:"
echo "$link" | qrencode -t ansiutf8 -s 2
EOF
chmod +x /usr/local/bin/sharelink

cat > /usr/local/bin/update <<'EOF'
#!/bin/bash
echo "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Xray..."
bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install
systemctl restart xray
echo "–ì–æ—Ç–æ–≤–æ."
EOF
chmod +x /usr/local/bin/update

cat > $HOME/help <<'EOF'
–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
  mainuser    ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Å—Å—ã–ª–∫—É –∏ QR –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  listuser    ‚Äî —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
  adduser     ‚Äî —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  rmuser      ‚Äî —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  sharelink   ‚Äî –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  update      ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å —è–¥—Ä–æ
EOF

# –§–∏–Ω–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥
clear
echo
echo -e "${GREEN}‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Xray (REALITY + Vision) –∑–∞–≤–µ—Ä—à–µ–Ω–∞!${NC}"
echo

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –≤—ã–≤–æ–¥ —Å—Å—ã–ª–∫–∏
LINK=$(mainuser 2>/dev/null)
if [[ -n "$LINK" && "$LINK" != *"IP_UNAVAILABLE"* ]]; then
    echo
    echo "–°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:"
    echo
    echo "$LINK"
    echo
    echo "QR-–∫–æ–¥:"
    echo "$LINK" | qrencode -t ansiutf8
else
    echo -e "${RED}‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.${NC}"
fi

echo
echo -e "${GREEN} –í–≤–µ–¥–∏—Ç–µ cat help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥${NC}"
echo -e "${YELLOW}üí° –í–∫–ª—é—á–∏—Ç–µ ¬´Use Remote DNS¬ª –≤ –∫–ª–∏–µ–Ω—Ç–µ (Hiddify) –∏ —Ä–µ–∂–∏–º VPN!${NC}"
