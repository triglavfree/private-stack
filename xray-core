#!/bin/bash
# –¶–≤–µ—Ç–Ω–æ–π –≤—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}–ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ—Ç root.${NC}"
   exit 1
fi

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤
apt update
apt install net-tools qrencode curl jq -y

# –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê BBR –î–õ–Ø –ú–ê–õ–û–ú–û–©–ù–´–• VPS
echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ BBR –¥–ª—è 1GB RAM VPS..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
bbr_status=$(sysctl -a 2>/dev/null | grep net.ipv4.tcp_congestion_control | awk '{print $3}')

if [ "$bbr_status" = "bbr" ]; then
    echo "BBR —É–∂–µ –≤–∫–ª—é—á–µ–Ω"
else
    # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    sed -i '/net.core.default_qdisc/d' /etc/sysctl.conf
    sed -i '/net.ipv4.tcp_congestion_control/d' /etc/sysctl.conf
    sed -i '/net.ipv4.tcp_fastopen/d' /etc/sysctl.conf
    sed -i '/net.core.rmem_max/d' /etc/sysctl.conf
    sed -i '/net.core.wmem_max/d' /etc/sysctl.conf
    sed -i '/net.ipv4.tcp_rmem/d' /etc/sysctl.conf
    sed -i '/net.ipv4.tcp_wmem/d' /etc/sysctl.conf
    
    # –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò –î–õ–Ø 1GB RAM
    cat << 'SYSCTL' >> /etc/sysctl.conf
# BBR Congestion Control
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr

# TCP Fast Open
net.ipv4.tcp_fastopen = 3

# Buffer sizes optimized for 1GB RAM
net.core.rmem_max = 67108864
net.core.wmem_max = 67108864
net.core.rmem_default = 131072
net.core.wmem_default = 131072

# TCP memory settings
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864
net.ipv4.tcp_mem = 786432 1048576 1572864

# TCP optimization
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.tcp_max_syn_backlog = 65536
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_syn_retries = 3
net.ipv4.tcp_retries2 = 8

# Keepalive settings
net.ipv4.tcp_keepalive_time = 300
net.ipv4.tcp_keepalive_probes = 5
net.ipv4.tcp_keepalive_intvl = 15

# Network performance
net.core.netdev_max_backlog = 65536
net.core.somaxconn = 65535
net.ipv4.tcp_max_tw_buckets = 1440000
net.ipv4.tcp_tw_reuse = 1
SYSCTL

    # –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    sysctl -p
    echo "‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π BBR –≤–∫–ª—é—á–µ–Ω –¥–ª—è 1GB RAM VPS"
fi

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è NVMe
if lsblk | grep -q nvme; then
    echo "–û–±–Ω–∞—Ä—É–∂–µ–Ω NVMe –¥–∏—Å–∫ - –ø—Ä–∏–º–µ–Ω—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏..."
    # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è I/O –¥–ª—è NVMe
    echo 'vm.swappiness = 10' >> /etc/sysctl.conf
    echo 'vm.dirty_ratio = 15' >> /etc/sysctl.conf
    echo 'vm.dirty_background_ratio = 5' >> /etc/sysctl.conf
    sysctl -p
fi

# –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –°–ò–°–¢–ï–ú–´ –î–õ–Ø VPS
echo "–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π..."

# –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç—ã —Ñ–∞–π–ª–æ–≤ –¥–ª—è –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
sed -i '/^\*.*soft.*nofile/d' /etc/security/limits.conf
sed -i '/^\*.*hard.*nofile/d' /etc/security/limits.conf
echo '* soft nofile 65535' >> /etc/security/limits.conf
echo '* hard nofile 65535' >> /etc/security/limits.conf

# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è systemd services
mkdir -p /etc/systemd/system.conf.d/
cat << 'SYSTEMD' > /etc/systemd/system.conf.d/limits.conf
[Manager]
DefaultLimitNOFILE=65535
DefaultTasksMax=65535
SYSTEMD

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º systemd
systemctl daemon-reload

# –£–±–µ–¥–∏–º—Å—è —á—Ç–æ geosite.dat –∏ geoip.dat —Å—É—â–µ—Å—Ç–≤—É—é—Ç
mkdir -p /usr/local/share/xray
cd /usr/local/share/xray

# –°–∫–∞—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ geo-—Ñ–∞–π–ª—ã –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
if [ ! -f "geosite.dat" ] || [ ! -f "geoip.dat" ]; then
    echo "–°–∫–∞—á–∏–≤–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ geo-—Ñ–∞–π–ª—ã..."
    wget -q -O geoip.dat https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geoip.dat
    wget -q -O geosite.dat https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geosite.dat
    echo "‚úÖ Geo-—Ñ–∞–π–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
fi

# Swap: 2 –ì–ë –µ—Å–ª–∏ RAM ‚â§ 1 –ì–ë –∏ swap –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
setup_swap_if_needed() {
    local ram_kb ram_mb
    ram_kb=$(grep MemTotal /proc/meminfo | awk '{print $2}')
    ram_mb=$((ram_kb / 1024))

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∞–∫—Ç–∏–≤–Ω—ã–π swap
    if swapon --show | grep -q .; then
        echo "info: swap —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º."
        return 0
    fi

    # –ï—Å–ª–∏ /swapfile —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω ‚Äî –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –µ–≥–æ
    if [ -f /swapfile ]; then
        echo "info: /swapfile –Ω–∞–π–¥–µ–Ω, –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º..."
        swapon /swapfile
        return 0
    fi

    # –°–æ–∑–¥–∞—ë–º swap —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ RAM ‚â§ 1 –ì–ë
    if [ "$ram_mb" -le 1024 ]; then
        echo "info: RAM = ${ram_mb} MB ‚â§ 1024 MB ‚Äî —Å–æ–∑–¥–∞—ë–º swap 2 –ì–ë..."
        if fallocate -l 2G /swapfile >/dev/null 2>&1; then
            :
        else
            # fallback –¥–ª—è —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º, –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏—Ö fallocate
            echo "info: fallocate –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º dd..."
            dd if=/dev/zero of=/swapfile bs=1M count=2048 status=none 2>/dev/null
        fi
        chmod 600 /swapfile
        mkswap /swapfile >/dev/null 2>&1
        swapon /swapfile
        echo '/swapfile none swap sw 0 0' >> /etc/fstab
        echo "info: swap 2 –ì–ë —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω."
    else
        echo "info: RAM = ${ram_mb} MB > 1024 MB ‚Äî swap –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è."
    fi
}

# –í–´–ó–´–í–ê–ï–ú –§–£–ù–ö–¶–ò–Æ —Å–æ–∑–¥–∞–Ω–∏—è swap
setup_swap_if_needed

# === –û–¢–ö–õ–Æ–ß–ï–ù–ò–ï –ü–û–°–¢–û–Ø–ù–ù–û–ì–û –•–†–ê–ù–ï–ù–ò–Ø –õ–û–ì–û–í (–¢–û–õ–¨–ö–û RAM) ===
echo "üßπ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ volatile journal (–ª–æ–≥–∏ —Ç–æ–ª—å–∫–æ –≤ RAM)..."

# –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤ —Ç–æ–ª—å–∫–æ –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏
mkdir -p /etc/systemd/journald.conf.d
cat > /etc/systemd/journald.conf.d/00-volatile.conf <<'JOURNALCONF'
[Journal]
Storage=volatile
RuntimeMaxUse=16M
MaxRetentionSec=30s
RateLimitIntervalSec=30s
ForwardToSyslog=no
ForwardToKMsg=no
ForwardToConsole=no
JOURNALCONF

# –û—á–∏—â–∞–µ–º –í–°–ï —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ª–æ–≥–∏
journalctl --vacuum-time=1s --quiet >/dev/null 2>&1

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º journald
systemctl restart systemd-journald

echo "‚úÖ –õ–æ–≥–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –Ω–∞ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≤ RAM (–º–∞–∫—Å 16–ú–ë, 30 —Å–µ–∫—É–Ω–¥)"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —è–¥—Ä–æ Xray
bash -c "$(curl -4 -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install
[ -f /usr/local/etc/xray/.keys ] && rm /usr/local/etc/xray/.keys
touch /usr/local/etc/xray/.keys
echo "shortsid: $(openssl rand -hex 8)" >> /usr/local/etc/xray/.keys
echo "uuid: $(xray uuid)" >> /usr/local/etc/xray/.keys
xray x25519 >> /usr/local/etc/xray/.keys

# –ü–û–õ–£–ß–ê–ï–ú –†–ï–ê–õ–¨–ù–´–ï –ó–ù–ê–ß–ï–ù–ò–Ø –ö–õ–Æ–ß–ï–ô
UUID=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/uuid/ {print $2}')
PRIVATE_KEY=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/PrivateKey/ {print $2}')
SHORT_ID=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/shortsid/ {print $2}')

# –§–∏–Ω–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Xray VLESS + Reality + Vision —Å –¥–≤—É–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
cat > /usr/local/etc/xray/config.json << EOF
{
    "log": {
        "loglevel": "warning",
        "access": "none",
        "error": "none", 
        "dnsLog": false
    },
    "dns": {
        "servers": [
            "1.1.1.1",
            "8.8.8.8",
            {
                "address": "localhost",
                "skipFallback": true
            }
        ],
        "queryStrategy": "UseIPv4",
        "disableCache": false,
        "hosts": {
            "geo.prod.do.dsp.mp.microsoft.com": "127.0.0.1",
            "www.msftconnecttest.com": "127.0.0.1",
            "ctldl.windowsupdate.com": "127.0.0.1",
            "edge.microsoft.com": "127.0.0.1",
            "telemetry.microsoft.com": "127.0.0.1",
            "watson.telemetry.microsoft.com": "127.0.0.1",
            "telemetry.google.com": "127.0.0.1",
            "google-analytics.com": "127.0.0.1",
            "stats.g.doubleclick.net": "127.0.0.1"
        }
    },
    "routing": {
        "domainStrategy": "IPIfNonMatch",
        "rules": [
            {
                "type": "field",
                "port": 53,
                "outboundTag": "direct"
            },
            {
                "type": "field",
                "ip": ["1.1.1.1", "8.8.8.8", "1.0.0.1", "8.8.4.4"],
                "outboundTag": "direct"
            },
            {
                "type": "field",
                "domain": [
                    "domain:geo.prod.do.dsp.mp.microsoft.com",
                    "domain:www.msftconnecttest.com",
                    "domain:telemetry.microsoft.com",
                    "domain:telemetry.google.com"
                ],
                "outboundTag": "block"
            },
            {
                "type": "field",
                "domain": ["geosite:category-ads-all"],
                "outboundTag": "block"
            },
            {
                "type": "field",
                "ip": ["geoip:private"],
                "outboundTag": "direct"
            },
            {
                "type": "field",
                "protocol": ["bittorrent"],
                "outboundTag": "block"
            }
        ]
    },
    "inbounds": [
        {
            "listen": "0.0.0.0",
            "port": 443,
            "protocol": "vless",
            "settings": {
                "clients": [
                    {
                        "email": "main",
                        "id": "$UUID",
                        "flow": "xtls-rprx-vision"
                    },
                    {
                        "email": "ios",
                        "id": "$(xray uuid)",
                        "flow": "xtls-rprx-vision"
                    }
                ],
                "decryption": "none"
            },
            "streamSettings": {
                "network": "tcp",
                "security": "reality",
                "realitySettings": {
                    "show": false,
                    "dest": "www.cloudflare.com:443",
                    "xver": 0,
                    "serverNames": [
                        "www.cloudflare.com",
                        "cloudflare.com",
                        "api.cloudflare.com",
                        "www.icloud.com",
                        "icloud.com",
                        "apple.com",
                        "www.apple.com"
                    ],
                    "privateKey": "$PRIVATE_KEY",
                    "minClientVer": "",
                    "maxClientVer": "",
                    "maxTimeDiff": 0,
                    "shortIds": [
                        "$SHORT_ID"
                    ]
                }
            },
            "sniffing": {
                "enabled": true,
                "destOverride": [
                    "http",
                    "tls"
                ],
                "routeOnly": true
            }
        }
    ],
    "outbounds": [
        {
            "protocol": "freedom",
            "tag": "direct",
            "settings": {
                "domainStrategy": "UseIP"
            }
        },
        {
            "protocol": "blackhole",
            "tag": "block",
            "settings": {
                "response": {
                    "type": "none"
                }
            }
        }
    ],
    "policy": {
        "levels": {
            "0": {
                "handshake": 2,
                "connIdle": 300,
                "uplinkOnly": 1,
                "downlinkOnly": 1
            }
        },
        "system": {
            "statsInboundUplink": false,
            "statsInboundDownlink": false
        }
    }
}
EOF

# –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è mainuser
cat << 'EOF' > /usr/local/bin/mainuser
#!/bin/bash
protocol=$(jq -r '.inbounds[0].protocol' /usr/local/etc/xray/config.json)
port=$(jq -r '.inbounds[0].port' /usr/local/etc/xray/config.json)
uuid=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/uuid/ {print $2}')
pbk=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/Password/ {print $2}')
sid=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/shortsid/ {print $2}')
sni=$(jq -r '.inbounds[0].streamSettings.realitySettings.serverNames[0]' /usr/local/etc/xray/config.json)
ip=$(timeout 3 curl -4 -s icanhazip.com)

link="$protocol://$uuid@$ip:$port?security=reality&sni=$sni&fp=firefox&pbk=$pbk&sid=$sid&spx=/&type=tcp&flow=xtls-rprx-vision&encryption=none#main"

echo ""
echo "–°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:"
echo "$link"
echo ""
echo "QR-–∫–æ–¥:"
echo "$link" | qrencode -t ansiutf8
EOF
chmod +x /usr/local/bin/mainuser

# –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è ios –ø—Ä–æ—Ñ–∏–ª—è
cat << 'EOF' > /usr/local/bin/iosuser
#!/bin/bash
protocol=$(jq -r '.inbounds[0].protocol' /usr/local/etc/xray/config.json)
port=$(jq -r '.inbounds[0].port' /usr/local/etc/xray/config.json)
uuid=$(jq -r '.inbounds[0].settings.clients[] | select(.email == "ios") | .id' /usr/local/etc/xray/config.json)
pbk=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/Password/ {print $2}')
sid=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/shortsid/ {print $2}')
ip=$(timeout 3 curl -4 -s icanhazip.com)

# iOS-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
sni="www.icloud.com"
fp="ios"  # iOS fingerprint

link="$protocol://$uuid@$ip:$port?security=reality&sni=$sni&fp=$fp&pbk=$pbk&sid=$sid&spx=/&type=tcp&flow=xtls-rprx-vision&encryption=none#ios"

echo ""
echo "=== iOS –ü–†–û–§–ò–õ–¨ –î–õ–Ø SHADOWROCKET ==="
echo "–°–µ—Ä–≤–µ—Ä: $ip"
echo "–ü–æ—Ä—Ç: $port"
echo "UUID: $uuid"
echo "Public Key: $pbk"
echo "Short ID: $sid"
echo "SNI: $sni"
echo "Fingerprint: $fp"
echo ""
echo "–°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:"
echo "$link"
echo ""
echo "QR-–∫–æ–¥ –¥–ª—è Shadowrocket:"
echo "$link" | qrencode -t ansiutf8
echo ""
echo "–†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ Shadowrocket:"
echo "–¢–∏–ø: VLESS"
echo "–ê–¥—Ä–µ—Å: $ip"
echo "–ü–æ—Ä—Ç: $port"
echo "UUID: $uuid"
echo "–ó–∞—â–∏—Ç–∞: reality"
echo "SNI: $sni"
echo "Public Key: $pbk"
echo "Short ID: $sid"
echo "Flow: xtls-rprx-vision"
echo "Fingerprint: iOS"
EOF
chmod +x /usr/local/bin/iosuser

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
cat << 'EOF' > /usr/local/bin/adduser
#!/bin/bash

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
choose_user_type() {
    echo "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:"
    echo "1) –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (Cloudflare –º–∞—Å–∫–∏—Ä–æ–≤–∫–∞)"
    echo "2) iOS (iCloud –º–∞—Å–∫–∏—Ä–æ–≤–∫–∞)" 
    echo "3) Android (Chrome –º–∞—Å–∫–∏—Ä–æ–≤–∫–∞)"
    echo "4) –î—Ä—É–≥–æ–π (—Ä—É—á–Ω–æ–π –≤–≤–æ–¥ SNI)"
    
    read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä [1-4]: " type_choice
    
    case $type_choice in
        1)
            USER_TYPE="standard"
            SNI="www.cloudflare.com"
            FP="firefox"
            ;;
        2)
            USER_TYPE="ios"
            SNI="www.icloud.com"
            FP="ios"
            ;;
        3)
            USER_TYPE="android" 
            SNI="www.google.com"
            FP="chrome"
            ;;
        4)
            read -p "–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π SNI (–Ω–∞–ø—Ä–∏–º–µ—Ä: github.com): " custom_sni
            read -p "–í–≤–µ–¥–∏—Ç–µ fingerprint [firefox/chrome/ios/safari]: " custom_fp
            USER_TYPE="custom"
            SNI="$custom_sni"
            FP="$custom_fp"
            ;;
        *)
            echo "–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä"
            exit 1
            ;;
    esac
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
generate_username() {
    case $USER_TYPE in
        "standard")
            echo "user_$(openssl rand -hex 3)"
            ;;
        "ios")
            echo "ios_$(openssl rand -hex 3)" 
            ;;
        "android")
            echo "android_$(openssl rand -hex 3)"
            ;;
        "custom")
            echo "custom_$(openssl rand -hex 3)"
            ;;
    esac
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
choose_user_type

# –ó–∞–ø—Ä–æ—Å –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
read -p "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–ª–∏ Enter –¥–ª—è –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏): " email_input

if [[ -z "$email_input" ]]; then
    email=$(generate_username)
else
    email="$email_input"
fi

# –ü–†–û–í–ï–†–ö–ê –ù–ê –î–£–ë–õ–ò–ö–ê–¢–´ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
existing_emails=$(jq -r '.inbounds[0].settings.clients[].email' /usr/local/etc/xray/config.json 2>/dev/null | grep -Fx "$email")

if [[ -n "$existing_emails" ]]; then
    echo "–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '$email' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"
    exit 1
fi

# –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
uuid=$(xray uuid)
jq --arg email "$email" --arg uuid "$uuid" '.inbounds[0].settings.clients += [{"email": $email, "id": $uuid, "flow": "xtls-rprx-vision"}]' /usr/local/etc/xray/config.json > tmp.json && mv tmp.json /usr/local/etc/xray/config.json

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Xray
systemctl restart xray

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É
protocol=$(jq -r '.inbounds[0].protocol' /usr/local/etc/xray/config.json)
port=$(jq -r '.inbounds[0].port' /usr/local/etc/xray/config.json)
pbk=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/Password/ {print $2}')
sid=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/shortsid/ {print $2}')
ip=$(curl -4 -s icanhazip.com)

link="$protocol://$uuid@$ip:$port?security=reality&sni=$SNI&fp=$FP&pbk=$pbk&sid=$sid&spx=/&type=tcp&flow=xtls-rprx-vision&encryption=none#$email"

# –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
echo ""
echo "‚úÖ –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω!"
echo "üìß –ò–º—è: $email"
echo "üîß –¢–∏–ø: $USER_TYPE"
echo "üåê –ú–∞—Å–∫–∏—Ä–æ–≤–∫–∞: $SNI"
echo "üì± Fingerprint: $FP"
echo ""

echo "–°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:"
echo "$link"
echo ""

echo "QR-–∫–æ–¥:"
echo "$link" | qrencode -t ansiutf8

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è iOS –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
if [[ "$USER_TYPE" == "ios" ]]; then
    echo ""
    echo "=== –î–õ–Ø –ù–ê–°–¢–†–û–ô–ö–ò –í SHADOWROCKET ==="
    echo "–°–µ—Ä–≤–µ—Ä: $ip"
    echo "–ü–æ—Ä—Ç: $port" 
    echo "UUID: $uuid"
    echo "Public Key: $pbk"
    echo "Short ID: $sid"
    echo "SNI: $SNI"
    echo "Fingerprint: $FP"
fi
EOF

chmod +x /usr/local/bin/adduser

# –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
touch /usr/local/bin/rmuser
cat << 'EOF' > /usr/local/bin/rmuser
#!/bin/bash
emails=($(jq -r '.inbounds[0].settings.clients[].email' "/usr/local/etc/xray/config.json"))

if [[ ${#emails[@]} -eq 0 ]]; then
    echo "–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è."
    exit 1
fi

echo "–°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤:"
for i in "${!emails[@]}"; do
    echo "$((i+1)). ${emails[$i]}"
done

read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è: " choice

if ! [[ "$choice" =~ ^[0-9]+$ ]] || (( choice < 1 || choice > ${#emails[@]} )); then
    echo "–û—à–∏–±–∫–∞: –Ω–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ ${#emails[@]}"
    exit 1
fi

selected_email="${emails[$((choice - 1))]}"

jq --arg email "$selected_email" \
   '(.inbounds[0].settings.clients) |= map(select(.email != $email))' \
   "/usr/local/etc/xray/config.json" > tmp && mv tmp "/usr/local/etc/xray/config.json"

systemctl restart xray

echo "–ö–ª–∏–µ–Ω—Ç $selected_email —É–¥–∞–ª—ë–Ω."
EOF
chmod +x /usr/local/bin/rmuser

# –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
cat << 'EOF' > /usr/local/bin/listuser
#!/bin/bash
emails=($(jq -r '.inbounds[0].settings.clients[].email' "/usr/local/etc/xray/config.json"))
if [[ ${#emails[@]} -eq 0 ]]; then
    echo "–°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—É—Å—Ç"
    exit 1
fi
echo "–°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤:"
for i in "${!emails[@]}"; do
    echo "$((i+1)). ${emails[$i]}"
done
EOF
chmod +x /usr/local/bin/listuser

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—Å—ã–ª–æ–∫ –∏ QR
cat << 'EOF' > /usr/local/bin/sharelink
#!/bin/bash
emails=($(jq -r '.inbounds[0].settings.clients[].email' /usr/local/etc/xray/config.json))

for i in "${!emails[@]}"; do
   echo "$((i + 1)). ${emails[$i]}"
done

read -p "–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞: " client

if ! [[ "$client" =~ ^[0-9]+$ ]] || (( client < 1 || client > ${#emails[@]} )); then
    echo "–û—à–∏–±–∫–∞: –Ω–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ ${#emails[@]}"
    exit 1
fi

selected_email="${emails[$((client - 1))]}"

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∏–º–µ–Ω–∏
if [[ "$selected_email" == ios* ]]; then
    SNI="www.icloud.com"
    FP="ios"
elif [[ "$selected_email" == android* ]]; then
    SNI="www.google.com" 
    FP="chrome"
elif [[ "$selected_email" == custom* ]]; then
    # –î–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ–º Cloudflare –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    SNI="www.cloudflare.com"
    FP="firefox"
else
    # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    SNI="www.cloudflare.com"
    FP="firefox"
fi

index=$(jq --arg email "$selected_email" '.inbounds[0].settings.clients | to_entries[] | select(.value.email == $email) | .key'  /usr/local/etc/xray/config.json)
protocol=$(jq -r '.inbounds[0].protocol' /usr/local/etc/xray/config.json)
port=$(jq -r '.inbounds[0].port' /usr/local/etc/xray/config.json) 
uuid=$(jq --argjson index "$index" -r '.inbounds[0].settings.clients[$index].id' /usr/local/etc/xray/config.json)
pbk=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/Password/ {print $2}')
sid=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/shortsid/ {print $2}')
ip=$(curl -4 -s icanhazip.com)

link="$protocol://$uuid@$ip:$port?security=reality&sni=$SNI&fp=$FP&pbk=$pbk&sid=$sid&spx=/&type=tcp&flow=xtls-rprx-vision&encryption=none#$selected_email"

echo ""
echo "–°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:"
echo "$link"
echo ""
echo "QR-–∫–æ–¥:"
echo "$link" | qrencode -t ansiutf8
EOF
chmod +x /usr/local/bin/sharelink

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è ssh –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ IP
cat > /usr/local/bin/openssh <<'EOF'
#!/bin/bash
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}üîí –ü–æ—Ä—Ç 22 –∑–∞–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.${NC}"
echo
echo -e "${YELLOW}‚ö†Ô∏è  –í–ê–ñ–ù–û: –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∏–º–µ–Ω–Ω–æ –≤–∞—à –í–ù–ï–®–ù–ò–ô (–ø—É–±–ª–∏—á–Ω—ã–π) IPv4-–∞–¥—Ä–µ—Å!${NC}"
echo -e "   –≠—Ç–æ –ù–ï –∞–¥—Ä–µ—Å –≤–∏–¥–∞ 192.168.x.x, 10.x.x.x –∏–ª–∏ IP –≤–∞—à–µ–≥–æ VPS."
echo
echo -e "   –£–∑–Ω–∞–π—Ç–µ —Å–≤–æ–π –≤–Ω–µ—à–Ω–∏–π IP –Ω–∞ –æ–¥–Ω–æ–º –∏–∑ —Å–∞–π—Ç–æ–≤:"
echo -e "     ‚Ä¢ https://myip.ru/"
echo -e "     ‚Ä¢ https://2ip.ru/"
echo -e "     ‚Ä¢ https://www.dnsleaktest.com/"
echo

read -p "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–Ω–µ—à–Ω–∏–π IP-–∞–¥—Ä–µ—Å: " USER_IP

if [[ ! "$USER_IP" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
    echo -e "${RED}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç IP-–∞–¥—Ä–µ—Å–∞.${NC}"
    exit 1
fi

IFS='.' read -r a b c d <<< "$USER_IP"
if (( a > 255 || b > 255 || c > 255 || d > 255 )); then
    echo -e "${RED}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π IP-–∞–¥—Ä–µ—Å (—á–∏—Å–ª–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å ‚â§ 255).${NC}"
    exit 1
fi

if [[ "$USER_IP" =~ ^(192\.168|10\.|172\.(1[6-9]|2[0-9]|3[01])) ]]; then
    echo -e "${RED}‚ö†Ô∏è  –í–Ω–∏–º–∞–Ω–∏–µ: –≤—ã –≤–≤–µ–ª–∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π IP!${NC}"
    echo -e "${RED}   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–Ω–µ—à–Ω–∏–π IP —Å myip.ru.${NC}"
    exit 1
fi

# –£–±–µ–¥–∏–º—Å—è —á—Ç–æ UFW —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –≤–∫–ª—é—á–µ–Ω
if ! command -v ufw &> /dev/null; then
    echo -e "${GREEN}–£—Å—Ç–∞–Ω–æ–≤–∫–∞ UFW...${NC}"
    apt install -y ufw
fi

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –±–∞–∑–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ UFW –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
if ! ufw status | grep -q "Status: active"; then
    echo -e "${GREEN}–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑–æ–≤—ã—Ö –ø—Ä–∞–≤–∏–ª UFW...${NC}"
    ufw default deny incoming
    ufw default allow outgoing
    ufw allow 443/tcp  # –†–∞–∑—Ä–µ—à–∞–µ–º Xray
    ufw --force enable
fi

if ! command -v fail2ban-client &> /dev/null; then
    echo -e "${GREEN}–£—Å—Ç–∞–Ω–æ–≤–∫–∞ fail2ban –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞...${NC}"
    apt install -y fail2ban
    systemctl enable --now fail2ban
fi

if ufw status | grep -q "ALLOW IN.*$USER_IP.*22"; then
    echo -e "${GREEN}‚úÖ –ü—Ä–∞–≤–∏–ª–æ –¥–ª—è $USER_IP —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.${NC}"
else
    ufw allow from "$USER_IP" to any port 22
    echo -e "${GREEN}‚úÖ –î–æ—Å—Ç—É–ø –ø–æ SSH —Ä–∞–∑—Ä–µ—à—ë–Ω —Å $USER_IP.${NC}"
fi

echo -e "${YELLOW}üí° fail2ban –∞–∫—Ç–∏–≤–µ–Ω: –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞ –ø–æ SSH.${NC}"
echo -e "${YELLOW}‚ö†Ô∏è  –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏!${NC}"
EOF

chmod +x /usr/local/bin/openssh

# –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã–Ω–∏—è ssh –¥–æ—Å—Ç—É–ø–∞
cat > /usr/local/bin/closessh <<'EOF'
#!/bin/bash
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}üö´ –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –ø–æ—Ä—Ç–æ–≤ –∫—Ä–æ–º–µ 443...${NC}"

if ! command -v ufw &> /dev/null; then
    echo -e "${GREEN}–£—Å—Ç–∞–Ω–æ–≤–∫–∞ UFW...${NC}"
    apt install -y ufw
fi

# –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª–∞ –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Ä—Ç 443
ufw --force reset
ufw default deny incoming
ufw default allow outgoing
ufw allow 443/tcp
ufw --force enable

echo -e "${GREEN}‚úÖ –í—Å–µ –ø–æ—Ä—Ç—ã –∑–∞–∫—Ä—ã—Ç—ã –∫—Ä–æ–º–µ 443/tcp${NC}"
echo -e "${YELLOW}‚ö†Ô∏è  SSH –¥–æ—Å—Ç—É–ø –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–µ–Ω!${NC}"
echo -e "${YELLOW}üìù –î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å —Ö–æ—Å—Ç–µ—Ä–∞${NC}"
EOF

chmod +x /usr/local/bin/closessh

# –§—É–Ω–∫—Ü–∏—è –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —è–¥—Ä–∞ Xray
cat > /usr/local/bin/update <<'EOF'
#!/bin/bash
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}üîÑ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Xray-core...${NC}"
echo
echo -e "–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:"
echo -e "1) –ö–∞–∂–¥—ã–µ 7 –¥–Ω–µ–π"
echo -e "2) –ö–∞–∂–¥—ã–µ 10 –¥–Ω–µ–π"
echo -e "3) –ö–∞–∂–¥—ã–µ 14 –¥–Ω–µ–π"
echo -e "4) –ö–∞–∂–¥—ã–π –º–µ—Å—è—Ü"
echo -e "5) –û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ"

read -p "–í–∞—à –≤—ã–±–æ—Ä [1-5]: " choice

case $choice in
    1) INTERVAL="7";;
    2) INTERVAL="10";;
    3) INTERVAL="14";;
    4) INTERVAL="30";;
    5) 
        crontab -l 2>/dev/null | grep -v "/usr/local/bin/xray-update.sh" | crontab -
        echo -e "${GREEN}‚úÖ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ${NC}"
        exit 0
        ;;
    *) 
        echo -e "${RED}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä${NC}"
        exit 1
        ;;
esac

# –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
cat > /usr/local/bin/xray-update.sh <<'SCRIPT'
#!/bin/bash

echo "$(date): Starting Xray update..." >> /var/log/xray-update.log

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ GeoIP –∏ Geosite –±–∞–∑
echo "$(date): Updating GeoIP and Geosite databases..." >> /var/log/xray-update.log
cd /usr/local/share/xray

# –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –≤–µ—Ä—Å–∏–π GeoIP –∏ Geosite –±–∞–∑
wget -q -O geoip.dat https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geoip.dat
wget -q -O geosite.dat https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geosite.dat

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
if [ $? -eq 0 ]; then
    echo "$(date): Geo databases updated successfully" >> /var/log/xray-update.log
else
    echo "$(date): ERROR: Failed to update Geo databases" >> /var/log/xray-update.log
    exit 1
fi

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —è–¥—Ä–∞ Xray
bash -c "$(curl -4 -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Xray –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
systemctl restart xray
echo "$(date): Xray update completed and service restarted" >> /var/log/xray-update.log
SCRIPT

chmod +x /usr/local/bin/xray-update.sh

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º cron
(crontab -l 2>/dev/null | grep -v "/usr/local/bin/xray-update.sh"; echo "0 2 */${INTERVAL} * * /usr/local/bin/xray-update.sh >/dev/null 2>&1") | crontab -

echo -e "${GREEN}‚úÖ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ!${NC}"
echo -e "${YELLOW}üìÖ Xray –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –∫–∞–∂–¥—ã–µ ${INTERVAL} –¥–Ω–µ–π –≤ 2:00${NC}"
echo -e "${YELLOW}üìã –õ–æ–≥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: /var/log/xray-update.log${NC}"
echo -e "${YELLOW}üîß –†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: /usr/local/bin/xray-update.sh${NC}"
EOF

chmod +x /usr/local/bin/update

# –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞
cat > /usr/local/bin/status <<'EOF'
#!/bin/bash
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${CYAN}–°–¢–ê–¢–£–° –°–ò–°–¢–ï–ú–´${NC}"
echo -e "${CYAN}==============${NC}"

# 1. –°—Ç–∞—Ç—É—Å Xray-core
echo -e "\n${YELLOW}XRAY-CORE:${NC}"
if systemctl is-active xray >/dev/null 2>&1; then
    echo -e "   ${GREEN}–ê–∫—Ç–∏–≤–µ–Ω${NC}"
    xray_version=$(/usr/local/bin/xray version 2>/dev/null | head -1 | awk '{print $2}' 2>/dev/null || echo "?")
    echo -e "   –í–µ—Ä—Å–∏—è: $xray_version"
else
    echo -e "   ${RED}–ù–µ –∞–∫—Ç–∏–≤–µ–Ω${NC}"
fi

# 2. –°—Ç–∞—Ç—É—Å UFW
echo -e "\n${YELLOW}–§–ê–ô–†–í–û–õ:${NC}"
if command -v ufw >/dev/null 2>&1; then
    ufw_status=$(ufw status 2>/dev/null)
    if echo "$ufw_status" | grep -q "Status: active"; then
        echo -e "   ${GREEN}–ê–∫—Ç–∏–≤–µ–Ω${NC}"
        echo -e "   –û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ—Ä—Ç—ã:"
        ufw status | grep -E "(ALLOW|LIMIT)" | while read line; do
            echo -e "      $line"
        done
    else
        echo -e "   ${YELLOW}–ù–µ –∞–∫—Ç–∏–≤–µ–Ω${NC}"
        echo -e "   –°–ª—É—à–∞—é—â–∏–µ –ø–æ—Ä—Ç—ã:"
        netstat -tlnp | grep LISTEN | awk '{print $4}' | cut -d: -f2 | sort -n | uniq | while read port; do
            service=$(netstat -tlnp | grep ":$port " | awk '{print $7}' | cut -d/ -f2 | head -1)
            echo -e "      $port/tcp ($service)"
        done
    fi
else
    echo -e "   –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    echo -e "   –°–ª—É—à–∞—é—â–∏–µ –ø–æ—Ä—Ç—ã:"
    netstat -tlnp | grep LISTEN | awk '{print $4}' | cut -d: -f2 | sort -n | uniq | while read port; do
        service=$(netstat -tlnp | grep ":$port " | awk '{print $7}' | cut -d/ -f2 | head -1)
        echo -e "      $port/tcp ($service)"
    done
fi

# 3. –°—Ç–∞—Ç—É—Å fail2ban
echo -e "\n${YELLOW}FAIL2BAN:${NC}"
if command -v fail2ban-client >/dev/null 2>&1; then
    if systemctl is-active fail2ban >/dev/null 2>&1; then
        echo -e "   ${GREEN}–ê–∫—Ç–∏–≤–µ–Ω${NC}"
        banned_count=$(fail2ban-client status sshd 2>/dev/null | grep "Currently banned:" | awk '{print $3}')
        if [ -n "$banned_count" ]; then
            echo -e "   –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ IP: $banned_count"
        else
            echo -e "   –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ IP: 0"
        fi
    else
        echo -e "   ${RED}–ù–µ –∞–∫—Ç–∏–≤–µ–Ω${NC}"
    fi
else
    echo -e "   –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi

# 4. –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
echo -e "\n${YELLOW}–ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–ï:${NC}"
if crontab -l 2>/dev/null | grep -q "xray-update.sh"; then
    echo -e "   ${GREEN}–í–∫–ª—é—á–µ–Ω–æ${NC}"
    cron_line=$(crontab -l | grep "xray-update.sh")
    interval=$(echo "$cron_line" | grep -o '\*\/[0-9]*' | cut -d'/' -f2)
    if [ -n "$interval" ]; then
        echo -e "   –ò–Ω—Ç–µ—Ä–≤–∞–ª: –∫–∞–∂–¥—ã–µ $interval –¥–Ω–µ–π"
    else
        echo -e "   –ò–Ω—Ç–µ—Ä–≤–∞–ª: –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é cron"
    fi
else
    echo -e "   ${YELLOW}–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ${NC}"
fi

# 5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
echo -e "\n${YELLOW}–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò:${NC}"
user_count=$(jq -r '.inbounds[0].settings.clients | length' /usr/local/etc/xray/config.json 2>/dev/null || echo "0")
echo -e "   –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: $user_count"

# 6. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–µ—Ä–µ
echo -e "\n${YELLOW}–°–ï–†–í–ï–†:${NC}"
server_ip=$(curl -4 -s icanhazip.com 2>/dev/null || echo "–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω")
echo -e "   IP: $server_ip"

xray_port=$(jq -r '.inbounds[0].port' /usr/local/etc/xray/config.json 2>/dev/null || echo "443")
echo -e "   –ü–æ—Ä—Ç Xray: $xray_port/tcp"

# 7. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏
echo -e "\n${YELLOW}–†–ï–°–£–†–°–´:${NC}"
memory_total=$(free -m | awk '/^Mem:/ {print $2}')
memory_used=$(free -m | awk '/^Mem:/ {print $3}')
memory_percent=$((memory_used * 100 / memory_total))
echo -e "   –ü–∞–º—è—Ç—å: ${memory_used}M / ${memory_total}M (${memory_percent}%)"

load=$(uptime | awk -F'load average:' '{print $2}' | xargs)
echo -e "   –ù–∞–≥—Ä—É–∑–∫–∞: $load"

echo -e "\n${CYAN}==============${NC}"
echo -e "${CYAN}–ö–æ–º–∞–Ω–¥—ã: mainuser, iosuser, adduser${NC}"
EOF

chmod +x /usr/local/bin/status

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º xray
systemctl restart xray
clear
echo "Xray-core —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
mainuser

# –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏
touch $HOME/help
cat << 'EOF' > $HOME/help

–ö–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ Xray:

    mainuser   - –≤—ã–≤–æ–¥–∏—Ç —Å—Å—ã–ª–∫—É –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Cloudflare)
    iosuser    - –≤—ã–≤–æ–¥–∏—Ç —Å—Å—ã–ª–∫—É –¥–ª—è iOS —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (iCloud –º–∞—Å–∫–∏—Ä–æ–≤–∫–∞)
    adduser    - —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    listuser   - –≤—ã–≤–æ–¥–∏—Ç —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤
    rmuser     - —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    status     - –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã
    update     - –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Xray –∏ geo–±–∞–∑
    openssh    - –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç SSH –¥–æ—Å—Ç—É–ø –¥–ª—è –≤–≤–µ–¥—ë–Ω–Ω–æ–≥–æ IP –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç ufw –∏ fail2ban
    closessh   - –∑–∞–∫—Ä–æ–µ—Ç –≤—Å–µ –ø–æ—Ä—Ç—ã –∫—Ä–æ–º–µ 443/TCP
    sharelink  - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Å—ã–ª–∫–∏ –∏ QR –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    
–§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ –∞–¥—Ä–µ—Å—É:

    /usr/local/etc/xray/config.json

–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —è–¥—Ä–∞ Xray:

    systemctl restart xray

–¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: VLESS + REALITY + Vision
–î–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:
- main: –º–∞—Å–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–¥ www.cloudflare.com
- ios:  –º–∞—Å–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–¥ www.icloud.com (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è iOS)

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ iOS –ø—Ä–æ—Ñ–∏–ª—è:
- Fingerprint: iOS (–¥–ª—è –ª—É—á—à–µ–π –º–∞—Å–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ Apple —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö)
- SNI: www.icloud.com (–∏–¥–µ–∞–ª—å–Ω–∞—è –º–∞—Å–∫–∏—Ä–æ–≤–∫–∞ –¥–ª—è iOS —Ç—Ä–∞—Ñ–∏–∫–∞)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é TLS –±–∏–±–ª–∏–æ—Ç–µ–∫—É iOS

DNS: Cloudflare DoH (https://1.1.1.1/dns-query)

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
- DNS —á–µ—Ä–µ–∑ DoH –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞ (–∫–∏—Ç–∞–π—Å–∫–∏–µ —Å–∞–π—Ç—ã –∏–¥—É—Ç –Ω–∞–ø—Ä—è–º—É—é)
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ä–µ–∫–ª–∞–º—ã –∏ BitTorrent
- Sniffing –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–æ–º–µ–Ω–æ–≤
EOF
