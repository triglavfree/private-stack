#!/bin/bash

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
echo -e "${YELLOW}–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã...${NC}"
apt update -y && apt upgrade -y

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
apt install -y curl jq qrencode

# –°–æ–∑–¥–∞–Ω–∏–µ Swap —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ RAM ‚â§ 1 –ì–ë
if [ $(free -m | awk '/Mem:/ {print $2}') -le 1024 ]; then
    echo -e "${YELLOW}–°–æ–∑–¥–∞–Ω–∏–µ Swap —Ñ–∞–π–ª–∞ –Ω–∞ 2 –ì–ë...${NC}"
    fallocate -l 2G /swapfile
    chmod 600 /swapfile
    mkswap /swapfile
    swapon /swapfile
    echo '/swapfile none swap sw 0 0' >> /etc/fstab
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Xray-core
echo -e "${YELLOW}–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Xray-core...${NC}"
bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ REALITY + Vision
cat > /usr/local/etc/xray/config.json << 'EOF'
{
  "inbounds": [
    {
      "port": 443,
      "protocol": "vless",
      "settings": {
        "clients": [
          {
            "id": "UUID-PLACEHOLDER",
            "flow": "xtls-rprx-vision"
          }
        ],
        "decryption": "none"
      },
      "streamSettings": {
        "network": "tcp",
        "security": "reality",
        "realitySettings": {
          "show": false,
          "dest": "www.google.com:443",
          "serverNames": ["www.google.com"],
          "privateKey": "PRIVATE-KEY-PLACEHOLDER",
          "shortIds": ["SHORT-ID-PLACEHOLDER"]
        }
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "freedom"
    }
  ]
}
EOF

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π REALITY
openssl rand -hex 8 > /usr/local/etc/xray/.keys
echo "Password: $(openssl rand -hex 8)" >> /usr/local/etc/xray/.keys
echo "shortsid: $(openssl rand -hex 4)" >> /usr/local/etc/xray/.keys

# –ó–∞–º–µ–Ω–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
MAIN_UUID=$(uuidgen)
sed -i "s/UUID-PLACEHOLDER/$MAIN_UUID/" /usr/local/etc/xray/config.json
pbk=$(awk -F': ' '/Password/ {print $2}' /usr/local/etc/xray/.keys)
sed -i "s/PRIVATE-KEY-PLACEHOLDER/$(openssl rand -hex 32)/" /usr/local/etc/xray/config.json
sid=$(awk -F': ' '/shortsid/ {print $2}' /usr/local/etc/xray/.keys)
sed -i "s/SHORT-ID-PLACEHOLDER/$sid/" /usr/local/etc/xray/config.json

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ufw
ufw allow 443/tcp
ufw default deny incoming
ufw default allow outgoing
ufw --force enable

# –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
echo "" > /var/log/syslog
echo "" > /var/log/auth.log
systemctl restart rsyslog

# –ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
cat > /usr/local/bin/listuser << 'EOF'
#!/bin/bash
jq -r '.inbounds[0].settings.clients[] | "UUID: \(.id)"' /usr/local/etc/xray/config.json
EOF

cat > /usr/local/bin/adduser << 'EOF'
#!/bin/bash
NEW_UUID=$(uuidgen)
jq '.inbounds[0].settings.clients += [{"id": "'$NEW_UUID'", "flow": "xtls-rprx-vision"}]' /usr/local/etc/xray/config.json > temp.json && mv temp.json /usr/local/etc/xray/config.json
systemctl restart xray
echo "–ù–æ–≤—ã–π UUID: $NEW_UUID"
EOF

cat > /usr/local/bin/rmuser << 'EOF'
#!/bin/bash
read -p "–í–≤–µ–¥–∏—Ç–µ UUID –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è: " DEL_UUID
jq 'del(.inbounds[0].settings.clients[] | select(.id == "'$DEL_UUID'"))' /usr/local/etc/xray/config.json > temp.json && mv temp.json /usr/local/etc/xray/config.json
systemctl restart xray
EOF

cat > /usr/local/bin/sharelink << 'EOF'
#!/bin/bash
ip=$(curl -4 -s icanhazip.com || curl -6 -s icanhazip.com)
MAIN_UUID=$(jq -r '.inbounds[0].settings.clients[0].id' /usr/local/etc/xray/config.json)
pbk=$(awk -F': ' '/Password/ {print $2}' /usr/local/etc/xray/.keys)
sid=$(awk -F': ' '/shortsid/ {print $2}' /usr/local/etc/xray/.keys)
sni=$(jq -r '.inbounds[0].streamSettings.realitySettings.serverNames[0]' /usr/local/etc/xray/config.json)
LINK="vless://$MAIN_UUID@$ip:443?security=reality&sni=$sni&fp=firefox&pbk=$pbk&sid=$sid&type=tcp&flow=xtls-rprx-vision&encryption=none#main"
echo "$LINK"
echo "$LINK" | qrencode -t ansiutf8
EOF

cat > /usr/local/bin/openssh << 'EOF'
#!/bin/bash
USER_IP=$(curl -4 -s icanhazip.com || curl -6 -s icanhazip.com)
if ! command -v fail2ban &> /dev/null; then
    echo -e "${YELLOW}–£—Å—Ç–∞–Ω–æ–≤–∫–∞ fail2ban –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞...${NC}"
    apt install -y fail2ban
    systemctl enable --now fail2ban
fi
ufw allow from "$USER_IP" to any port 22
echo -e "${GREEN}‚úÖ –î–æ—Å—Ç—É–ø –ø–æ SSH —Ä–∞–∑—Ä–µ—à—ë–Ω —Å $USER_IP.${NC}"
EOF

chmod +x /usr/local/bin/listuser
chmod +x /usr/local/bin/adduser
chmod +x /usr/local/bin/rmuser
chmod +x /usr/local/bin/sharelink
chmod +x /usr/local/bin/openssh

# –§–∏–Ω–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥
clear
ip=$(curl -4 -s icanhazip.com || curl -6 -s icanhazip.com)
MAIN_UUID=$(jq -r '.inbounds[0].settings.clients[0].id' /usr/local/etc/xray/config.json)
pbk=$(awk -F': ' '/Password/ {print $2}' /usr/local/etc/xray/.keys)
sid=$(awk -F': ' '/shortsid/ {print $2}' /usr/local/etc/xray/.keys)
sni=$(jq -r '.inbounds[0].streamSettings.realitySettings.serverNames[0]' /usr/local/etc/xray/config.json)
LINK="vless://$MAIN_UUID@$ip:443?security=reality&sni=$sni&fp=firefox&pbk=$pbk&sid=$sid&type=tcp&flow=xtls-rprx-vision&encryption=none#main"

echo -e "${GREEN}‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Xray (REALITY + Vision) –∑–∞–≤–µ—Ä—à–µ–Ω–∞!${NC}"
echo
echo "–°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:"
echo "$LINK"
echo
echo "QR-–∫–æ–¥:"
echo "$LINK" | qrencode -t ansiutf8
echo
echo -e "${YELLOW}üîí –ü–æ—Ä—Ç 22 (SSH) –∑–∞–∫—Ä—ã—Ç —Ñ–∞–µ—Ä–≤–æ–ª–æ–º. –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:${NC}"
echo -e "${GREEN}       openssh${NC}"
echo -e "${YELLOW}   –∏ —É–∫–∞–∂–∏—Ç–µ –≤–∞—à –≤–Ω–µ—à–Ω–∏–π IP (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å myip.ru).${NC}"
echo -e "${YELLOW}üí° –í–∫–ª—é—á–∏—Ç–µ ¬´Use Remote DNS¬ª –≤ –∫–ª–∏–µ–Ω—Ç–µ (Hiddify) –∏ —Ä–µ–∂–∏–º VPN!${NC}"
