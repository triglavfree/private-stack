#!/bin/bash
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}–ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ—Ç root.${NC}"
   exit 1
fi

# === –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –°–ò–°–¢–ï–ú–´ –î–õ–Ø 1GB RAM ===
echo -e "${GREEN}–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –¥–ª—è VPS 1GB RAM...${NC}"
apt update && apt upgrade -y
apt install -y curl wget gnupg qrencode jq

# –í–∫–ª—é—á–µ–Ω–∏–µ BBR
echo -e "${GREEN}–í–∫–ª—é—á–µ–Ω–∏–µ BBR –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–µ—Ç–∏...${NC}"
if ! sysctl net.ipv4.tcp_congestion_control | grep -q bbr; then
    echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
    echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
    sysctl -p >/dev/null 2>&1
    echo -e "${GREEN}BBR –≤–∫–ª—é—á–µ–Ω.${NC}"
else
    echo -e "${GREEN}BBR —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω.${NC}"
fi

# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏
cat > /etc/sysctl.d/10-xray-optimization.conf <<'EOF'
# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏ –¥–ª—è 1GB RAM
vm.swappiness=10
vm.vfs_cache_pressure=50
vm.dirty_ratio=15
vm.dirty_background_ratio=5
vm.min_free_kbytes=65536

# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∏
net.core.rmem_max=134217728
net.core.wmem_max=134217728
net.ipv4.tcp_rmem=4096 65536 134217728
net.ipv4.tcp_wmem=4096 65536 134217728
net.ipv4.tcp_fastopen=3
net.core.somaxconn=65535
net.ipv4.tcp_max_syn_backlog=65535
EOF
sysctl -p /etc/sysctl.d/10-xray-optimization.conf >/dev/null 2>&1

# –°–æ–∑–¥–∞–Ω–∏–µ swap
create_swap_if_needed() {
    TOTAL_MEM_KB=$(grep MemTotal /proc/meminfo | awk '{print $2}')
    TOTAL_MEM_GB=$((TOTAL_MEM_KB / 1024 / 1024))
    if [ "$TOTAL_MEM_GB" -le 1 ]; then
        if ! swapon --show | grep -q '/swapfile'; then
            echo -e "${GREEN}–°–æ–∑–¥–∞–Ω–∏–µ swap-—Ñ–∞–π–ª–∞ 2 –ì–ë...${NC}"
            fallocate -l 2G /swapfile || dd if=/dev/zero of=/swapfile bs=1M count=2048
            chmod 600 /swapfile
            mkswap /swapfile
            swapon /swapfile
            echo '/swapfile none swap sw 0 0' >> /etc/fstab
            echo -e "${GREEN}Swap —Å–æ–∑–¥–∞–Ω.${NC}"
        fi
    fi
}
create_swap_if_needed

# === –ù–ê–°–¢–†–û–ô–ö–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò ===
echo -e "${GREEN}–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–µ—Ä–≤–æ–ª–∞...${NC}"
apt install -y ufw
ufw --force reset
ufw allow 443/tcp
ufw --force enable

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ –ø–æ—Ä—Ç–∞ 443
if ss -tuln | grep -q ':443 '; then
    echo -e "${RED}–ü–æ—Ä—Ç 443 –∑–∞–Ω—è—Ç! –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –¥—Ä—É–≥–∏–µ —Å–µ—Ä–≤–∏—Å—ã (nginx, apache, sing-box).${NC}"
    ss -tulpn | grep ':443 '
    exit 1
fi

# === –£–°–¢–ê–ù–û–í–ö–ê XRAY-CORE ===
echo -e "${GREEN}–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Xray-core...${NC}"
bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install --no-update-service

if ! command -v xray &> /dev/null; then
    echo -e "${RED}–û—à–∏–±–∫–∞: xray –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.${NC}"
    exit 1
fi

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª—É–∂–±—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
systemctl stop xray 2>/dev/null || true
systemctl disable xray 2>/dev/null || true

# === –ì–ï–ù–ï–†–ê–¶–ò–Ø –ö–õ–Æ–ß–ï–ô ===
IP=$(curl -4 -s --connect-timeout 5 icanhazip.com || curl -4 -s --connect-timeout 5 ifconfig.me)
if [[ -z "$IP" ]]; then
    echo -e "${RED}–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å IPv4.${NC}"
    exit 1
fi

UUID=$(xray uuid)
KEYPAIR=$(xray x25519)
REALITY_PRIV_KEY=$(echo "$KEYPAIR" | awk '/^PrivateKey:/ {print $2}')
REALITY_PUB_KEY=$(echo "$KEYPAIR" | awk '/^PublicKey:/ {print $2}')
SHORT_ID=$(openssl rand -hex 8)

mkdir -p /usr/local/etc/xray

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª—é—á–µ–π
cat > /usr/local/etc/xray/.keys <<EOF
uuid: $UUID
PrivateKey: $REALITY_PRIV_KEY
PublicKey: $REALITY_PUB_KEY
ShortId: $SHORT_ID
EOF

# === –°–û–ó–î–ê–ù–ò–ï –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò ===
cat > /usr/local/etc/xray/config.json <<EOF
{
  "log": {
    "loglevel": "warning",
    "access": "none",
    "error": "none"
  },
  "dns": {
    "servers": [
      "https://1.1.1.1/dns-query",
      "https://8.8.8.8/dns-query"
    ],
    "strategy": "ipv4_first",
    "tag": "doh"
  },
  "inbounds": [{
    "port": 443,
    "listen": "0.0.0.0",
    "protocol": "vless",
    "settings": {
      "clients": [{
        "id": "$UUID",
        "email": "main",
        "flow": "xtls-rprx-vision"
      }],
      "decryption": "none"
    },
    "streamSettings": {
      "network": "tcp",
      "security": "reality",
      "realitySettings": {
        "show": false,
        "dest": "www.cloudflare.com:443",
        "xver": 0,
        "serverNames": ["www.cloudflare.com", "cloudflare.com"],
        "privateKey": "$REALITY_PRIV_KEY",
        "maxTimeDiff": 60000,
        "shortIds": ["$SHORT_ID"]
      }
    },
    "sniffing": {
      "enabled": true,
      "destOverride": ["http", "tls", "quic"],
      "routeOnly": true
    }
  }],
  "outbounds": [
    {
      "protocol": "freedom",
      "settings": {
        "domainStrategy": "UseIP"
      },
      "tag": "direct",
      "streamSettings": {
        "sockopt": {
          "tcpKeepAliveInterval": 30,
          "tcpKeepAliveIdle": 100,
          "tcpNoDelay": true
        }
      }
    },
    {
      "protocol": "dns",
      "tag": "dns-out",
      "settings": {
        "network": "tcp",
        "address": "1.1.1.1",
        "port": 53
      }
    },
    {
      "protocol": "blackhole",
      "tag": "block"
    }
  ],
  "routing": {
    "domainStrategy": "IPIfNonMatch",
    "domainMatcher": "hybrid",
    "rules": [
      {
        "type": "field",
        "port": "53",
        "outboundTag": "dns-out"
      },
      {
        "type": "field",
        "domain": ["geosite:category-ads-all"],
        "outboundTag": "block"
      },
      {
        "type": "field",
        "ip": ["geoip:private"],
        "outboundTag": "block"
      }
    ]
  },
  "policy": {
    "levels": {
      "0": {
        "handshake": 2,
        "connIdle": 120,
        "uplinkOnly": 1,
        "downlinkOnly": 1
      }
    }
  }
}
EOF

# –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
echo "main:$UUID" > /usr/local/etc/xray/.users

# === –ó–ê–ü–£–°–ö –°–õ–£–ñ–ë–´ ===
systemctl daemon-reload
systemctl enable --now xray
sleep 5

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
if ! ss -tuln | grep -q ':443 '; then
    echo -e "${RED}‚ùå Xray –Ω–µ —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç 443.${NC}"
    journalctl -u xray -n 20 --no-pager
    exit 1
else
    echo -e "${GREEN}‚úÖ Xray —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 443.${NC}"
fi

# === –ö–û–ú–ê–ù–î–´ –£–ü–†–ê–í–õ–ï–ù–ò–Ø ===

# listuser - —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
cat > /usr/local/bin/listuser <<'EOF'
#!/bin/bash
CONFIG="/usr/local/etc/xray/config.json"
if [[ ! -f "$CONFIG" ]]; then
    echo "‚ùå –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

echo "üìã –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:"
jq -r '.inbounds[0].settings.clients[] | "üë§ \(.email) | UUID: \(.id)"' "$CONFIG" 2>/dev/null || echo "‚ùå –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–ª–∏ –æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è"
EOF

# adduser - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
cat > /usr/local/bin/adduser <<'EOF'
#!/bin/bash
set -e
CONFIG="/usr/local/etc/xray/config.json"
BACKUP="/usr/local/etc/xray/config.json.backup"

# –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞
cp "$CONFIG" "$BACKUP"

read -p "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ª–∞—Ç–∏–Ω–∏—Ü–∞, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤): " username
if [[ -z "$username" ]] || [[ "$username" =~ [^a-zA-Z0-9_-] ]]; then
    echo "‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
if jq -r '.inbounds[0].settings.clients[].email' "$CONFIG" | grep -q "^$username$"; then
    echo "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '$username' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    exit 1
fi

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è UUID
new_uuid=$(xray uuid)

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
jq --arg email "$username" --arg uuid "$new_uuid" \
   '.inbounds[0].settings.clients += [{"id": $uuid, "email": $email, "flow": "xtls-rprx-vision"}]' \
   "$CONFIG" > /tmp/config.tmp && mv /tmp/config.tmp "$CONFIG"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
if ! xray test -config "$CONFIG" >/dev/null 2>&1; then
    echo "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –±—ç–∫–∞–ø"
    mv "$BACKUP" "$CONFIG"
    systemctl restart xray
    exit 1
fi

systemctl restart xray
echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '$username' –¥–æ–±–∞–≤–ª–µ–Ω"

# –ü–æ–∫–∞–∑ —Å—Å—ã–ª–∫–∏
/usr/local/bin/sharelink_by_name "$username"
EOF

# rmuser - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
cat > /usr/local/bin/rmuser <<'EOF'
#!/bin/bash
CONFIG="/usr/local/etc/xray/config.json"
BACKUP="/usr/local/etc/xray/config.json.backup"

if [[ ! -f "$CONFIG" ]]; then
    echo "‚ùå –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
users=($(jq -r '.inbounds[0].settings.clients[].email' "$CONFIG"))
if [[ ${#users[@]} -eq 0 ]]; then
    echo "‚ùå –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è"
    exit 1
fi

echo "üóëÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:"
for i in "${!users[@]}"; do
    echo "$((i+1)). ${users[i]}"
done

read -p "–ù–æ–º–µ—Ä: " num
if ! [[ "$num" =~ ^[0-9]+$ ]] || (( num < 1 || num > ${#users[@]} )); then
    echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä"
    exit 1
fi

user_to_remove="${users[$((num-1))]}"

# –ë—ç–∫–∞–ø
cp "$CONFIG" "$BACKUP"

# –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
jq --arg email "$user_to_remove" \
   'del(.inbounds[0].settings.clients[] | select(.email == $email))' \
   "$CONFIG" > /tmp/config.tmp && mv /tmp/config.tmp "$CONFIG"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
if ! xray test -config "$CONFIG" >/dev/null 2>&1; then
    echo "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –±—ç–∫–∞–ø"
    mv "$BACKUP" "$CONFIG"
    systemctl restart xray
    exit 1
fi

systemctl restart xray
echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '$user_to_remove' —É–¥–∞–ª—ë–Ω"
EOF

# sharelink_by_name - —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
cat > /usr/local/bin/sharelink_by_name <<'EOF'
#!/bin/bash
name="$1"
if [[ -z "$name" ]]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <–∏–º—è_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è>"
    exit 1
fi

CONFIG="/usr/local/etc/xray/config.json"
KEYS="/usr/local/etc/xray/.keys"

if [[ ! -f "$CONFIG" ]] || [[ ! -f "$KEYS" ]]; then
    echo "‚ùå –§–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    exit 1
fi

# –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user_uuid=$(jq -r --arg email "$name" '.inbounds[0].settings.clients[] | select(.email == $email) | .id' "$CONFIG")
if [[ -z "$user_uuid" || "$user_uuid" == "null" ]]; then
    echo "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '$name' –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–µ–π
pbk=$(awk -F': ' '/PublicKey:/ {print $2}' "$KEYS")
sid=$(awk -F': ' '/ShortId:/ {print $2}' "$KEYS")
ip=$(curl -4 -s icanhazip.com)
sni="www.cloudflare.com"

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏
link="vless://$user_uuid@$ip:443?security=reality&sni=$sni&fp=firefox&pbk=$pbk&sid=$sid&type=tcp&flow=xtls-rprx-vision&encryption=none#$name"

echo
echo "üîó –°—Å—ã–ª–∫–∞ –¥–ª—è '$name':"
echo "$link"
echo
echo "üì± QR-–∫–æ–¥:"
echo "$link" | qrencode -t ansiutf8 -s 1
echo
EOF

# sharelink - —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
cat > /usr/local/bin/sharelink <<'EOF'
#!/bin/bash
CONFIG="/usr/local/etc/xray/config.json"

if [[ ! -f "$CONFIG" ]]; then
    echo "‚ùå –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

users=($(jq -r '.inbounds[0].settings.clients[].email' "$CONFIG"))
if [[ ${#users[@]} -eq 0 ]]; then
    echo "‚ùå –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
    exit 1
fi

echo "üîó –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏:"
for i in "${!users[@]}"; do
    echo "$((i+1)). ${users[i]}"
done

read -p "–ù–æ–º–µ—Ä: " num
if ! [[ "$num" =~ ^[0-9]+$ ]] || (( num < 1 || num > ${#users[@]} )); then
    echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä"
    exit 1
fi

/usr/local/bin/sharelink_by_name "${users[$((num-1))]}"
EOF

# mainuser
cat > /usr/local/bin/mainuser <<'EOF'
#!/bin/bash
/usr/local/bin/sharelink_by_name "main"
EOF

# update - —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
cat > /usr/local/bin/update <<'EOF'
#!/bin/bash
echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Xray..."
systemctl stop xray

# –ë—ç–∫–∞–ø –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
cp /usr/local/etc/xray/config.json /usr/local/etc/xray/config.json.backup

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install --no-update-service

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
mv /usr/local/etc/xray/config.json.backup /usr/local/etc/xray/config.json

systemctl daemon-reload
systemctl restart xray

echo "‚úÖ Xray –æ–±–Ω–æ–≤–ª—ë–Ω"
EOF

# openssh - —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
cat > /usr/local/bin/openssh <<'EOF'
#!/bin/bash
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}üîí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–∞ SSH...${NC}"
echo
echo -e "${YELLOW}‚ö†Ô∏è –í–ê–ñ–ù–û: —É–∫–∞–∂–∏—Ç–µ –≤–∞—à –í–ù–ï–®–ù–ò–ô IPv4-–∞–¥—Ä–µ—Å${NC}"
echo -e "   –≠—Ç–æ –ù–ï 192.168.x.x –∏–ª–∏ 10.x.x.x"
echo
echo -e "   –£–∑–Ω–∞–π—Ç–µ IP –Ω–∞: https://myip.ru/ –∏–ª–∏ https://2ip.ru/"
echo

read -p "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–Ω–µ—à–Ω–∏–π IP: " USER_IP

# –í–∞–ª–∏–¥–∞—Ü–∏—è IP
if [[ ! "$USER_IP" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
    echo -e "${RED}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç IP${NC}"
    exit 1
fi

IFS='.' read -r a b c d <<< "$USER_IP"
if (( a > 255 || b > 255 || c > 255 || d > 255 )); then
    echo -e "${RED}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π IP-–∞–¥—Ä–µ—Å${NC}"
    exit 1
fi

if [[ "$USER_IP" =~ ^(192\.168|10\.|172\.(1[6-9]|2[0-9]|3[01])) ]]; then
    echo -e "${RED}‚ùå –≠—Ç–æ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π IP! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–Ω–µ—à–Ω–∏–π IP.${NC}"
    exit 1
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ fail2ban
if ! command -v fail2ban-client &> /dev/null; then
    echo -e "${GREEN}–£—Å—Ç–∞–Ω–æ–≤–∫–∞ fail2ban...${NC}"
    apt update
    apt install -y fail2ban
    
    # –ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è fail2ban
    cat > /etc/fail2ban/jail.local <<'FAIL2BAN'
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 3

[sshd]
enabled = true
port = ssh
logpath = /var/log/auth.log
maxretry = 3
FAIL2BAN
    
    systemctl enable --now fail2ban
fi

# –û—Ç–∫—Ä—ã—Ç–∏–µ –¥–æ—Å—Ç—É–ø–∞
if ufw status | grep -q "$USER_IP.*22"; then
    echo -e "${GREEN}‚úÖ –î–æ—Å—Ç—É–ø –¥–ª—è $USER_IP —É–∂–µ –æ—Ç–∫—Ä—ã—Ç${NC}"
else
    ufw allow from "$USER_IP" to any port 22
    echo -e "${GREEN}‚úÖ –î–æ—Å—Ç—É–ø –ø–æ SSH –æ—Ç–∫—Ä—ã—Ç –¥–ª—è $USER_IP${NC}"
fi

echo -e "${YELLOW}üõ°Ô∏è fail2ban –∞–∫—Ç–∏–≤–µ–Ω - –∑–∞—â–∏—Ç–∞ –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞ –≤–∫–ª—é—á–µ–Ω–∞${NC}"
EOF

# –ü—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
chmod +x /usr/local/bin/{listuser,adduser,rmuser,sharelink,mainuser,update,openssh,sharelink_by_name}

# === –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –õ–û–ì–û–í ===
echo -e "${GREEN}–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è...${NC}"
mkdir -p /etc/systemd/journald.conf.d
cat > /etc/systemd/journald.conf.d/00-volatile.conf <<'EOF'
[Journal]
Storage=volatile
RuntimeMaxUse=16M
MaxRetentionSec=1h
SystemMaxUse=16M
EOF

# –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
journalctl --vacuum-time=1s >/dev/null 2>&1
systemctl restart systemd-journald >/dev/null 2>&1

# –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ª–æ–≥–æ–≤ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏
find /var/log -name "*.log" -type f -exec truncate -s 0 {} \; 2>/dev/null || true

# === –§–ò–ù–ê–õ–¨–ù–´–ô –í–´–í–û–î ===
clear
echo -e "${GREEN}‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Xray (REALITY + Vision) –∑–∞–≤–µ—Ä—à–µ–Ω–∞!${NC}"
echo
echo -e "${YELLOW}üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:${NC}"
echo -e "  ${GREEN}mainuser${NC}    - —Å—Å—ã–ª–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
echo -e "  ${GREEN}listuser${NC}    - —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"  
echo -e "  ${GREEN}adduser${NC}     - –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
echo -e "  ${GREEN}rmuser${NC}      - —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
echo -e "  ${GREEN}sharelink${NC}   - –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
echo -e "  ${GREEN}update${NC}      - –æ–±–Ω–æ–≤–∏—Ç—å Xray"
echo -e "  ${GREEN}openssh${NC}     - –æ—Ç–∫—Ä—ã—Ç—å SSH –¥–æ—Å—Ç—É–ø"
echo
echo -e "${YELLOW}üîó –û—Å–Ω–æ–≤–Ω–∞—è —Å—Å—ã–ª–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:${NC}"
/usr/local/bin/mainuser
echo
echo -e "${YELLOW}üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:${NC}"
echo -e "  ‚Ä¢ –ü–æ—Ä—Ç 22 –∑–∞–∫—Ä—ã—Ç"
echo -e "  ‚Ä¢ –û—Ç–∫—Ä—ã—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Ä—Ç 443/tcp"
echo -e "  ‚Ä¢ REALITY + TLS —Å –º–∞—Å–∫–∏—Ä–æ–≤–∫–æ–π –ø–æ–¥ Cloudflare"
echo -e "  ‚Ä¢ DNS —á–µ—Ä–µ–∑ DoH (Cloudflare)"
echo -e "  ‚Ä¢ –õ–æ–≥–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ RAM"
echo
echo -e "${YELLOW}üí° –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –ø–æ SSH –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: ${GREEN}openssh${NC}"
echo -e "${YELLOW}üìö –í—Å–µ –∫–æ–º–∞–Ω–¥—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: ${GREEN}$HOME/help${NC}"
