#!/bin/bash
# install-private-stack-reality.sh
# Xray (REALITY + Vision) + SearXNG + Nginx (fallback) + LE (Ð´Ð»Ñ Ð²ÐµÐ±Ð°)
# Ð‘ÐµÐ· Docker, Ð¿Ð¾Ð´ 1 Ð“Ð‘ RAM, Ubuntu 22.04/24.04, ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ Ñ iOS/macOS

set -e
exec > >(tee -a /var/log/privatestack_reality_install.log) 2>&1

log() { echo -e "\033[0;32m[+]\033[0m $1"; }
error() { echo -e "\033[0;31m[-]\033[0m $1"; exit 1; }

if [[ "$(id -u)" -ne 0 ]]; then error "Ð—Ð°Ð¿ÑƒÑÐºÐ°Ð¹Ñ‚Ðµ Ð¾Ñ‚ root"; fi

if ! grep -q "Ubuntu" /etc/os-release || ! grep -q "24.04\|22.04" /etc/os-release; then
    error "Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ubuntu 22.04 Ð¸Ð»Ð¸ 24.04"
fi

# === Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ===
log "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²..."
DEBIAN_FRONTEND=noninteractive apt-get update -qq
DEBIAN_FRONTEND=noninteractive apt-get install -y \
    curl git python3 python3-venv nginx-light ufw fail2ban \
    certbot python3-certbot-nginx jq qrencode

# === Swap ===
if ! swapon -s | grep -q "/swapfile"; then
    log "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ swap (2 Ð“Ð‘)..."
    fallocate -l 2G /swapfile
    chmod 600 /swapfile
    mkswap /swapfile
    swapon /swapfile
    echo '/swapfile none swap sw 0 0' >> /etc/fstab
fi

# === UFW + fail2ban ===
ufw --force reset
ufw default deny incoming
ufw default allow outgoing
ufw allow 22/tcp comment "SSH"
ufw allow 80/tcp comment "HTTP (LE + fallback)"
ufw allow 443/tcp comment "HTTPS (REALITY)"
ufw --force enable
systemctl enable --now fail2ban

# === Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Xray ===
log "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Xray..."
bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install

# === REALITY: Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð² ===
log "Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ REALITY ÐºÐ»ÑŽÑ‡ÐµÐ¹..."
REALITY_OUTPUT=$(xray x25519 2>/dev/null)
PRIVATE_KEY=$(echo "$REALITY_OUTPUT" | grep "Private key:" | cut -d ' ' -f3)
PUBLIC_KEY=$(echo "$REALITY_OUTPUT" | grep "Public key:" | cut -d ' ' -f3)
UUID=$(xray uuid)
SHORT_ID=$(openssl rand -hex 4)  # 4 Ð±Ð°Ð¹Ñ‚Ð° â†’ 8 hex ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²

DOMAIN="private-stack.site"
IP=$(curl -4s ifconfig.me)

# === Let's Encrypt Ð´Ð»Ñ Ð²ÐµÐ±-Ð·Ð°Ð³Ð»ÑƒÑˆÐºÐ¸ (Ð½Ðµ Ð´Ð»Ñ REALITY!) ===
log "ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð° Ð´Ð»Ñ $DOMAIN (fallback)..."
mkdir -p /var/www/html
echo "server { listen 80; server_name $DOMAIN; root /var/www/html; }" > /etc/nginx/sites-enabled/default
systemctl reload nginx
certbot certonly --webroot -w /var/www/html -d "$DOMAIN" --non-interactive --agree-tos --register-unsafely-without-email

# === ÐšÐ¾Ð½Ñ„Ð¸Ð³ Xray REALITY (Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐÐ«Ð™) ===
mkdir -p /usr/local/etc/xray
cat > /usr/local/etc/xray/config.json <<EOF
{
  "log": { "loglevel": "warning" },
  "inbounds": [
    {
      "port": 443,
      "protocol": "vless",
      "settings": {
        "clients": [{ "id": "$UUID", "flow": "xtls-rprx-vision" }],
        "decryption": "none",
        "fallbacks": [
          { "alpn": "h2", "dest": 80 },
          { "dest": 80 }
        ]
      },
      "streamSettings": {
        "network": "tcp",
        "security": "reality",
        "realitySettings": {
          "show": false,
          "dest": "www.cloudflare.com:443",
          "xver": 0,
          "serverNames": ["www.cloudflare.com", "cloudflare.com"],
          "privateKey": "$PRIVATE_KEY",
          "publicKey": "$PUBLIC_KEY",
          "shortIds": ["$SHORT_ID"]
        }
      }
    }
  ],
  "outbounds": [{ "protocol": "freedom" }]
}
EOF

systemctl restart xray

# === SearXNG (Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾ Ð½Ð° 127.0.0.1:8888) ===
log "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° SearXNG..."
git clone https://github.com/searxng/searxng.git /opt/searxng
cd /opt/searxng
curl -LsSf https://astral.sh/uv/install.sh | sh
export PATH="/root/.cargo/bin:$PATH"
python3 -m venv venv
source venv/bin/activate
/root/.cargo/bin/uv pip install -r requirements.txt
cp utils/searx/settings.yml searxng/settings.yml
sed -i 's/json_output:.*/json_output: true/' searxng/settings.yml
sed -i 's|port:.*|port: 8888|' searxng/settings.yml
sed -i 's|bind_address:.*|bind_address: "127.0.0.1"|' searxng/settings.yml
cp utils/searx/systemd/searx.service /etc/systemd/system/
systemctl daemon-reload
systemctl enable --now searx

# === Nginx: fallback Ð½Ð° 80 Ð¿Ð¾Ñ€Ñ‚ ===
cat > /etc/nginx/sites-available/default <<EOF
server {
    listen 80;
    server_name $DOMAIN;
    root /var/www/html;
    index index.html;
}
EOF
echo "<h1>Private Stack</h1>" > /var/www/html/index.html
systemctl reload nginx

# === Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÑÑ‹Ð»ÐºÐ¸ ===
cat > /usr/local/bin/mainuser <<EOF
#!/bin/bash
UUID=\$(jq -r '.inbounds[0].settings.clients[0].id' /usr/local/etc/xray/config.json)
PUBKEY=\$(jq -r '.inbounds[0].streamSettings.realitySettings.publicKey' /usr/local/etc/xray/config.json)
SHORTID=\$(jq -r '.inbounds[0].streamSettings.realitySettings.shortIds[0]' /usr/local/etc/xray/config.json)
DOMAIN="private-stack.site"

# URL-ÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ ÐºÐ»ÑŽÑ‡Ð°
PUBKEY_ENCODED=\$(echo "\$PUBKEY" | sed 's/+/%2B/g; s/\//%2F/g')

LINK="vless://\$UUID@\$DOMAIN:443?encryption=none&security=reality&fp=chrome&pbk=\$PUBKEY_ENCODED&sid=\$SHORTID&sni=www.cloudflare.com&flow=xtls-rprx-vision&type=tcp#PrivateStack-REALITY"

echo "ðŸ”— REALITY-ÑÑÑ‹Ð»ÐºÐ°:"
echo "\$LINK"
echo
echo "ðŸ“± QR-ÐºÐ¾Ð´:"
echo "\$LINK" | qrencode -t ansiutf8
EOF
chmod +x /usr/local/bin/mainuser

log "âœ… Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
echo
echo "Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ: mainuser"
echo "ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÐ¼Ñ‹Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñ‹: Hiddify (Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ), Shadowrocket (>=2.5), v2rayNG"
