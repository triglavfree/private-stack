#!/bin/bash
# private-stack: Xray (REALITY) + SearXNG + Vaultwarden + Cloudflare Tunnel
# Ð‘ÐµÐ· Ð´Ð¾Ð¼ÐµÐ½Ð°, Ð±ÐµÐ· Docker, Ð¿Ð¾Ð´ 1 Ð“Ð‘ RAM, Ubuntu 22.04/24.04

set -euo pipefail
exec > >(tee -a /var/log/privatestack_install.log) 2>&1

log() { echo -e "\033[0;32m[+]\033[0m $1"; }
error() { echo -e "\033[0;31m[-]\033[0m $1"; exit 1; }

if [[ "$(id -u)" -ne 0 ]]; then error "Ð—Ð°Ð¿ÑƒÑÐºÐ°Ð¹Ñ‚Ðµ Ð¾Ñ‚ root"; fi
if ! grep -q "Ubuntu" /etc/os-release || ! grep -q "24.04\|22.04" /etc/os-release; then
    error "Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ubuntu 22.04 Ð¸Ð»Ð¸ 24.04"
fi

# === Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ ===
log "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²..."
DEBIAN_FRONTEND=noninteractive apt-get update -qq
DEBIAN_FRONTEND=noninteractive apt-get install -y \
    curl git python3 python3-venv nginx-light ufw fail2ban \
    jq qrencode

# === Swap ===
if ! swapon -s | grep -q "/swapfile"; then
    log "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ swap-Ñ„Ð°Ð¹Ð»Ð° (2 Ð“Ð‘)..."
    fallocate -l 2G /swapfile
    chmod 600 /swapfile
    mkswap /swapfile
    swapon /swapfile
    echo '/swapfile none swap sw 0 0' >> /etc/fstab
fi

# === UFW + fail2ban ===
log "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° UFW Ð¸ fail2ban..."
ufw --force reset
ufw default deny incoming
ufw default allow outgoing
ufw allow 22/tcp comment "SSH"
ufw --force enable
systemctl enable --now fail2ban

# === Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Xray ===
log "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Xray-core..."
bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install

# === Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ REALITY-Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð² ===
REALITY_UUID=$(xray uuid)
REALITY_PRIVATE_KEY=$(xray x25519 | grep "Private key" | cut -d: -f2 | tr -d ' ')
REALITY_PUBLIC_KEY=$(xray x25519 | grep "Public key" | cut -d: -f2 | tr -d ' ')
REALITY_SHORT_ID=$(openssl rand -hex 4)

# === ÐšÐ¾Ð½Ñ„Ð¸Ð³ Xray (REALITY) ===
mkdir -p /usr/local/etc/xray
cat > /usr/local/etc/xray/config.json <<EOF
{
  "log": { "loglevel": "warning" },
  "inbounds": [
    {
      "port": 443,
      "protocol": "vless",
      "settings": {
        "clients": [{ "id": "$REALITY_UUID" }],
        "decryption": "none"
      },
      "streamSettings": {
        "network": "tcp",
        "security": "reality",
        "realitySettings": {
          "show": false,
          "dest": "google.com:443",
          "xver": 0,
          "serverNames": ["google.com", "www.google.com"],
          "privateKey": "$REALITY_PRIVATE_KEY",
          "shortIds": ["$REALITY_SHORT_ID"]
        }
      }
    }
  ],
  "outbounds": [{ "protocol": "freedom" }]
}
EOF

systemctl restart xray
log "âœ… Xray (REALITY) Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"

# === Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° SearXNG ===
log "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° SearXNG..."
git clone https://github.com/searxng/searxng.git /opt/searxng
cd /opt/searxng

curl -LsSf https://astral.sh/uv/install.sh | sh
export PATH="/root/.cargo/bin:$PATH"

python3 -m venv venv
source venv/bin/activate
/root/.cargo/bin/uv pip install --system -r requirements.txt

cp utils/searx/settings.yml searxng/settings.yml
sed -i 's/json_output:.*/json_output: true/' searxng/settings.yml
sed -i 's|base_url:.*|base_url: http://127.0.0.1:8888|' searxng/settings.yml
sed -i 's|port:.*|port: 8888|' searxng/settings.yml
sed -i 's|bind_address:.*|bind_address: "127.0.0.1"|' searxng/settings.yml
sed -i '/^- name: wolframalpha/s/^#//' searxng/settings.yml
sed -i '/^- name: wolframalpha/,+3 s/^#//' searxng/settings.yml

cp utils/searx/systemd/searx.service /etc/systemd/system/
systemctl daemon-reload
systemctl enable --now searx
log "âœ… SearXNG Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° http://127.0.0.1:8888"

# === Nginx: Ð·Ð°Ð³Ð»ÑƒÑˆÐºÐ° Ð½Ð° 443 ===
echo "<h1>Secure Private Stack</h1>" > /var/www/html/index.html
cat > /etc/nginx/sites-available/default <<EOF
server {
    listen 80;
    listen 443 ssl http2;
    server_name _;
    ssl_certificate /etc/ssl/certs/ssl-cert-snakeoil.pem;
    ssl_certificate_key /etc/ssl/private/ssl-cert-snakeoil.key;
    root /var/www/html;
    index index.html;
}
EOF
systemctl reload nginx

# === Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Vaultwarden ===
log "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Vaultwarden..."
DOMAIN="vaultwarden"  # Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ, Ð½Ð¾ Ð´Ð»Ñ Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼Ð¾ÑÑ‚Ð¸
DATA_DIR="/var/lib/vaultwarden"
BIN_PATH="/usr/local/bin/vaultwarden"
USER="vaultwarden"

if ! id "$USER" &>/dev/null; then
  useradd --system --shell /usr/sbin/nologin --home-dir "$DATA_DIR" "$USER"
fi

ARCH=$(uname -m)
case "$ARCH" in
  x86_64)   BIN_URL="https://github.com/dani-garcia/vaultwarden/releases/latest/download/vaultwarden-linux-x64" ;;
  aarch64)  BIN_URL="https://github.com/dani-garcia/vaultwarden/releases/latest/download/vaultwarden-linux-arm64" ;;
  *)        error "ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° $ARCH Ð½Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ" ;;
esac

mkdir -p "$DATA_DIR"
chown "$USER":"$USER" "$DATA_DIR"
curl -L "$BIN_URL" -o "$BIN_PATH"
chmod +x "$BIN_PATH"
chown root:root "$BIN_PATH"

ADMIN_TOKEN=$(openssl rand -hex 32)

cat > /etc/systemd/system/vaultwarden.service <<EOF
[Unit]
Description=Vaultwarden Server
After=network.target

[Service]
User=$USER
Group=$USER
WorkingDirectory=$DATA_DIR
ExecStart=$BIN_PATH
Environment=ROCKET_PORT=8080
Environment=ROCKET_ADDRESS=127.0.0.1
Environment=ADMIN_TOKEN=$ADMIN_TOKEN
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now vaultwarden
log "âœ… Vaultwarden Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° http://127.0.0.1:8080"

# === Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° cloudflared ===
log "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° cloudflared..."
ARCH=$(uname -m)
if [[ "$ARCH" == "x86_64" ]]; then
    DL_URL="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64"
elif [[ "$ARCH" == "aarch64" ]]; then
    DL_URL="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-arm64"
else
    error "ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° $ARCH Ð½Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ"
fi
curl -L "$DL_URL" -o /usr/local/bin/cloudflared
chmod +x /usr/local/bin/cloudflared

# === Ð¢ÑƒÐ½Ð½ÐµÐ»ÑŒ Ð´Ð»Ñ Xray (Ð¿Ð¾Ñ€Ñ‚ 443) ===
cat > /etc/systemd/system/cloudflared-xray.service <<EOF
[Unit]
Description=Cloudflare Tunnel for Xray (REALITY)
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/cloudflared tunnel --url https://localhost:443
Restart=always
RestartSec=10
User=root

[Install]
WantedBy=multi-user.target
EOF

# === Ð¢ÑƒÐ½Ð½ÐµÐ»ÑŒ Ð´Ð»Ñ Vaultwarden (Ð¿Ð¾Ñ€Ñ‚ 8080) ===
cat > /etc/systemd/system/cloudflared-vaultwarden.service <<EOF
[Unit]
Description=Cloudflare Tunnel for Vaultwarden
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/cloudflared tunnel --url http://localhost:8080
Restart=always
RestartSec=10
User=root

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now cloudflared-xray cloudflared-vaultwarden

sleep 15

# === ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ URL Ð¸Ð· Ð¶ÑƒÑ€Ð½Ð°Ð»Ð¾Ð² ===
XRAY_URL=$(journalctl -u cloudflared-xray -n 60 2>/dev/null | grep -o 'https://[a-z0-9-]*\.trycloudflare\.com' | head -1 || echo "Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½")
VAULTWARDEN_URL=$(journalctl -u cloudflared-vaultwarden -n 60 2>/dev/null | grep -o 'https://[a-z0-9-]*\.trycloudflare\.com' | head -1 || echo "Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½")

# === Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÑÑÑ‹Ð»Ð¾Ðº Ð¸ QR ===
REALITY_LINK="vless://$REALITY_UUID@$XRAY_URL:443?encryption=none&security=reality&fp=chrome&pbk=$REALITY_PUBLIC_KEY&sid=$REALITY_SHORT_ID&sni=google.com&type=tcp#PrivateStack-REALITY"

cat > /usr/local/bin/mainuser <<EOF
#!/bin/bash
REALITY_UUID=\$(jq -r '.inbounds[0].settings.clients[0].id' /usr/local/etc/xray/config.json)
REALITY_PUBLIC_KEY=\$(jq -r '.inbounds[0].streamSettings.realitySettings.publicKey // "'$REALITY_PUBLIC_KEY'"' /usr/local/etc/xray/config.json)
REALITY_SHORT_ID=\$(jq -r '.inbounds[0].streamSettings.realitySettings.shortIds[0]' /usr/local/etc/xray/config.json)
XRAY_URL=\$(journalctl -u cloudflared-xray -n 60 | grep -o 'https://[a-z0-9-]*\.trycloudflare\.com' | head -1)

if [[ -z "\$XRAY_URL" ]]; then
  echo "âš ï¸  URL Xray Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ: systemctl restart cloudflared-xray"
  exit 1
fi

LINK="vless://\$REALITY_UUID@\$XRAY_URL:443?encryption=none&security=reality&fp=chrome&pbk=\$REALITY_PUBLIC_KEY&sid=\$REALITY_SHORT_ID&sni=google.com&type=tcp#PrivateStack-REALITY"

echo "ðŸ”— Xray REALITY:"
echo "\$LINK"
echo
echo "ðŸ“± QR-ÐºÐ¾Ð´:"
echo "\$LINK" | qrencode -t ansiutf8
EOF
chmod +x /usr/local/bin/mainuser

cat > /usr/local/bin/vw-url <<EOF
#!/bin/bash
URL=\$(journalctl -u cloudflared-vaultwarden -n 60 | grep -o 'https://[a-z0-9-]*\.trycloudflare\.com' | head -1)
if [[ -z "\$URL" ]]; then
  echo "âš ï¸  URL Vaultwarden Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ: systemctl restart cloudflared-vaultwarden"
  exit 1
fi
echo "ðŸ”— Vaultwarden: \$URL"
echo
echo "ðŸ“± QR-ÐºÐ¾Ð´:"
echo "\$URL" | qrencode -t ansiutf8
EOF
chmod +x /usr/local/bin/vw-url

# === Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ===
cat > /usr/local/bin/private-stack-update <<'EOF'
#!/bin/bash
set -e
log() { echo -e "\033[0;32m[+]\033[0m $1"; }

log "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Xray..."
bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install

log "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ SearXNG..."
cd /opt/searxng && git pull
source venv/bin/activate
/root/.cargo/bin/uv pip install --system -r requirements.txt
systemctl restart searx

log "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Vaultwarden..."
ARCH=$(uname -m)
if [[ "$ARCH" == "x86_64" ]]; then
    DL_URL="https://github.com/dani-garcia/vaultwarden/releases/latest/download/vaultwarden-linux-x64"
elif [[ "$ARCH" == "aarch64" ]]; then
    DL_URL="https://github.com/dani-garcia/vaultwarden/releases/latest/download/vaultwarden-linux-arm64"
fi
curl -L "$DL_URL" -o /usr/local/bin/vaultwarden
chmod +x /usr/local/bin/vaultwarden
systemctl restart vaultwarden

log "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ cloudflared..."
ARCH=$(uname -m)
if [[ "$ARCH" == "x86_64" ]]; then
    DL_URL="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64"
elif [[ "$ARCH" == "aarch64" ]]; then
    DL_URL="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-arm64"
fi
curl -L "$DL_URL" -o /usr/local/bin/cloudflared
chmod +x /usr/local/bin/cloudflared
systemctl restart cloudflared-xray cloudflared-vaultwarden

log "âœ… Ð’ÑÐµ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹!"
EOF
chmod +x /usr/local/bin/private-stack-update

# === Ð¤Ð¸Ð½Ð°Ð» ===
echo
echo "ðŸŽ‰ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
echo
echo "ðŸ”— Xray REALITY (Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° iOS/macOS/Android/Windows):"
echo "$REALITY_LINK"
echo
echo "ðŸ“± QR-ÐºÐ¾Ð´ Xray:"
echo "$REALITY_LINK" | qrencode -t ansiutf8
echo
echo "ðŸ”— Vaultwarden (Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€ Ð¿Ð°Ñ€Ð¾Ð»ÐµÐ¹): $VAULTWARDEN_URL"
echo
echo "ðŸ“± QR-ÐºÐ¾Ð´ Vaultwarden:"
echo "$VAULTWARDEN_URL" | qrencode -t ansiutf8
echo
echo "ðŸ’¡ ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
echo "   - Ð¡ÑÑ‹Ð»ÐºÐ° Xray: mainuser"
echo "   - Ð¡ÑÑ‹Ð»ÐºÐ° Vaultwarden: vw-url"
echo "   - ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ: private-stack-update"
echo "   - SearXNG: Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡ÐµÑ€ÐµÐ· Ð¿Ñ€Ð¾ÐºÑÐ¸ (127.0.0.1:8888)"
