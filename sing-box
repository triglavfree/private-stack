#!/bin/bash
set -e
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}–ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ—Ç root.${NC}"
   exit 1
fi

create_swap_if_needed() {
    TOTAL_MEM_KB=$(grep MemTotal /proc/meminfo | awk '{print $2}')
    TOTAL_MEM_GB=$((TOTAL_MEM_KB / 1024 / 1024))
    if [ "$TOTAL_MEM_GB" -le 1 ]; then
        if ! swapon --show | grep -q '/swapfile'; then
            echo -e "${GREEN}–°–æ–∑–¥–∞–Ω–∏–µ swap-—Ñ–∞–π–ª–∞ 2 –ì–ë...${NC}"
            fallocate -l 2G /swapfile || dd if=/dev/zero of=/swapfile bs=1M count=2048
            chmod 600 /swapfile
            mkswap /swapfile
            swapon /swapfile
            echo '/swapfile none swap sw 0 0' >> /etc/fstab
            echo 'vm.swappiness=10' >> /etc/sysctl.conf
            echo 'vm.vfs_cache_pressure=50' >> /etc/sysctl.conf
            sysctl -p >/dev/null 2>&1
            echo -e "${GREEN}Swap —Å–æ–∑–¥–∞–Ω.${NC}"
        fi
    fi
}
create_swap_if_needed

echo -e "${GREEN}–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã...${NC}"
apt update && apt upgrade -y
apt install -y curl wget gnupg net-tools qrencode jq uuid-runtime

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ufw (—Ç–æ–ª—å–∫–æ 443)
echo -e "${GREEN}–ù–∞—Å—Ç—Ä–æ–π–∫–∞ ufw...${NC}"
apt install -y ufw
ufw allow 443/tcp
ufw --force enable

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ sing-box
echo -e "${GREEN}–£—Å—Ç–∞–Ω–æ–≤–∫–∞ sing-box...${NC}"
LATEST=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | jq -r ".tag_name")
ARCH=$(dpkg --print-architecture)
case "$ARCH" in
  amd64) SUFFIX="linux-amd64" ;;
  arm64) SUFFIX="linux-arm64" ;;
  *) echo -e "${RED}–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.${NC}"; exit 1 ;;
esac
URL="https://github.com/SagerNet/sing-box/releases/download/${LATEST}/sing-box-${LATEST#v}-${SUFFIX}.tar.gz"
curl -L "$URL" | tar xz -C /tmp
mv "/tmp/sing-box-${LATEST#v}-${SUFFIX}/sing-box" /usr/local/bin/sing-box
rm -rf "/tmp/sing-box-${LATEST#v}-${SUFFIX}"
chmod +x /usr/local/bin/sing-box

if ! command -v sing-box &> /dev/null; then
    echo -e "${RED}–û—à–∏–±–∫–∞: sing-box –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.${NC}"
    exit 1
fi

cat > /etc/systemd/system/sing-box.service <<'EOF'
[Unit]
Description=sing-box service
After=network.target
[Service]
ExecStart=/usr/local/bin/sing-box run -c /usr/local/etc/sing-box/config.json
Restart=on-failure
RestartSec=5
User=root
[Install]
WantedBy=multi-user.target
EOF

IP=$(curl -4 -s icanhazip.com)
UUID=$(uuidgen)
KEYPAIR=$(sing-box x25519)
REALITY_PRIV_KEY=$(echo "$KEYPAIR" | awk '/^private key:/ {print $3}')
REALITY_PUB_KEY=$(echo "$KEYPAIR" | awk '/^public key:/ {print $3}')
SHORT_ID=$(openssl rand -hex 4)

mkdir -p /usr/local/etc/sing-box
cat > /usr/local/etc/sing-box/.keys <<EOF
uuid: $UUID
private key: $REALITY_PRIV_KEY
public key: $REALITY_PUB_KEY
shortsid: $SHORT_ID
EOF

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å www.cloudflare.com
cat > /usr/local/etc/sing-box/config.json <<EOF
{
  "log": {"level": "warn"},
  "dns": {
    "servers": [{"tag": "cloudflare", "address": "https://1.1.1.1/dns-query"}]
  },
  "inbounds": [{
    "type": "vless",
    "listen": "::",
    "listen_port": 443,
    "users": [{"uuid": "$UUID", "flow": "xtls-rprx-vision"}],
    "tls": {
      "enabled": true,
      "server_name": "www.cloudflare.com",
      "reality": {
        "enabled": true,
        "private_key": "$REALITY_PRIV_KEY",
        "short_ids": ["$SHORT_ID"]
      }
    },
    "transport": {"type": "tcp"}
  }],
  "outbounds": [
    {"type": "direct", "tag": "direct", "domain_strategy": "prefer_ipv4"},
    {"type": "dns", "tag": "dns-out"}
  ],
  "route": {
    "rules": [{"protocol": "dns", "outbound": "dns-out"}],
    "final": "direct"
  }
}
EOF

systemctl daemon-reload
systemctl enable --now sing-box

# –£—Ç–∏–ª–∏—Ç—ã (listuser, adduser, rmuser, sharelink, update, mainuser)
# ... (–∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∫–∞–∫ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Å–∫—Ä–∏–ø—Ç–µ)

cat > $HOME/help <<'EOF'
–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
  mainuser    ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Å—Å—ã–ª–∫—É –∏ QR –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  listuser    ‚Äî —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
  adduser     ‚Äî —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  rmuser      ‚Äî —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  sharelink   ‚Äî –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –ø–æ –Ω–æ–º–µ—Ä—É
  update      ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å —è–¥—Ä–æ
EOF

# === –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ ===
mkdir -p /etc/systemd/journald.conf.d
cat > /etc/systemd/journald.conf.d/00-volatile.conf <<EOF
[Journal]
Storage=volatile
RuntimeMaxUse=32M
EOF
systemctl restart systemd-journald
journalctl --vacuum-time=1s --quiet
for log in /var/log/auth.log /var/log/syslog /var/log/kern.log /var/log/messages; do
    [[ -f "$log" ]] && shred -n 1 -z -u "$log" 2>/dev/null && touch "$log" && chmod 640 "$log"
done
systemctl restart rsyslog

# –§–∏–Ω–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥
clear
echo -e "${GREEN}‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ sing-box (REALITY + Vision) –∑–∞–≤–µ—Ä—à–µ–Ω–∞!${NC}"

UUID=$(awk -F': ' '/uuid/ {print $2}' /usr/local/etc/sing-box/.keys)
PBK=$(awk -F': ' '/public key/ {print $2}' /usr/local/etc/sing-box/.keys)
SID=$(awk -F': ' '/shortsid/ {print $2}' /usr/local/etc/sing-box/.keys)
IP=$(curl -4 -s icanhazip.com)

if [[ -n "$IP" ]]; then
    LINK="vless://$UUID@$IP:443?security=reality&sni=www.cloudflare.com&fp=firefox&pbk=$PBK&sid=$SID&spx=/&type=tcp&flow=xtls-rprx-vision&encryption=none#main"
    echo "–°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:"
    echo
    echo "$LINK"
    echo
    echo "QR-–∫–æ–¥:"
    echo "$LINK" | qrencode -t ansiutf8
fi

echo
echo -e "${GREEN} –í–≤–µ–¥–∏—Ç–µ cat help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥${NC}"
echo -e "${YELLOW}üí° –í–∫–ª—é—á–∏—Ç–µ ¬´Use Remote DNS¬ª –≤ –∫–ª–∏–µ–Ω—Ç–µ (Hiddify) –∏ —Ä–µ–∂–∏–º VPN!${NC}"
