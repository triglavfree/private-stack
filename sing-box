#!/bin/bash
set -e
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð¾Ñ‚ root.${NC}"
   exit 1
fi

create_swap_if_needed() {
    TOTAL_MEM_KB=$(grep MemTotal /proc/meminfo | awk '{print $2}')
    TOTAL_MEM_GB=$((TOTAL_MEM_KB / 1024 / 1024))
    if [ "$TOTAL_MEM_GB" -le 1 ]; then
        if ! swapon --show | grep -q '/swapfile'; then
            echo -e "${GREEN}Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ swap-Ñ„Ð°Ð¹Ð»Ð° 2 Ð“Ð‘ (RAM â‰¤ 1 Ð“Ð‘)...${NC}"
            fallocate -l 2G /swapfile || dd if=/dev/zero of=/swapfile bs=1M count=2048
            chmod 600 /swapfile
            mkswap /swapfile
            swapon /swapfile
            echo '/swapfile none swap sw 0 0' >> /etc/fstab
            echo 'vm.swappiness=10' >> /etc/sysctl.conf
            echo 'vm.vfs_cache_pressure=50' >> /etc/sysctl.conf
            sysctl -p >/dev/null 2>&1
            echo -e "${GREEN}Swap ÑÐ¾Ð·Ð´Ð°Ð½.${NC}"
        fi
    fi
}
create_swap_if_needed

echo -e "${GREEN}ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹...${NC}"
apt update && apt upgrade -y
apt install -y curl wget gnupg net-tools qrencode jq uuid-runtime

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° sing-box
echo -e "${GREEN}Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° sing-box...${NC}"
LATEST=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | jq -r ".tag_name")
ARCH=$(dpkg --print-architecture)
case "$ARCH" in
  amd64) SUFFIX="linux-amd64" ;;
  arm64) SUFFIX="linux-arm64" ;;
  *) echo -e "${RED}ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° $ARCH Ð½Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ.${NC}"; exit 1 ;;
esac
URL="https://github.com/SagerNet/sing-box/releases/download/${LATEST}/sing-box-${LATEST#v}-${SUFFIX}.tar.gz"
curl -L "$URL" | tar xz -C /tmp
mv "/tmp/sing-box-${LATEST#v}-${SUFFIX}/sing-box" /usr/local/bin/sing-box
rm -rf "/tmp/sing-box-${LATEST#v}-${SUFFIX}"
chmod +x /usr/local/bin/sing-box

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸
if ! command -v sing-box &> /dev/null; then
    echo -e "${RED}ÐžÑˆÐ¸Ð±ÐºÐ°: sing-box Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½.${NC}"
    exit 1
fi

# systemd
cat > /etc/systemd/system/sing-box.service <<'EOF'
[Unit]
Description=sing-box service
After=network.target
[Service]
ExecStart=/usr/local/bin/sing-box run -c /usr/local/etc/sing-box/config.json
Restart=on-failure
RestartSec=5
User=root
[Install]
WantedBy=multi-user.target
EOF

IP=$(curl -4 -s icanhazip.com)
UUID=$(uuidgen)

# Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÐºÐ»ÑŽÑ‡ÐµÐ¹ ÐžÐ”Ð˜Ð Ñ€Ð°Ð·
KEYPAIR=$(sing-box x25519)
REALITY_PRIV_KEY=$(echo "$KEYPAIR" | awk '/^private key:/ {print $3}')
REALITY_PUB_KEY=$(echo "$KEYPAIR" | awk '/^public key:/ {print $3}')
SHORT_ID=$(openssl rand -hex 4)

mkdir -p /usr/local/etc/sing-box
cat > /usr/local/etc/sing-box/.keys <<EOF
uuid: $UUID
private key: $REALITY_PRIV_KEY
public key: $REALITY_PUB_KEY
shortsid: $SHORT_ID
EOF

# ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ñ DoH Cloudflare
cat > /usr/local/etc/sing-box/config.json <<EOF
{
  "log": {
    "level": "warn"
  },
  "dns": {
    "servers": [
      {
        "tag": "cloudflare",
        "address": "https://1.1.1.1/dns-query"
      }
    ]
  },
  "inbounds": [
    {
      "type": "vless",
      "listen": "::",
      "listen_port": 443,
      "users": [
        {
          "uuid": "$UUID",
          "flow": "xtls-rprx-vision"
        }
      ],
      "tls": {
        "enabled": true,
        "server_name": "icloud.com",
        "reality": {
          "enabled": true,
          "private_key": "$REALITY_PRIV_KEY",
          "short_ids": ["$SHORT_ID"]
        }
      },
      "transport": {
        "type": "tcp"
      }
    }
  ],
  "outbounds": [
    {
      "type": "direct",
      "tag": "direct",
      "domain_strategy": "prefer_ipv4"
    },
    {
      "type": "dns",
      "tag": "dns-out"
    }
  ],
  "route": {
    "rules": [
      {
        "protocol": "dns",
        "outbound": "dns-out"
      }
    ],
    "final": "direct"
  }
}
EOF

systemctl daemon-reload
systemctl enable --now sing-box

# Ð£Ñ‚Ð¸Ð»Ð¸Ñ‚Ñ‹
cat > /usr/local/bin/listuser <<'EOF'
#!/bin/bash
uuids=($(jq -r '.inbounds[0].users[].uuid' "/usr/local/etc/sing-box/config.json"))
if [[ ${#uuids[@]} -eq 0 ]]; then
    echo "Ð¡Ð¿Ð¸ÑÐ¾Ðº ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð² Ð¿ÑƒÑÑ‚"
    exit 1
fi
echo "ÐšÐ»Ð¸ÐµÐ½Ñ‚Ñ‹ (Ð¿Ð¾ UUID):"
for i in "${!uuids[@]}"; do
    echo "$((i+1)). ${uuids[$i]}"
done
EOF
chmod +x /usr/local/bin/listuser

cat > /usr/local/bin/mainuser <<'EOF'
#!/bin/bash
uuid=$(awk -F': ' '/uuid/ {print $2}' /usr/local/etc/sing-box/.keys)
pbk=$(awk -F': ' '/public key/ {print $2}' /usr/local/etc/sing-box/.keys)
sid=$(awk -F': ' '/shortsid/ {print $2}' /usr/local/etc/sing-box/.keys)
ip=$(timeout 3 curl -4 -s icanhazip.com)
link="vless://$uuid@$ip:443?security=reality&sni=icloud.com&fp=firefox&pbk=$pbk&sid=$sid&spx=/&type=tcp&flow=xtls-rprx-vision&encryption=none#vless-$ip"
echo ""
echo "Ð¡ÑÑ‹Ð»ÐºÐ° Ð´Ð»Ñ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ:"
echo "$link"
echo ""
echo "QR-ÐºÐ¾Ð´:"
echo "$link" | qrencode -t ansiutf8
EOF
chmod +x /usr/local/bin/mainuser

# === Ð˜Ð—ÐœÐ•ÐÐ•ÐÐž: newuser â†’ adduser ===
cat > /usr/local/bin/adduser <<'EOF'
#!/bin/bash
read -p "Email (Ð´Ð»Ñ Ð¼ÐµÑ‚ÐºÐ¸): " email
if [[ -z "$email" ]]; then echo "Email Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼"; exit 1; fi
if jq -e --arg e "$email" '.inbounds[0].users[] | select(.email == $e)' /usr/local/etc/sing-box/config.json >/dev/null 2>&1; then
    echo "Ð£Ð¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
    exit 1
fi
uuid=$(uuidgen)
jq --arg e "$email" --arg u "$uuid" '.inbounds[0].users += [{"uuid": $u, "flow": "xtls-rprx-vision", "email": $e}]' /usr/local/etc/sing-box/config.json > /tmp/x.json && mv /tmp/x.json /usr/local/etc/sing-box/config.json
systemctl restart sing-box
pbk=$(awk -F': ' '/public key/ {print $2}' /usr/local/etc/sing-box/.keys)
sid=$(awk -F': ' '/shortsid/ {print $2}' /usr/local/etc/sing-box/.keys)
ip=$(curl -4 -s icanhazip.com)
link="vless://$uuid@$ip:443?security=reality&sni=icloud.com&fp=firefox&pbk=$pbk&sid=$sid&spx=/&type=tcp&flow=xtls-rprx-vision&encryption=none#$email"
echo
echo "Ð¡ÑÑ‹Ð»ÐºÐ°:"
echo "$link"
echo
echo "QR:"
echo "$link" | qrencode -t ansiutf8
EOF
chmod +x /usr/local/bin/adduser

cat > /usr/local/bin/rmuser <<'EOF'
#!/bin/bash
emails=($(jq -r '.inbounds[0].users[].email // "Ð±ÐµÐ· email"' "/usr/local/etc/sing-box/config.json"))
if [[ ${#emails[@]} -eq 0 ]]; then echo "ÐÐµÑ‚ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð²"; exit 1; fi
for i in "${!emails[@]}"; do echo "$((i+1)). ${emails[$i]}"; done
read -p "ÐÐ¾Ð¼ÐµÑ€ Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ: " n
if ! [[ "$n" =~ ^[0-9]+$ ]] || (( n < 1 || n > ${#emails[@]} )); then echo "ÐžÑˆÐ¸Ð±ÐºÐ°"; exit 1; fi
jq --argjson idx $((n-1)) '(.inbounds[0].users) |= del(.[\$idx])' /usr/local/etc/sing-box/config.json > /tmp/x.json && mv /tmp/x.json /usr/local/etc/sing-box/config.json
systemctl restart sing-box
echo "ÐšÐ»Ð¸ÐµÐ½Ñ‚ ÑƒÐ´Ð°Ð»Ñ‘Ð½."
EOF
chmod +x /usr/local/bin/rmuser

cat > /usr/local/bin/sharelink <<'EOF'
#!/bin/bash
emails=($(jq -r '.inbounds[0].users[].email // "Ð±ÐµÐ· email"' "/usr/local/etc/sing-box/config.json"))
if [[ ${#emails[@]} -eq 0 ]]; then echo "ÐÐµÑ‚ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð²"; exit 1; fi
for i in "${!emails[@]}"; do echo "$((i+1)). ${emails[$i]}"; done
read -p "Ð’Ñ‹Ð±Ð¾Ñ€: " n
if ! [[ "$n" =~ ^[0-9]+$ ]] || (( n < 1 || n > ${#emails[@]} )); then echo "ÐžÑˆÐ¸Ð±ÐºÐ°"; exit 1; fi
index=$((n-1))
uuid=$(jq -r ".inbounds[0].users[$index].uuid" /usr/local/etc/sing-box/config.json)
pbk=$(awk -F': ' '/public key/ {print $2}' /usr/local/etc/sing-box/.keys)
sid=$(awk -F': ' '/shortsid/ {print $2}' /usr/local/etc/sing-box/.keys)
ip=$(curl -4 -s icanhazip.com)
link="vless://$uuid@$ip:443?security=reality&sni=icloud.com&fp=firefox&pbk=$pbk&sid=$sid&spx=/&type=tcp&flow=xtls-rprx-vision&encryption=none#user-$n"
echo
echo "Ð¡ÑÑ‹Ð»ÐºÐ°:"
echo "$link"
echo
echo "QR:"
echo "$link" | qrencode -t ansiutf8
EOF
chmod +x /usr/local/bin/sharelink

cat > /usr/local/bin/update <<'EOF'
#!/bin/bash
echo "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ sing-box..."
LATEST=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | jq -r ".tag_name")
ARCH=$(dpkg --print-architecture)
case "$ARCH" in
  amd64) SUFFIX="linux-amd64" ;;
  arm64) SUFFIX="linux-arm64" ;;
  *) echo "ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° Ð½Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ"; exit 1 ;;
esac
URL="https://github.com/SagerNet/sing-box/releases/download/${LATEST}/sing-box-${LATEST#v}-${SUFFIX}.tar.gz"
curl -L "$URL" | tar xz -C /tmp
mv "/tmp/sing-box-${LATEST#v}-${SUFFIX}/sing-box" /usr/local/bin/sing-box
rm -rf "/tmp/sing-box-${LATEST#v}-${SUFFIX}"
chmod +x /usr/local/bin/sing-box
systemctl restart sing-box
echo "Ð“Ð¾Ñ‚Ð¾Ð²Ð¾."
EOF
chmod +x /usr/local/bin/update

cat > $HOME/help <<'EOF'
Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:
  mainuser    â€” Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑÑ‹Ð»ÐºÑƒ Ð¸ QR Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  listuser    â€” ÑÐ¿Ð¸ÑÐ¾Ðº Ð²ÑÐµÑ… ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð²
  adduser     â€” ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  rmuser      â€” ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  sharelink   â€” Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÑÑ‹Ð»ÐºÑƒ Ð¿Ð¾ Ð½Ð¾Ð¼ÐµÑ€Ñƒ
  update      â€” Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ´Ñ€Ð¾
EOF
clear
LINK=$(mainuser)
echo -e "${GREEN}âœ… Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° sing-box (REALITY + Vision) Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!${NC}"
echo
echo "Ð¡ÑÑ‹Ð»ÐºÐ° Ð´Ð»Ñ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ:"
echo "$LINK"
echo
echo "QR-ÐºÐ¾Ð´:"
echo "$LINK" | qrencode -t ansiutf8
echo
echo -e "${RED}cat help"
echo -e "${YELLOW}ðŸ’¡ Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ Â«Ñ€ÐµÐ¶Ð¸Ð¼ VPNÂ» Ð¸ Â«Use Remote DNSÂ» Ð² ÐºÐ»Ð¸ÐµÐ½Ñ‚Ðµ (Hiddify Ð¸ Ð´Ñ€.).${NC}"
