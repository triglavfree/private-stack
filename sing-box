#!/bin/bash
set -e
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð¾Ñ‚ root.${NC}"
   exit 1
fi

create_swap_if_needed() {
    TOTAL_MEM_KB=$(grep MemTotal /proc/meminfo | awk '{print $2}')
    TOTAL_MEM_GB=$((TOTAL_MEM_KB / 1024 / 1024))
    if [ "$TOTAL_MEM_GB" -le 1 ]; then
        if ! swapon --show | grep -q '/swapfile'; then
            echo -e "${GREEN}Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ swap-Ñ„Ð°Ð¹Ð»Ð° 2 Ð“Ð‘...${NC}"
            fallocate -l 2G /swapfile || dd if=/dev/zero of=/swapfile bs=1M count=2048
            chmod 600 /swapfile
            mkswap /swapfile
            swapon /swapfile
            echo '/swapfile none swap sw 0 0' >> /etc/fstab
            echo 'vm.swappiness=10' >> /etc/sysctl.conf
            echo 'vm.vfs_cache_pressure=50' >> /etc/sysctl.conf
            sysctl -p >/dev/null 2>&1
            echo -e "${GREEN}Swap ÑÐ¾Ð·Ð´Ð°Ð½.${NC}"
        fi
    fi
}

create_swap_if_needed

echo -e "${GREEN}ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹...${NC}"
apt update && apt upgrade -y
apt install -y curl wget gnupg qrencode jq uuid-runtime

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ufw (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ 443)
echo -e "${GREEN}ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ufw...${NC}"
apt install -y ufw
ufw allow 443/tcp
ufw --force enable

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° sing-box
echo -e "${GREEN}Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° sing-box...${NC}"
LATEST=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | jq -r ".tag_name")
ARCH=$(dpkg --print-architecture)
case "$ARCH" in
  amd64) SUFFIX="linux-amd64" ;;
  arm64) SUFFIX="linux-arm64" ;;
  *) echo -e "${RED}ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° Ð½Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ.${NC}"; exit 1 ;;
esac
URL="https://github.com/SagerNet/sing-box/releases/download/${LATEST}/sing-box-${LATEST#v}-${SUFFIX}.tar.gz"
curl -L "$URL" | tar xz -C /tmp
mv "/tmp/sing-box-${LATEST#v}-${SUFFIX}/sing-box" /usr/local/bin/sing-box
rm -rf "/tmp/sing-box-${LATEST#v}-${SUFFIX}"
chmod +x /usr/local/bin/sing-box

if ! command -v sing-box &> /dev/null; then
    echo -e "${RED}ÐžÑˆÐ¸Ð±ÐºÐ°: sing-box Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½.${NC}"
    exit 1
fi

cat > /etc/systemd/system/sing-box.service <<'EOF'
[Unit]
Description=sing-box service
After=network.target
[Service]
ExecStart=/usr/local/bin/sing-box run -c /usr/local/etc/sing-box/config.json
Restart=on-failure
RestartSec=5
User=root
[Install]
WantedBy=multi-user.target
EOF

IP=$(curl -4 -s icanhazip.com)
UUID=$(uuidgen)
KEYPAIR=$(sing-box x25519)
REALITY_PRIV_KEY=$(echo "$KEYPAIR" | awk '/^private key:/ {print $3}')
REALITY_PUB_KEY=$(echo "$KEYPAIR" | awk '/^public key:/ {print $3}')
SHORT_ID=$(openssl rand -hex 4)

mkdir -p /usr/local/etc/sing-box

# Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
cat > /usr/local/etc/sing-box/.users <<EOF
main:$UUID:$SHORT_ID
EOF

cat > /usr/local/etc/sing-box/.keys <<EOF
uuid: $UUID
private key: $REALITY_PRIV_KEY
public key: $REALITY_PUB_KEY
shortsid: $SHORT_ID
EOF

cat > /usr/local/etc/sing-box/config.json <<EOF
{
  "log": {"level": "warn"},
  "dns": {
    "servers": [{"tag": "cloudflare", "address": "https://1.1.1.1/dns-query"}]
  },
  "inbounds": [{
    "type": "vless",
    "listen": "::",
    "listen_port": 443,
    "users": [{"uuid": "$UUID", "flow": "xtls-rprx-vision"}],
    "tls": {
      "enabled": true,
      "server_name": "www.cloudflare.com",
      "reality": {
        "enabled": true,
        "private_key": "$REALITY_PRIV_KEY",
        "short_ids": ["$SHORT_ID"]
      }
    },
    "transport": {"type": "tcp"}
  }],
  "outbounds": [
    {"type": "direct", "tag": "direct", "domain_strategy": "prefer_ipv4"},
    {"type": "dns", "tag": "dns-out"}
  ],
  "route": {
    "rules": [{"protocol": "dns", "outbound": "dns-out"}],
    "final": "direct"
  }
}
EOF

systemctl daemon-reload
systemctl enable --now sing-box

# === ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼Ð¸ ===

cat > /usr/local/bin/listuser <<'EOF'
#!/bin/bash
FILE="/usr/local/etc/sing-box/.users"
if [[ ! -f "$FILE" ]] || [[ ! -s "$FILE" ]]; then
    echo "ÐÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹."
else
    echo "Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹:"
    awk -F: '{print NR ". " $1 " (UUID: " $2 ")"}' "$FILE"
fi
EOF

cat > /usr/local/bin/adduser <<'EOF'
#!/bin/bash
set -e
CONF_DIR="/usr/local/etc/sing-box"
USERS="$CONF_DIR/.users"

read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¸Ð¼Ñ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ (Ð±ÐµÐ· Ð¿Ñ€Ð¾Ð±ÐµÐ»Ð¾Ð²): " name
if [[ -z "$name" ]]; then
    echo "âŒ Ð˜Ð¼Ñ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼."
    exit 1
fi

if grep -q "^$name:" "$USERS" 2>/dev/null; then
    echo "âŒ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ '$name' ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚."
    exit 1
fi

uuid=$(uuidgen)
shortid=$(openssl rand -hex 4)

echo "$name:$uuid:$shortid" >> "$USERS"

jq --argjson users "$(awk -F: '{
    printf (NR==1 ? "[" : ",") "{\\"uuid\\":\\"" $2 "\\", \\"flow\\":\\"xtls-rprx-vision\\"}"
} END { print "]" }' "$USERS")" \
'.inbounds[0].users = $users' \
"$CONF_DIR/config.json" > /tmp/config.tmp && mv /tmp/config.tmp "$CONF_DIR/config.json"

systemctl restart sing-box
echo "âœ… ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ '$name' Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½."
/usr/local/bin/sharelink_by_name "$name"
EOF

cat > /usr/local/bin/rmuser <<'EOF'
#!/bin/bash
CONF_DIR="/usr/local/etc/sing-box"
USERS="$CONF_DIR/.users"

if [[ ! -s "$USERS" ]]; then
    echo "ÐÐµÑ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ."
    exit 1
fi

echo "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ:"
awk -F: '{print NR ". " $1}' "$USERS"
read -p "ÐÐ¾Ð¼ÐµÑ€: " num
total=$(wc -l < "$USERS")
if ! [[ "$num" =~ ^[0-9]+$ ]] || (( num < 1 || num > total )); then
    echo "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð½Ð¾Ð¼ÐµÑ€."
    exit 1
fi

name=$(sed -n "${num}p" "$USERS" | cut -d: -f1)
sed -i "${num}d" "$USERS"

if [[ ! -s "$USERS" ]]; then
    echo "âš ï¸ ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÐ´Ð°Ð»Ñ‘Ð½. Ð¡ÐµÑ€Ð²ÐµÑ€ Ð½Ðµ Ð±ÑƒÐ´ÐµÑ‚ Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°Ñ‚ÑŒ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ!"
    jq '.inbounds[0].users = []' "$CONF_DIR/config.json" > /tmp/config.tmp && mv /tmp/config.tmp "$CONF_DIR/config.json"
else
    jq --argjson users "$(awk -F: '{
        printf (NR==1 ? "[" : ",") "{\\"uuid\\":\\"" $2 "\\", \\"flow\\":\\"xtls-rprx-vision\\"}"
    } END { print "]" }' "$USERS")" \
    '.inbounds[0].users = $users' \
    "$CONF_DIR/config.json" > /tmp/config.tmp && mv /tmp/config.tmp "$CONF_DIR/config.json"
fi

systemctl restart sing-box
echo "âœ… ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ '$name' ÑƒÐ´Ð°Ð»Ñ‘Ð½."
EOF

cat > /usr/local/bin/sharelink_by_name <<'EOF'
#!/bin/bash
name="$1"
if [[ -z "$name" ]]; then
    echo "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: $0 <Ð¸Ð¼Ñ_Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ>"
    exit 1
fi

CONF_DIR="/usr/local/etc/sing-box"
line=$(grep "^$name:" "$CONF_DIR/.users")
if [[ -z "$line" ]]; then
    echo "âŒ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ '$name' Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½."
    exit 1
fi

uuid=$(echo "$line" | cut -d: -f2)
sid=$(echo "$line" | cut -d: -f3)
pbk=$(awk -F': ' '/public key:/ {print $2}' "$CONF_DIR/.keys")
ip=$(curl -4 -s icanhazip.com)
sni="www.cloudflare.com"

link="vless://$uuid@$ip:443?security=reality&sni=$sni&fp=firefox&pbk=$pbk&sid=$sid&spx=/&type=tcp&flow=xtls-rprx-vision&encryption=none#$name"
echo
echo "ðŸ”— Ð¡ÑÑ‹Ð»ÐºÐ° Ð´Ð»Ñ '$name':"
echo "$link"
echo
echo "QR-ÐºÐ¾Ð´:"
echo "$link" | qrencode -t ansiutf8
EOF

cat > /usr/local/bin/sharelink <<'EOF'
#!/bin/bash
CONF_DIR="/usr/local/etc/sing-box"
USERS="$CONF_DIR/.users"

if [[ ! -s "$USERS" ]]; then
    echo "ÐÐµÑ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹."
    exit 1
fi

echo "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:"
awk -F: '{print NR ". " $1}' "$USERS"
read -p "ÐÐ¾Ð¼ÐµÑ€: " num
total=$(wc -l < "$USERS")
if ! [[ "$num" =~ ^[0-9]+$ ]] || (( num < 1 || num > total )); then
    echo "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð½Ð¾Ð¼ÐµÑ€."
    exit 1
fi

name=$(sed -n "${num}p" "$USERS" | cut -d: -f1)
/usr/local/bin/sharelink_by_name "$name"
EOF

cat > /usr/local/bin/mainuser <<'EOF'
#!/bin/bash
/usr/local/bin/sharelink_by_name "main"
EOF

cat > /usr/local/bin/update <<'EOF'
#!/bin/bash
echo "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ sing-box..."
LATEST=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | jq -r ".tag_name")
ARCH=$(dpkg --print-architecture)
case "$ARCH" in
  amd64) SUFFIX="linux-amd64" ;;
  arm64) SUFFIX="linux-arm64" ;;
  *) echo "ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° Ð½Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ."; exit 1 ;;
esac
URL="https://github.com/SagerNet/sing-box/releases/download/${LATEST}/sing-box-${LATEST#v}-${SUFFIX}.tar.gz"
curl -L "$URL" | tar xz -C /tmp
mv "/tmp/sing-box-${LATEST#v}-${SUFFIX}/sing-box" /usr/local/bin/sing-box
rm -rf "/tmp/sing-box-${LATEST#v}-${SUFFIX}"
systemctl restart sing-box
echo "âœ… sing-box Ð¾Ð±Ð½Ð¾Ð²Ð»Ñ‘Ð½."
EOF

chmod +x /usr/local/bin/{listuser,adduser,rmuser,sharelink,mainuser,update,sharelink_by_name}

# === openssh ===
cat > /usr/local/bin/openssh <<'EOF'
#!/bin/bash
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'
echo -e "${YELLOW}ðŸ”’ ÐŸÐ¾Ñ€Ñ‚ 22 Ð·Ð°ÐºÑ€Ñ‹Ñ‚ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Ð´Ð»Ñ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸.${NC}"
echo
echo -e "${YELLOW}âš ï¸  Ð’ÐÐ–ÐÐž: Ð½ÑƒÐ¶Ð½Ð¾ ÑƒÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¸Ð¼ÐµÐ½Ð½Ð¾ Ð²Ð°Ñˆ Ð’ÐÐ•Ð¨ÐÐ˜Ð™ (Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹) IPv4-Ð°Ð´Ñ€ÐµÑ!${NC}"
echo -e "   Ð­Ñ‚Ð¾ ÐÐ• Ð°Ð´Ñ€ÐµÑ Ð²Ð¸Ð´Ð° 192.168.x.x, 10.x.x.x Ð¸Ð»Ð¸ IP Ð²Ð°ÑˆÐµÐ³Ð¾ VPS."
echo
echo -e "   Ð£Ð·Ð½Ð°Ð¹Ñ‚Ðµ ÑÐ²Ð¾Ð¹ Ð²Ð½ÐµÑˆÐ½Ð¸Ð¹ IP Ð½Ð° Ð¾Ð´Ð½Ð¾Ð¼ Ð¸Ð· ÑÐ°Ð¹Ñ‚Ð¾Ð²:"
echo -e "     â€¢ https://myip.ru/"
echo -e "     â€¢ https://2ip.ru/"
echo -e "     â€¢ https://www.dnsleaktest.com/"
echo
read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð²Ð°Ñˆ Ð²Ð½ÐµÑˆÐ½Ð¸Ð¹ IP-Ð°Ð´Ñ€ÐµÑ: " USER_IP
if [[ ! "$USER_IP" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
    echo -e "${RED}âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ IP-Ð°Ð´Ñ€ÐµÑÐ°.${NC}"
    exit 1
fi
IFS='.' read -r a b c d <<< "$USER_IP"
if (( a > 255 || b > 255 || c > 255 || d > 255 )); then
    echo -e "${RED}âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ IP-Ð°Ð´Ñ€ÐµÑ (Ñ‡Ð¸ÑÐ»Ð° Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ â‰¤ 255).${NC}"
    exit 1
fi
if [[ "$USER_IP" =~ ^(192\.168|10\.|172\.(1[6-9]|2[0-9]|3[01])) ]]; then
    echo -e "${RED}âš ï¸  Ð’Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ: Ð²Ñ‹ Ð²Ð²ÐµÐ»Ð¸ Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ð¹ IP!${NC}"
    echo -e "${RED}   Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð²Ð½ÐµÑˆÐ½Ð¸Ð¹ IP Ñ myip.ru.${NC}"
    exit 1
fi
if ! command -v fail2ban-client &> /dev/null; then
    echo -e "${GREEN}Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° fail2ban Ð´Ð»Ñ Ð·Ð°Ñ‰Ð¸Ñ‚Ñ‹ Ð¾Ñ‚ Ð±Ñ€ÑƒÑ‚Ñ„Ð¾Ñ€ÑÐ°...${NC}"
    apt install -y fail2ban
    systemctl enable --now fail2ban
fi
if ufw status | grep -q "ALLOW IN.*$USER_IP.*22"; then
    echo -e "${GREEN}âœ… ÐŸÑ€Ð°Ð²Ð¸Ð»Ð¾ Ð´Ð»Ñ $USER_IP ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚.${NC}"
else
    ufw allow from "$USER_IP" to any port 22
    echo -e "${GREEN}âœ… Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ð¿Ð¾ SSH Ñ€Ð°Ð·Ñ€ÐµÑˆÑ‘Ð½ Ñ $USER_IP.${NC}"
fi
echo -e "${YELLOW}ðŸ’¡ fail2ban Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½: Ð·Ð°Ñ‰Ð¸Ñ‰Ð°ÐµÑ‚ Ð¾Ñ‚ Ð±Ñ€ÑƒÑ‚Ñ„Ð¾Ñ€ÑÐ° Ð¿Ð¾ SSH.${NC}"
EOF
chmod +x /usr/local/bin/openssh

# help
cat > $HOME/help <<'EOF'
Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:
  mainuser    â€” Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑÑ‹Ð»ÐºÑƒ Ð¸ QR Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  listuser    â€” ÑÐ¿Ð¸ÑÐ¾Ðº Ð²ÑÐµÑ… ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð²
  adduser     â€” ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  rmuser      â€” ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  sharelink   â€” Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÑÑ‹Ð»ÐºÑƒ Ð¿Ð¾ Ð½Ð¾Ð¼ÐµÑ€Ñƒ
  update      â€” Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ´Ñ€Ð¾
  openssh     â€” Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒ SSH Ð´Ð»Ñ Ð²Ð°ÑˆÐµÐ³Ð¾ IP Ð¸ Ð²ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð·Ð°Ñ‰Ð¸Ñ‚Ñƒ Ð¾Ñ‚ Ð±Ñ€ÑƒÑ‚Ñ„Ð¾Ñ€ÑÐ° (ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ fail2ban)
EOF

# Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð²Ñ‹Ð²Ð¾Ð´
clear
echo -e "${GREEN}âœ… Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° sing-box (REALITY + Vision) Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!${NC}"
UUID=$(awk -F': ' '/uuid/ {print $2}' /usr/local/etc/sing-box/.keys)
PBK=$(awk -F': ' '/public key/ {print $2}' /usr/local/etc/sing-box/.keys)
SID=$(awk -F': ' '/shortsid/ {print $2}' /usr/local/etc/sing-box/.keys)
IP=$(curl -4 -s icanhazip.com)
if [[ -n "$IP" ]]; then
    LINK="vless://$UUID@$IP:443?security=reality&sni=www.cloudflare.com&fp=firefox&pbk=$PBK&sid=$SID&spx=/&type=tcp&flow=xtls-rprx-vision&encryption=none#main"
    echo "Ð¡ÑÑ‹Ð»ÐºÐ° Ð´Ð»Ñ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ:"
    echo
    echo "$LINK"
    echo
    echo "QR-ÐºÐ¾Ð´:"
    echo "$LINK" | qrencode -t ansiutf8
fi
echo
echo -e "${GREEN} Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ cat help Ð´Ð»Ñ ÑÐ¿Ð¸ÑÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´${NC}"
echo -e "${YELLOW}ðŸ”’ ÐŸÐ¾Ñ€Ñ‚ 22 (SSH) Ð·Ð°ÐºÑ€Ñ‹Ñ‚ Ñ„Ð°ÐµÑ€Ð²Ð¾Ð»Ð¾Ð¼. Ð§Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿, Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ:${NC}"
echo -e "${GREEN}       openssh${NC}"
echo -e "${YELLOW}   Ð¸ ÑƒÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð²Ð°Ñˆ Ð²Ð½ÐµÑˆÐ½Ð¸Ð¹ IP (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ñ myip.ru).${NC}"
echo -e "${YELLOW}ðŸ’¡ Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ Â«Use Remote DNSÂ» Ð² ÐºÐ»Ð¸ÐµÐ½Ñ‚Ðµ (Hiddify) Ð¸ Ñ€ÐµÐ¶Ð¸Ð¼ VPN!${NC}"
